# v2.2.2 - 高复杂度 PRD

> **版本**：v2.2.2  
> **日期**：2026-01-20  
> **状态**：待开发  
> **前置**：[v2.2.1 中复杂度](./2.2.1-中复杂度.md)  
> **核心架构**：[任务处理模块-核心架构](./2.2-任务处理模块-核心架构.md)

---

## 一、版本目标

> 支持高复杂度任务，实现智能确认和子任务管理

**交付功能**：
- ✅ 高复杂度任务（邮件整理）
- ✅ 智能确认分组
- ✅ 子任务拆分
- ✅ 部分结果汇报
- ✅ 进度查询

**预估工时**：4-5 天

---

## 二、智能确认分组

### 2.1 分组规则

| 问题类型 | 策略 |
|----------|------|
| 简单选择题（2-3选项） | 合并 2-3 个 |
| 开放性问题 | 单独问 |
| 依赖性问题 | 等答案后再问 |

### 2.2 配置

```yaml
confirmation:
  grouping:
    strategy: smart
    max_per_round: 2
  questions:
    - text: "整理哪个时间范围？"
      param: time_range
      type: simple_choice
    - text: "有重点部门吗？"
      param: department
      type: simple_choice
```

---

## 三、用户场景

### 3.1 邮件整理（智能确认）

```
用户 → "帮我整理邮件"
       ↓
AI   → "好的，整理哪个时间范围？今天、本周还是全部？
       有重点关注的部门吗？"
       ↓
[合并两个简单选择题]
       ↓
用户 → "今天的，产品部门优先"
       ↓
AI   → "收到，帮你整理今天的邮件，产品部门优先，好了叫你～"
```

### 3.2 子任务拆分与部分汇报

```
[后台：按部门拆分子任务]
- 产品部门（优先）
- 市场部门
- 技术部门

[产品部门先完成]
AI → "产品部门的邮件整理好了，一共5封重要的：
      1. xxx...
      2. xxx...
      要先看这些，还是等全部完成？"
      [展示部分结果卡片]
```

### 3.3 进度查询

```
用户 → "邮件整理得怎么样了？"
       ↓
AI   → "已整理40%，产品部门和市场部门完成了，还剩技术部门～"
       ↓
用户 → "还差哪些？"
       ↓
AI   → "技术部门的邮件还在处理，大概还有30封"
```

### 3.4 追问子任务结果

```
用户 → "先说说产品部门的"
       ↓
AI   → "产品部门今天5封重要邮件：
       1. 需求评审会议通知...
       2. 版本发布确认..."
```

---

## 四、技术设计

### 4.1 子任务结构

```typescript
interface SubTask {
  id: string;
  name: string;
  status: 'pending' | 'running' | 'completed' | 'failed';
  progress: number;
  result?: any;
}

interface TaskSession {
  // ... 现有字段
  subtasks?: SubTask[];
  completedSubtasks: number;
  totalSubtasks: number;
}
```

### 4.2 任务配置

```yaml
# config/tasks/email_summary.yaml
task:
  id: email_summary
  name: 邮件整理
  version: "1.0"
  
  trigger:
    type: keyword
    keywords: ["邮件", "收件箱", "邮件整理"]
  
  complexity: high
  
  preference:
    enabled: true
    fields: ["time_range", "department"]
  
  confirmation:
    grouping:
      strategy: smart
      max_per_round: 2
    questions:
      - text: "整理哪个时间范围？今天、本周还是全部？"
        param: time_range
        type: simple_choice
        default: "今天"
      - text: "有重点关注的部门吗？"
        param: department
        type: simple_choice
        required: false
  
  subtasks:
    enabled: true
    split_strategy: "按部门"
    partial_report: true
  
  progress_template: "已整理{{progress}}%，{{completed}}个部门完成"
  
  broadcaster:
    style: neutral
    emotion: calm
  
  timeout:
    duration: 120s
    notify: true
```

---

## 五、后端需求

### 5.1 新增模块

| 模块 | 说明 |
|------|------|
| `ConfirmationManager` | 智能确认分组 |
| `SubTaskManager` | 子任务管理 |
| `EmailExecutor` | 邮件整理执行器 |
| `ProgressTracker` | 进度追踪 |

---

## 六、验收标准

| 场景 | 验收标准 |
|------|----------|
| 智能确认 | 简单问题合并，复杂问题分开 |
| 子任务拆分 | 按配置策略正确拆分 |
| 部分汇报 | 子任务完成即可汇报 |
| 进度查询 | 正确返回百分比和描述 |
| 追问子任务 | 正确返回指定子任务结果 |

---

## 七、后续版本

完成后可并行开发：
- [v2.2.3 - 多任务](./2.2.3-多任务.md)
- [v2.2.4 - 异常处理](./2.2.4-异常处理.md)
