# Serverless 部署方案 (Vercel + MongoDB)

基于对项目长期维护和扩展性的考虑，我们采用 **Vercel (Serverless)** 配合 **MongoDB (Database)** 的全云端架构。

## 1. 架构变更

| 模块 | 原有方式 (Stateful) | 新架构 (Stateless) | 说明 |
| :--- | :--- | :--- | :--- |
| **托管平台** | 本地/VPS | **Vercel** | 享受全球 CDN 和自动扩缩容 |
| **记忆存储** | 本地 JSON 文件 (`fs`) | **MongoDB Atlas** | 所有的 `UserMemory` 存入 `users` 集合 |
| **游戏状态** | 内存变量 (`Map`) | **MongoDB Atlas** | 所有的 `GameSession` 存入 `sessions` 集合 |
| **实时通信** | Next.js API | **Next.js API** | 保持不变，HTTP 请求处理逻辑相同 |

## 2. 准备工作

### 2.1 注册 MongoDB Cloud (Atlas)
1.  访问 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas/register) 注册免费账号。
2.  创建一个 **M0 (Free)** 集群。
3.  在 `Network Access` 中添加允许访问的 IP（测试阶段可设为 `0.0.0.0/0`）。
4.  在 `Database Access` 创建一个数据库用户（记下用户名和密码）。
5.  获取 **Connection String** (例如: `mongodb+srv://user:pass@cluster0.mongodb.net/...`).

### 2.2 环境变量
在项目根目录 `.env.local` 和 Vercel 后台设置：
```bash
MONGODB_URI=your_connection_string_here
```

## 3. 代码改造计划 (预计 2-3 天)

### 第一阶段：基础设施
-   [ ] 安装 `mongoose` 库。
-   [ ] 创建 `lib/db/client.ts`: 处理 MongoDB 连接复用 (因为 Serverless 环境连接池需要特殊处理)。
-   [ ] 创建数据模型 Schema:
    -   `UserModel`: 对应原 `MemoryManager` 数据。
    -   `SessionModel`: 对应原 `GameSessionManager` 数据。

### 第二阶段：核心重构
-   [ ] **重写 MemoryManager**:
    -   删除所有 `fs.readFileSync` / `writeFileSync`。
    -   改为 `await UserModel.findOne(...)`。
-   [ ] **重写 GameSessionManager**:
    -   删除 `private sessions = new Map()`。
    -   改为查库逻辑 `await SessionModel.findOne({ roomId })`。
    -   **关键点**: 所有调用 `getSession` 的地方都必须改为 `await` 异步调用。

### 第三阶段：调用点适配
-   [ ] 修改 `TurtleSoupController`: 将同步的游戏逻辑改为异步，等待数据库读写。
-   [ ] 修改 `ActionDispatcher`: 确保任务分发前已从数据库加载最新状态。

## 4. 部署流程 (双项目部署)

由于本项目采用前后端分离架构（Next.js 后端 + Vite 前端），我们需要在 Vercel 上创建**两个**独立的项目。

### 4.1 部署后端 (Server Project)
这是核心服务，必须先部署它以获取 API 地址。

1.  **新建项目**: 在 Vercel Dashboard 点击 **"Add New..."** -> **"Project"**。
2.  **导入仓库**: 选择 `IdealAICompanion` 仓库并点击 Import。
3.  **配置构建 (Build Settings)**:
    -   **Framework Preset**: 选择 `Next.js`。
    -   **Root Directory**: 点击 Edit，选择 `Source/server` 目录。
4.  **配置环境变量 (Environment Variables)**:
    -   `MONGODB_URI`: 填入您的 MongoDB Atlas 连接串 (如 `mongodb+srv://...`)。
5.  **点击 Deploy**: 等待部署完成。
6.  **获取域名**: 部署成功后，复制分配的域名（例如 `https://ideal-server.vercel.app`）。

### 4.2 部署前端 (Web Project)
这是用户访问的界面，需要连接到刚才部署的后端。

1.  **新建项目**: 再次点击 **"Add New..."** -> **"Project"**。
2.  **导入仓库**: 再次选择同一个 `IdealAICompanion` 仓库。
3.  **配置构建 (Build Settings)**:
    -   **Framework Preset**: 选择 `Vite`。
    -   **Root Directory**: 点击 Edit，选择 `Source/web` 目录。
4.  **配置环境变量 (Environment Variables)**:
    -   `VITE_API_BASE_URL`: 填入**步骤 4.1 获取的后端域名** (必须带 `https://`，例如 `https://ideal-server.vercel.app`)。
5.  **点击 Deploy**: 等待部署完成。

### 4.3 验证与测试
1.  访问前端项目的域名。
2.  打开浏览器的开发者工具 (Network 面板)。
3.  尝试登录或开始游戏，观察 API 请求是否正确指向了后端域名（而不是 localhost）。
4.  如果遇到 CORS 错误（跨域问题），请确保后端 `next.config.ts` 中的 `Access-Control-Allow-Origin` 包含了前端的域名（通常 Next.js 默认配置在 Vercel 同账号下较为宽松，如有问题需手动添加 headers）。

---

> [!IMPORTANT]
> **开发停摆预警**
> 在重构完成前，所有新功能（如 2.2 版本的意图识别、多任务）开发将暂停。我们将优先保证项目能跑通“无状态化”流程。
