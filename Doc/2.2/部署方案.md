# Serverless 部署方案 (Vercel + MongoDB)

基于对项目长期维护和扩展性的考虑，我们采用 **Vercel (Serverless)** 配合 **MongoDB (Database)** 的全云端架构。

## 1. 架构变更

| 模块 | 原有方式 (Stateful) | 新架构 (Stateless) | 说明 |
| :--- | :--- | :--- | :--- |
| **托管平台** | 本地/VPS | **Vercel** | 享受全球 CDN 和自动扩缩容 |
| **记忆存储** | 本地 JSON 文件 (`fs`) | **MongoDB Atlas** | 所有的 `UserMemory` 存入 `users` 集合 |
| **游戏状态** | 内存变量 (`Map`) | **MongoDB Atlas** | 所有的 `GameSession` 存入 `sessions` 集合 |
| **实时通信** | Next.js API | **Next.js API** | 保持不变，HTTP 请求处理逻辑相同 |

## 2. 准备工作

### 2.1 注册 MongoDB Cloud (Atlas)
1.  访问 [MongoDB Atlas](https://www.mongodb.com/cloud/atlas/register) 注册免费账号。
2.  创建一个 **M0 (Free)** 集群。
3.  在 `Network Access` 中添加允许访问的 IP（测试阶段可设为 `0.0.0.0/0`）。
4.  在 `Database Access` 创建一个数据库用户（记下用户名和密码）。
5.  获取 **Connection String** (例如: `mongodb+srv://user:pass@cluster0.mongodb.net/...`).

### 2.2 环境变量
在项目根目录 `.env.local` 和 Vercel 后台设置：
```bash
MONGODB_URI=your_connection_string_here
```

## 3. 代码改造计划 (预计 2-3 天)

### 第一阶段：基础设施
-   [ ] 安装 `mongoose` 库。
-   [ ] 创建 `lib/db/client.ts`: 处理 MongoDB 连接复用 (因为 Serverless 环境连接池需要特殊处理)。
-   [ ] 创建数据模型 Schema:
    -   `UserModel`: 对应原 `MemoryManager` 数据。
    -   `SessionModel`: 对应原 `GameSessionManager` 数据。

### 第二阶段：核心重构
-   [ ] **重写 MemoryManager**:
    -   删除所有 `fs.readFileSync` / `writeFileSync`。
    -   改为 `await UserModel.findOne(...)`。
-   [ ] **重写 GameSessionManager**:
    -   删除 `private sessions = new Map()`。
    -   改为查库逻辑 `await SessionModel.findOne({ roomId })`。
    -   **关键点**: 所有调用 `getSession` 的地方都必须改为 `await` 异步调用。

### 第三阶段：调用点适配
-   [ ] 修改 `TurtleSoupController`: 将同步的游戏逻辑改为异步，等待数据库读写。
-   [ ] 修改 `ActionDispatcher`: 确保任务分发前已从数据库加载最新状态。

## 4. 部署流程

1.  **提交代码**: 将重构后的代码推送到 GitHub。
2.  **Vercel 导入**:
    -   登录 Vercel -> Add New Project -> Import GitHub Repository。
    -   Framework Preset 选 `Next.js`。
3.  **配置环境**: 在 Vercel Settings -> Environment Variables 填入 `MONGODB_URI` 等配置。
4.  **自动部署**: 点击 Deploy，等待构建完成。

---

> [!IMPORTANT]
> **开发停摆预警**
> 在重构完成前，所有新功能（如 2.2 版本的意图识别、多任务）开发将暂停。我们将优先保证项目能跑通“无状态化”流程。
