# v2.2.0 - MVP 版本 PRD

> **版本**：v2.2.0  
> **日期**：2026-01-20  
> **状态**：待开发  
> **核心架构**：[任务处理模块-核心架构](./2.2-任务处理模块-核心架构.md)

---

## 一、版本目标

> 跑通基础链路，验证核心设计

**交付功能**：
- ✅ 关键词触发检测
- ✅ 复杂度分级框架
- ✅ 低复杂度任务（天气查询）
- ✅ 基础配置模板
- ✅ 天气结果卡片
- ✅ 2s 响应保障

**预估工时**：3-5 天

---

## 二、核心约束

### 2.1 响应时效

用户说完话后 **2 秒内**必须听到响应。

### 2.2 闲聊不受影响

```
用户输入 → 关键词检测(~50ms) → 无命中 → 直接闲聊 LLM
                                         ↑
                                    零额外延迟
```

---

## 三、用户场景

### 3.1 闲聊（不受影响）

```
用户 → "心情不太好"
       ↓
[关键词无命中]
       ↓
AI   → "怎么啦，发生什么事了？"
```

### 3.2 天气查询

```
用户 → "今天天气怎么样"
       ↓
[关键词命中：天气]
[复杂度：低 → 直接执行]
[从用户记忆获取常驻地：北京]
       ↓
AI   → "北京今天晴转多云，气温3-12度，有点凉哦，记得穿厚一点～"
       [展示天气卡片]
       ↓
用户 → "好的"
       ↓
[关闭卡片]
```

### 3.3 指定地点

```
用户 → "上海天气怎么样"
       ↓
AI   → "上海今天多云，气温8-15度～"
```

---

## 四、技术设计

### 4.1 链路流程

```
用户输入
    │
    ▼
┌──────────────────────────────────────┐
│ 关键词检测（~50ms）                    │
│ - 检查是否包含：天气|温度|穿什么        │
└──────────────────────────────────────┘
    │
    ├─ 无命中 → 闲聊 LLM
    │
    └─ 命中 → 任务流程
                │
                ▼
        ┌──────────────────┐
        │ 复杂度判定        │
        │ 天气 = 低复杂度   │
        └──────────────────┘
                │
                ▼
        ┌──────────────────┐
        │ 参数提取          │
        │ 地点（从输入或记忆）│
        └──────────────────┘
                │
                ▼
        ┌──────────────────┐
        │ 执行天气查询      │
        │ 百炼联网插件      │
        └──────────────────┘
                │
                ▼
        ┌──────────────────┐
        │ 结果播报          │
        │ 人设化语气        │
        │ + 天气卡片        │
        └──────────────────┘
```

### 4.2 任务配置

```yaml
# config/tasks/weather.yaml
task:
  id: weather
  name: 天气查询
  version: "1.0"
  
  trigger:
    type: keyword
    keywords: ["天气", "温度", "穿什么", "热不热", "冷不冷", "会下雨"]
  
  complexity: low
  
  params:
    - name: location
      source: input | memory  # 优先从输入提取，无则用记忆
      default_memory_key: "user_location"
  
  executor:
    type: builtin
    handler: weather
  
  broadcaster:
    style: persona
    emotion: happy
    rules:
      - "必须告知查询地点"
      - "加入人设化关心语"
  
  timeout:
    duration: 5s
```

---

## 五、UX 说明

> 本章节描述天气卡片的交互设计，作为前端开发的核心参考

### 5.1 页面布局

```
┌─────────────────────────────────────┐
│  ← 返回      ● 已连接    [···]    │  ← CallHeader
├─────────────────────────────────────┤
│                                     │
│         ╭───────────────────╮       │
│         │   💭 字幕区域     │       │
│         ╰───────────────────╯       │
│                                     │
│    ╔═══════════════════════════╗    │  ← 天气卡片 (浮层)
│    ║  ☀️  北京               ║    │
│    ║      3 - 12 °C           ║    │
│    ║      晴转多云            ║    │
│    ╠═══════════════════════════╣    │
│    ║  👔 穿衣建议：厚外套      ║    │
│    ╚═══════════════════════════╝    │
│                                     │
│                                     │
├─────────────────────────────────────┤
│        🎤 (麦克风)    📞 (挂断)     │  ← CallControls
└─────────────────────────────────────┘
```

**布局说明**：
| 区域 | 组件 | 层级 |
|------|------|------|
| 顶部 | `CallHeader` | 基础层 |
| 中部 | `SubtitleDisplay` | 基础层 |
| 浮层 | `WeatherCard` (新增) | 浮层，居中偏下 |
| 底部 | `CallControls` | 基础层 |

---

### 5.2 交互流程

#### Step 1: 卡片弹出

```
用户: "今天天气怎么样"
         │
         ▼
┌─────────────────────────────────────┐
│  ← 返回      ● 已连接    [···]    │
├─────────────────────────────────────┤
│                                     │
│         ╭───────────────────╮       │
│         │ "北京今天晴转..." │       │ ← 语音播报 + 字幕同步
│         ╰───────────────────╯       │
│                                     │
│                 ↓ 动画              │
│    ╔═══════════════════════════╗    │
│    ║  ☀️  北京               ║    │ ← 从底部滑入
│    ║      3 - 12 °C           ║    │   duration: 300ms
│    ║      ...                 ║    │   easing: ease-out
│    ╚═══════════════════════════╝    │
│                                     │
├─────────────────────────────────────┤
│        🎤         📞              │
└─────────────────────────────────────┘
```

**弹出时机**：天气数据返回后，与 AI 语音播报**同步出现**

---

#### Step 2: 卡片展示

```
┌─────────────────────────────────────┐
│  ← 返回      ● 已连接    [···]    │
├─────────────────────────────────────┤
│                                     │
│    ╔═══════════════════════════╗    │
│    ║  ☀️  北京         [30s]  ║    │ ← 右上角倒计时 (可选)
│    ║      3 - 12 °C           ║    │
│    ║      晴转多云            ║    │
│    ╠═══════════════════════════╣    │
│    ║  👔 穿衣建议：厚外套      ║    │
│    ║  💨 空气质量：良         ║    │ ← 可扩展字段
│    ╚═══════════════════════════╝    │
│                                     │
│    ※ 说"好的"或"知道了"关闭卡片    │ ← 底部提示文案
│                                     │
├─────────────────────────────────────┤
│        🎤         📞              │
└─────────────────────────────────────┘
```

**展示规则**：
- 卡片保持显示，不遮挡麦克风/挂断按钮
- 倒计时可选显示（降低用户焦虑）
- 底部提示引导用户如何关闭

---

#### Step 3: 卡片关闭

**关闭触发条件**：

| 条件 | 用户输入示例 |
|------|--------------|
| 语音确认 | "好的"、"知道了"、"收到" |
| 超时自动 | 30 秒无操作 |
| 新任务冲刷 | 用户开启新话题 |

```
用户: "好的"
         │
         ▼
┌─────────────────────────────────────┐
│                                     │
│    ╔═══════════════════════════╗    │
│    ║                           ║    │ ← 向下滑出
│    ╚═══════════════════════════╝    │   duration: 200ms
│                 ↓                   │   easing: ease-in
│                                     │
│                                     │
└─────────────────────────────────────┘
         │
         ▼
     (恢复常规界面)
```

---

### 5.3 错误状态

> 错误卡片作为语音播报的**视觉补充**，展示核心原因和建议方案

```
┌─────────────────────────────────────┐
│    ╔═══════════════════════════╗    │
│    ║  ⚠️  天气查询失败        ║    │ ← 错误标识
│    ╠═══════════════════════════╣    │
│    ║  📍 原因：地点无法识别    ║    │ ← 核心原因
│    ║                           ║    │
│    ║  💡 建议：                ║    │ ← 建议方案
│    ║     · 说出具体城市名      ║    │
│    ║     · 如"北京天气"       ║    │
│    ╚═══════════════════════════╝    │
└─────────────────────────────────────┘
```

**错误类型与展示**：

| 错误类型 | 原因文案 | 建议方案 | 语音播报 |
|----------|----------|----------|----------|
| 地点无法识别 | 地点无法识别 | 说出具体城市名 | "抱歉没听清地点，你说的是哪个城市？" |
| API 超时 | 网络响应超时 | 稍后再试 | "网络不太好，晚点再帮你查～" |
| 服务不可用 | 天气服务暂时不可用 | 稍后再试 | "天气服务出了点问题，晚点再试试～" |

**错误卡片规则**：
- 5 秒后自动消失（或用户说话后消失）
- 配色使用 `warning` 主题（橙色边框）

---

## 六、前端需求

### 6.1 天气卡片

```
┌──────────────────────────────┐
│  ☀️  北京                     │
│      3 - 12 °C               │
│      晴转多云                  │
├──────────────────────────────┤
│  👔 穿衣建议：厚外套           │
└──────────────────────────────┘
```

- **触发**：天气查询完成后展示
- **关闭**：用户说"好的/知道了"，或 30s 超时

---

## 七、后端需求

### 7.1 新增 API

| API | 方法 | 说明 |
|-----|------|------|
| `/api/task/dispatch` | POST | 任务调度入口 |

### 7.2 新增模块

| 模块 | 说明 |
|------|------|
| `TaskMatcher` | 关键词匹配，判断是否任务 |
| `TaskDispatcher` | 任务调度器 |
| `WeatherExecutor` | 天气查询执行器 |

### 7.3 配置目录

```
config/tasks/
└── weather.yaml
```

---

## 八、验收标准

| 场景 | 验收标准 |
|------|----------|
| 闲聊 | 不受任务系统影响，无延迟增加 |
| 天气查询 | 2s 内返回结果 |
| 默认地点 | 使用用户记忆中的常驻地 |
| 指定地点 | 正确识别并查询指定地点 |
| 卡片展示 | 天气卡片正确显示 |
| 卡片关闭 | 用户确认后关闭 |

---

## 九、后续版本

完成后进入 [v2.2.1 - 中复杂度](./2.2.1-中复杂度.md)
