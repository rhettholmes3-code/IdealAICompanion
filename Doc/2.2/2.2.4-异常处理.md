# v2.2.4 - 异常处理 PRD

> **版本**：v2.2.4  
> **日期**：2026-01-20  
> **状态**：待开发  
> **前置**：[v2.2.2 高复杂度](./2.2.2-高复杂度.md)  
> **核心架构**：[任务处理模块-核心架构](./2.2-任务处理模块-核心架构.md)

---

## 一、版本目标

> 完善边界情况处理，提升用户体验

**交付功能**：
- ✅ 确认中途被打断
- ✅ 结果调整/重做
- ✅ ASR 纠正理解
- ✅ 通话中断处理
- ✅ 超时处理

**预估工时**：3-4 天

---

## 二、用户场景

### 2.1 确认中途被打断

```
AI   → "整理哪个时间范围？"
用户 → "对了，今天天气怎么样？"
       ↓
[暂存确认上下文]
AI   → "北京今天晴～ 刚才说邮件，你要整理哪个时间范围？"
[自动回到确认]
```

**处理规则**：
| 插入请求 | 处理 |
|----------|------|
| 低复杂度任务 | 快速处理后回到确认 |
| 闲聊 | 简短回应后回到确认 |
| 高复杂度任务 | 询问"先处理哪个" |
| 用户说"算了" | 取消当前确认 |

### 2.2 结果调整/重做

```
AI   → "产品部门5封邮件..."
用户 → "不对，我要的是市场部门的"
       ↓
AI   → "抱歉弄错了，重新整理市场部门的～"
```

```
AI   → "今天3个热点..."
用户 → "太简单了，详细一点"
       ↓
AI   → "好的，详细说一下。第一条..."
```

**支持的调整**：
| 用户反馈 | 处理 |
|----------|------|
| "不对，我要xx" | 修正参数重做 |
| "太简单/详细一点" | 调整格式 |
| "重新查" | 重新执行 |
| "换一个" | 重新获取 |

### 2.3 ASR 纠正

```
用户 → "北京天气"
ASR  → "背景天气"
AI   → "背景的天气..."
用户 → "不是背景，是北京"
       ↓
AI   → "哦北京，北京今天晴～"
```

**识别规则**：
- "不是xx，是yy" → 参数纠正
- "我说的是xx" → 重新理解
- 直接重复正确的 → 覆盖

### 2.4 通话中断

```
[任务执行中]
[用户断开]
       ↓
[任务继续，结果保留24h]
       ↓
[用户重连]
AI   → "刚才帮你整理的邮件已经好了，要听一下吗？"
```

### 2.5 超时处理

```
[任务超过预估时间]
AI   → "旅游攻略内容比较多，还在整理，大概还需一分钟～"
       ↓
用户 → "好的" / "算了太久了"
```

---

## 三、技术设计

### 3.1 确认上下文暂存

```typescript
interface ConfirmationContext {
  taskId: string;
  questionIndex: number;
  collectedParams: Record<string, any>;
  pausedAt: number;
}
```

### 3.2 结果调整配置

```yaml
result_adjustment:
  format_modes: [brief, normal, detailed]
  default: normal
  retry_enabled: true
  param_correction: true
```

### 3.3 中断恢复

```
data/tasks/
├── {roomId}_interrupted.json  # 中断时的任务快照
```

---

## 四、后端需求

### 4.1 新增模块

| 模块 | 说明 |
|------|------|
| `ContextStack` | 确认上下文栈 |
| `ResultAdjuster` | 结果调整处理 |
| `ASRCorrector` | ASR 纠正理解 |
| `InterruptRecovery` | 中断恢复 |

---

## 五、验收标准

| 场景 | 验收标准 |
|------|----------|
| 确认被打断 | 处理后自动回到确认 |
| 参数错误 | 理解纠正意图 |
| 格式调整 | 正确调整输出 |
| ASR 纠正 | 理解"不是xx是yy" |
| 通话中断 | 结果保留，重连提示 |
| 超时 | 主动通知用户 |

---

## 六、后续版本

完成后进入 [v2.2.5 - 插件化](./2.2.5-插件化.md)
