# v2.2.1 - 中复杂度 PRD

> **版本**：v2.2.1  
> **日期**：2026-01-20  
> **状态**：待开发  
> **前置**：[v2.2.0 MVP](./2.2.0-MVP.md)  
> **核心架构**：[任务处理模块-核心架构](./2.2-任务处理模块-核心架构.md)

---

## 一、版本目标

> 支持中复杂度任务，验证偏好记忆和异步执行

**交付功能**：
- ✅ 中复杂度任务（新闻整理）
- ✅ 用户偏好记忆
- ✅ 安抚语机制
- ✅ 后台异步执行（执行中可闲聊）
- ✅ 新闻结果卡片

**预估工时**：3-4 天

---

## 二、用户场景

### 2.1 首次请求（无偏好）

```
用户 → "帮我看看今天的热点"
       ↓
[关键词命中：热点]
[复杂度：中]
[检查偏好：无]
       ↓
AI   → "有特别关注的类别吗？科技、财经、娱乐，还是都看看？"
       ↓
用户 → "科技"
       ↓
[记忆偏好：新闻类别=科技]
AI   → "好的，整理科技热点中～"
       ↓
[后台异步执行，用户可闲聊]
       ↓
[3-5s 后完成]
AI   → "整理好了！今天科技圈有3个热点：
       第一，xxx...
       第二，xxx...
       第三，xxx...
       你想详细了解哪一条？"
       [展示新闻卡片]
```

### 2.2 再次请求（有偏好）

```
用户 → "帮我看看热点"
       ↓
[检查偏好：新闻类别=科技]
       ↓
AI   → "还是看科技类的吗？"
       ↓
用户 → "嗯"
       ↓
AI   → "好的，整理中～"
```

### 2.3 覆盖偏好

```
用户 → "帮我看看财经新闻"
       ↓
[显式指定类别，覆盖偏好]
AI   → "好的，整理财经热点中～"
[更新偏好：新闻类别=财经]
```

### 2.4 执行中闲聊

```
AI   → "整理中～"
       ↓
[任务执行中]
用户 → "最近有什么好看的电影吗？"
       ↓
AI   → "最近《xxx》口碑不错呢..."
       ↓
[任务完成]
AI   → "新闻整理好了！..."
```

### 2.5 追问详情

```
AI   → "...第二，AI技术突破..."
       ↓
用户 → "第二条详细说说"
       ↓
AI   → "关于AI技术突破，事情是这样的..."
```

---

## 三、技术设计

### 3.1 偏好记忆

```typescript
// 偏好存储结构
interface TaskPreference {
  userId: string;
  taskId: string;
  preferences: {
    [paramName: string]: string;
  };
  updatedAt: number;
}
```

存储位置：`data/preferences/{userId}.json`

### 3.2 安抚语机制

```
[检测到中/高复杂度任务]
         ↓
AI 立即回复安抚语（<500ms）
         ↓
后台启动异步执行
         ↓
用户可继续对话
         ↓
任务完成后主动播报
```

### 3.3 任务配置

```yaml
# config/tasks/news_hot.yaml
task:
  id: news_hot
  name: 热点新闻整理
  version: "1.0"
  
  trigger:
    type: keyword
    keywords: ["热点", "新闻", "今日头条", "发生了什么"]
  
  complexity: medium
  
  preference:
    enabled: true
    fields: ["category"]
  
  confirmation:
    enabled: true
    questions:
      - text: "有特别关注的类别吗？科技、财经、娱乐，还是都看看？"
        param: category
        type: simple_choice
        default: "综合"
        skip_if_preference: true  # 有偏好时询问确认而非直接问
  
  executor:
    type: builtin
    handler: news
  
  broadcaster:
    style: neutral
    emotion: calm
  
  timeout:
    duration: 10s
```

---

## 四、前端需求

### 4.1 新闻卡片

```
┌──────────────────────────────┐
│  📰 今日热点 (科技)           │
├──────────────────────────────┤
│  1. AI技术再突破...          │
│  2. 新款芯片发布...          │
│  3. 科技公司财报...          │
├──────────────────────────────┤
│  💬 说"第几条"了解详情        │
└──────────────────────────────┘
```

---

## 五、后端需求

### 5.1 新增模块

| 模块 | 说明 |
|------|------|
| `PreferenceManager` | 偏好记忆管理 |
| `NewsExecutor` | 新闻整理执行器 |
| `AsyncTaskRunner` | 异步任务执行器 |

### 5.2 新增配置

```
config/tasks/
├── weather.yaml
└── news_hot.yaml
```

---

## 六、验收标准

| 场景 | 验收标准 |
|------|----------|
| 首次请求 | 询问类别偏好 |
| 再次请求 | 使用/确认历史偏好 |
| 覆盖偏好 | 显式指定时更新偏好 |
| 安抚语 | 2s 内返回安抚语 |
| 异步执行 | 执行中可正常闲聊 |
| 结果播报 | 任务完成后主动播报 |
| 追问详情 | 理解"第几条"指代 |

---

## 七、后续版本

完成后进入 [v2.2.2 - 高复杂度](./2.2.2-高复杂度.md)
