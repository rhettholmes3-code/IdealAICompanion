# v2.2.5 - 插件化 PRD

> **版本**：v2.2.5  
> **日期**：2026-01-20  
> **状态**：待开发  
> **前置**：v2.2.3 + v2.2.4  
> **核心架构**：[任务处理模块-核心架构](./2.2-任务处理模块-核心架构.md)

---

## 一、版本目标

> 完善插件架构，提升可扩展性和可观测性

**交付功能**：
- ✅ 执行器插件化
- ✅ 播报器插件化
- ✅ 配置热加载
- ✅ 链路日志
- ✅ 监控告警

**预估工时**：3-4 天

---

## 二、插件架构

### 2.1 插件类型

| 插件 | 说明 | 接口 |
|------|------|------|
| **触发器** | 判断是否触发任务 | `Trigger` |
| **执行器** | 执行任务逻辑 | `Executor` |
| **播报器** | 结果转语音 | `Broadcaster` |

### 2.2 插件接口

```typescript
// 执行器接口
interface Executor {
  id: string;
  execute(params: Record<string, any>): Promise<ExecuteResult>;
}

// 播报器接口
interface Broadcaster {
  id: string;
  format(result: any, options: BroadcastOptions): string;
}
```

### 2.3 自定义插件配置

```yaml
task:
  id: custom_task
  
  executor:
    type: custom
    handler: "plugins/executors/custom.ts"
    hot_reload: true
  
  broadcaster:
    type: custom
    handler: "plugins/broadcasters/custom.ts"
```

### 2.4 插件目录结构

```
plugins/
├── executors/
│   ├── weather.ts
│   ├── news.ts
│   └── custom.ts
└── broadcasters/
    ├── persona.ts
    └── neutral.ts
```

---

## 三、热加载

### 3.1 支持范围

| 组件 | 热加载 | 机制 |
|------|--------|------|
| 任务配置 | ✓ | 文件监听 |
| 执行器插件 | ✓ | 动态 import |
| 播报器插件 | ✓ | 动态 import |

### 3.2 实现方式

```typescript
// 配置热加载
class ConfigWatcher {
  watch(configDir: string): void {
    fs.watch(configDir, (event, filename) => {
      if (filename.endsWith('.yaml')) {
        this.reloadConfig(filename);
      }
    });
  }
}

// 插件热加载
class PluginLoader {
  async loadExecutor(path: string): Promise<Executor> {
    // 清除缓存
    delete require.cache[require.resolve(path)];
    // 重新加载
    return await import(path);
  }
}
```

---

## 四、可观测性

### 4.1 链路日志

每个任务记录完整链路：

```json
{
  "taskId": "task_xxx",
  "traceId": "trace_xxx",
  "timeline": [
    {"stage": "trigger", "time": "2026-01-20T10:00:00", "duration": 50},
    {"stage": "confirm", "time": "2026-01-20T10:00:01", "duration": 3000},
    {"stage": "execute", "time": "2026-01-20T10:00:04", "duration": 5000},
    {"stage": "broadcast", "time": "2026-01-20T10:00:09", "duration": 200}
  ],
  "result": "completed",
  "error": null
}
```

### 4.2 监控指标

| 指标 | 说明 |
|------|------|
| task_trigger_total | 任务触发总数 |
| task_complete_total | 任务完成总数 |
| task_fail_total | 任务失败总数 |
| task_duration_seconds | 任务耗时分布 |
| first_response_seconds | 首响时间分布 |

### 4.3 告警规则

| 告警 | 条件 |
|------|------|
| 首响超时 | > 2s |
| 任务失败率 | > 5% |
| 执行超时 | > 配置时间 |

---

## 五、后端需求

### 5.1 新增模块

| 模块 | 说明 |
|------|------|
| `PluginLoader` | 插件加载器 |
| `ConfigWatcher` | 配置监听 |
| `TraceLogger` | 链路日志 |
| `MetricsCollector` | 指标收集 |
| `AlertManager` | 告警管理 |

### 5.2 日志存储

```
logs/tasks/
├── {date}/
│   ├── {taskId}.json
│   └── ...
```

---

## 六、验收标准

| 场景 | 验收标准 |
|------|----------|
| 自定义执行器 | 正确加载并执行 |
| 自定义播报器 | 正确格式化结果 |
| 配置热加载 | 变更无需重启 |
| 插件热加载 | 变更无需重启 |
| 链路日志 | 完整记录各阶段 |
| 监控指标 | 正确采集 |
| 告警 | 触发规则时通知 |

---

## 七、完成标志

v2.2.5 完成后，任务处理模块全部功能开发完毕。

后续可规划：
- P1：任务依赖关系
- P2：历史持久化、定时任务
