# 2.0 版本功能规划

> **状态**：已确认  
> **版本**：v0.3  
> **日期**：2026-01-12  
> **设计规范**：[Agent设计规范.md](./Agent设计规范.md)

---

## 一、版本目标

在 1.0 基础上，通过 **多 Agent 协作架构** 实现：
1. **智能任务处理**：后台 Agent 处理联网查询、新闻整理等复杂任务
2. **语音小游戏**：海龟汤、猜谜、成语接龙等互动游戏
3. **更流畅的交互**：异步任务 + 即时安抚，用户体验不中断

---

## 二、核心架构设计

### 2.1 分层架构（优化版）

> [!IMPORTANT]
> 基于讨论，采用「人设 LLM + 调度 Agent」分层模式，避免单一 Agent 提示词过长。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          用户语音输入                                    │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    人设 LLM (ZEGO AI Agent 实例)                         │
│  ═══════════════════════════════════════════════════════════════════════│
│  职责：                                                                  │
│  ├─ 日常陪聊、情感共情 (90%+ 场景)                                       │
│  ├─ 场景感知：知道当前是闲聊/游戏/任务处理中                              │
│  ├─ 安抚回复：复杂任务时先回复用户                                        │
│  ├─ 能力引导：主动告知用户可以玩游戏、查新闻等                            │
│  └─ 结果播报：后台任务完成后，用自然语言播报                              │
│                                                                          │
│  Prompt 结构：人设 + 当前场景模块 (动态)                                  │
│  响应目标：首字节 < 500ms                                                │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                          需要后台能力时
                                   ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                     调度 Agent (Server 后台 LLM)                         │
│  ═══════════════════════════════════════════════════════════════════════│
│  职责：                                                                  │
│  ├─ 意图识别：判断任务类型和处理模式                                      │
│  ├─ 任务分发：调用对应的专业能力                                          │
│  └─ 结果整合：将结果格式化后返回给人设 LLM                                │
│                                                                          │
│  特点：不直接面向用户，无需人设表达                                       │
└─────────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┼──────────────┐
                    ▼              ▼              ▼
         ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
         │   新闻整理能力   │ │   游戏引擎能力   │ │   其他能力...    │
         │  ─────────────  │ │  ─────────────  │ │  ─────────────  │
         │  • 调用百炼 API  │ │  • 海龟汤逻辑    │ │  • 待扩展       │
         │  • 新闻聚合整理  │ │  • 猜谜判定      │ │                 │
         └─────────────────┘ └─────────────────┘ └─────────────────┘
```

### 2.2 人设 LLM 的提示词结构

```xml
<!-- 固定部分：人设核心 -->
<character_profile>
  ... (现有人设内容，保持不变)
</character_profile>

<!-- 动态部分：当前场景 -->
<current_scene>
  <scene_type>闲聊 | 游戏 | 任务处理</scene_type>
  
  <!-- 游戏场景专用 -->
  <game_state>
    <game_type>海龟汤 | 猜谜 | 成语接龙</game_type>
    <is_active>true | false</is_active>
    <current_puzzle>谜题内容...</current_puzzle>
    <turn_count>3</turn_count>
  </game_state>
  
  <!-- 任务场景专用 -->
  <task_state>
    <task_type>新闻整理 | 天气查询</task_type>
    <status>等待确认 | 执行中 | 已完成</status>
    <pending_result>任务结果内容...</pending_result>
  </task_state>
</current_scene>

<!-- 固定部分：能力边界 & 引导策略 -->
<capability_guide>
  你可以：
  - 陪用户玩语音游戏（海龟汤、猜谜、成语接龙）
  - 帮用户整理今日新闻
  
  主动引导时机：
  - 用户说"无聊"时，推荐游戏
  - 沉默 30s 时，询问是否想了解今日热点
  - 首次通话时，简单介绍你的能力
</capability_guide>
```

### 2.3 场景切换机制

| 触发条件 | 动作 | 示例 |
|----------|------|------|
| 用户请求玩游戏 | 更新 `<current_scene>` 为游戏模式 | "我们来玩海龟汤" |
| 游戏结束 | 重置 `<current_scene>` 为闲聊 | "答对了！游戏结束～" |
| 用户请求任务 | 更新为任务处理模式 | "帮我整理今天的新闻" |
| 任务完成/失败 | 重置为闲聊 | "整理好了！" 或 "抱歉失败了" |
| 游戏中用户问其他 | 询问是否暂停/停止游戏 | "你是想先暂停游戏回答问题，还是先把游戏玩完？" |

---

## 三、交互模式设计

> 详细规则参见 [Agent设计规范 - 交互模式判断规则](./Agent设计规范.md#三交互模式判断规则)

### 3.1 基于预估时间的模式判断

| 判断维度 | 直接执行 | 先确认细节 |
|----------|----------|------------|
| **信息完整度** | ✅ 完整 | ❌ 不足 |
| **预估时间** | < 2s（试错成本低） | > 5s（试错成本高） |
| **示例** | "北京今天天气" | "帮我整理新闻" |

### 3.2 判断流程

```
用户输入
    │
    ▼
┌─────────────────────────────────────────┐
│ 调度 Agent 评估：                        │
│ ① 信息是否充足？                        │
│ ② 预估完成时间？                        │
└─────────────────────────────────────────┘
    │
    ├── 信息充足 + 时间 < 2s ──▶ 直接执行
    │
    ├── 信息不足 OR 时间 > 5s ──▶ 先确认细节
    │
    └── 2-5s ──▶ 看信息完整度决定
```

### 3.3 示例对照

| 用户输入 | 信息完整度 | 预估时间 | 处理方式 |
|----------|-----------|----------|----------|
| "今天天气咋样" | ⚠️ 缺少地点 | ~1s | 用默认地点，快速返回 |
| "帮我整理新闻" | ❌ 缺少类型 | ~5s | 先问类型 |
| "北京今天天气" | ✅ 完整 | ~1s | 直接执行 |
| "写一篇科技新闻总结" | ✅ 完整 | ~10s | 先确认格式/篇幅 |

### 3.3 交互示例

#### 示例 A：新闻整理（需确认细节）

```
用户: "帮我整理一下今天的新闻"

人设 LLM: "好呀～你想看哪类新闻呢？科技、娱乐还是财经？"
         （判断：任务模糊，需追问）

用户: "科技类的"

人设 LLM: "好嘞，帮你整理科技新闻，稍等一下喔～" ← 安抚语
         （同时触发后台任务）

── 2-3 秒后 ──

人设 LLM: "找到啦！今天科技圈比较热的是..."   ← 结果播报
```

#### 示例 B：任务失败

```
用户: "今天有什么新闻？"

人设 LLM: "我查一下喔～"

── 网络超时 ──

人设 LLM: "抱歉呀，网络好像有点问题，新闻没查到呢 😢"
         "你想我再试一次，还是先聊点别的？"
```

#### 示例 C：游戏中用户问其他问题

```
（正在玩海龟汤）

用户: "对了，今天天气怎么样？"

人设 LLM: "唔，你是想先暂停海龟汤去看看天气，还是等游戏结束再说？"
         "如果暂停的话，我们回头可以继续玩喔～"

用户: "先看天气吧"

人设 LLM: "好的，游戏先暂停～ 我查一下天气..."
         （场景切换：游戏暂停 → 任务处理）
```

---

## 四、语音小游戏

### 4.1 游戏列表（按优先级）

| 优先级 | 游戏 | 说明 |
|--------|------|------|
| **P0** | 海龟汤 | AI 出谜题，用户通过是/否问题推理真相 |
| **P1** | 猜谜 | AI 出谜语，用户猜答案 |
| **P2** | 成语接龙 | 轮流说成语，首字接尾字 |

### 4.2 游戏状态管理

```typescript
// Server 端维护
interface GameSession {
  gameType: 'turtle_soup' | 'riddle' | 'idiom_chain';
  status: 'active' | 'paused' | 'completed';
  currentPuzzle: string;
  answer: string;
  hints: string[];
  turnCount: number;
  pauseReason?: string;  // "用户请求暂停查天气"
}
```

### 4.3 游戏暂停/恢复机制

- **暂停**：保存当前游戏状态，切换场景
- **恢复**：提示用户"要继续刚才的海龟汤吗？"
- **停止**：清空游戏状态，返回闲聊

---

## 五、能力引导策略

> 详细规则参见 [Agent设计规范 - 能力引导实现](./Agent设计规范.md#四能力引导实现)

### 5.1 实现方式

| 方式 | 场景 | 说明 |
|------|------|------|
| **欢迎语注入** | 首次通话 | 通过 `UserPrompt` 注入场景信息 + 引导提示 |
| **沉默检测** | 用户沉默 30s | 沿用现有机制，触发主动话题推荐 |
| **上下文感知** | 用户说"无聊" | Prompt 内置规则，触发游戏推荐 |

### 5.2 与动态打招呼的结合

首次通话欢迎语 = **动态时间打招呼** + **能力引导**

```
示例（周五晚上 21:00）：
"周五晚上好呀～终于可以放松啦！
 对了，要是无聊的话，我们可以玩玩海龟汤，或者我帮你看看今天有什么新闻热点？"
```

---

## 六、功能范围确认

> [!NOTE]
> 根据用户确认，2.0 版本聚焦以下功能：

### ✅ 确认开发

| 功能 | 说明 | 优先级 |
|------|------|--------|
| **多 Agent 架构** | 人设 LLM + 调度 Agent + 后台能力 | P0 |
| **新闻整理能力** | 调用百炼 API 搜集整理当日新闻 | P0 |
| **海龟汤游戏** | 完整游戏流程 + 暂停/恢复 | P0 |
| **猜谜游戏** | 基础游戏流程 | P1 |
| **成语接龙游戏** | 基础游戏流程 | P2 |

### ⏸️ 暂不开发

| 功能 | 原因 |
|------|------|
| 天气查询 | 可后续扩展 |
| 音乐推荐 | 需要额外 API 对接 |

---

## 七、新闻整理策略

### 7.1 渐进式输出

```
第一轮：简要摘要（3 条标题）
"今天科技圈有几个热点：
 1. xxx
 2. xxx
 3. xxx
 你想详细了解哪一条？"

第二轮：详细展开（用户选择后）
"关于 xxx，事情是这样的..."
```

### 7.2 用户偏好处理

| 偏好来源 | 处理方式 |
|----------|----------|
| 本次明确提出 | 优先级最高，直接按需求处理 |
| 历史记忆中的偏好 | 默认应用，但可被当前覆盖 |
| 无偏好 | 使用默认策略（渐进式） |

### 7.3 API 选择

使用 **百炼平台支持的联网 API**（具体在技术方案中确认）

---

## 八、确认记录

> [!NOTE]
> 以下问题已于 2026-01-12 确认：

### 8.1 核心架构

| 问题 | 确认结果 |
|------|----------|
| 分层架构设计 | ✅ 认可「人设 LLM + 调度 Agent」模式 |
| 场景模块动态更新 | ✅ OK |
| 调度调用策略 | ✅ 方案 B：人设 LLM 初筛 + 只在需要时调用调度 |
| 人设一致性保护 | ✅ 调度结果需翻译为人设语气 |

### 8.2 任务处理

| 问题 | 确认结果 |
|------|----------|
| 交互模式判断 | ✅ 基于预估时间：<2s 直接执行，>5s 先确认 |
| 任务取消机制 | ✅ 需明确询问用户要取消哪个任务，确认后再取消 |
| 长任务中间反馈 | ⏸️ 暂不需要，后续按优先级/关键节点扩展 |
| 多任务处理 | ✅ 任务队列，初期支持单任务，预留扩展 |
| 定时/周期任务 | 📋 未来扩展（"5分钟后提醒我"、"每天早上播报新闻"） |

### 8.3 游戏相关

| 问题 | 确认结果 |
|------|----------|
| 游戏暂停/恢复机制 | ✅ OK |
| 游戏题库 | ✅ 内置题库 |
| 上下文压缩 | ✅ 游戏历史需摘要化，防止遗忘 |
| ASR 热词增强 | ✅ 游戏模式下增加"是/不是/无关/放弃/暂停"等热词 |

### 8.4 异常处理

| 问题 | 确认结果 |
|------|----------|
| 失败场景处理 | ✅ 语音告知失败原因 + 询问处理方式 |
| 敏感内容过滤 | ✅ AI 自行判断是否合适分享 |
| 通话中断恢复 | ✅ 需要，但优先级低，先简单处理 |

### 8.5 能力引导 & 新闻

| 问题 | 确认结果 |
|------|----------|
| 能力引导策略 | ✅ 欢迎语注入 + 沉默检测 + 上下文感知 |
| 新闻整理格式 | ✅ 渐进式：先简要 3 条，用户追问再详细 |
| 新闻 API | ✅ 百炼平台支持的联网 API |

### 8.6 工程化

| 问题 | 确认结果 |
|------|----------|
| 调试日志 | ✅ 需要，通话结束后保存决策日志（后续迭代） |
| 版本兼容 | ✅ 尽量直接兼容 1.0，不考虑迁移 |

---

## 九、后续步骤

确认完成，将输出以下文档：

1. **技术方案 - 多 Agent 架构**
   - Server 端任务调度设计（含任务队列预留）
   - 人设 LLM Prompt 动态更新机制
   - 上下文压缩策略
   - ZEGO 主动说话 API 集成

2. **技术方案 - 语音小游戏**
   - 游戏状态机设计
   - 题库管理方案（内置 JSON）
   - ASR 热词配置
   - 游戏 Prompt 模板

3. **开发计划 2.0**
   - 任务拆解和排期
   - 优先级标注（P0/P1/P2）

