# 2.0 版本开发计划

> **状态**：草案  
> **版本**：v0.1  
> **日期**：2026-01-12  
> **目标**：完成多 Agent 架构升级，实现语音游戏和新闻整理功能。

---

## 📅 里程碑规划

| 阶段 | 周期 | 目标 | 关键交付物 |
|------|------|------|------------|
| **Phase 1: 基础设施** | 2 Days | 完成多 Agent 架构地基，打通意图调度链路 | Dispatch API, 动态 Prompt 模块, 双流响应 Demo |
| **Phase 2: 游戏引擎** | 3 Days | 实现海龟汤核心玩法及状态管理 | GameEngine, 题库 JSON, 游戏 UI |
| **Phase 3: 新闻能力** | 2 Days | 接入联网搜索，实现新闻整理与播报 | NewsService, 播报 Prompt, TTS 情绪适配 |
| **Phase 4: 体验优化** | 2 Days | 完善 VAD、异常处理及全链路测试 | 动态 VAD, 异常"人话"机制, 最终验收报告 |

---

## 📝 详细任务拆解

### Phase 1: 基础设施建设 (架构升级)

#### 1.1 Server 端核心能力
- [x] **Prompt Manager 升级**
    - 实现 `<scene>` 和 `<game_state>` 动态模块注入逻辑
    - 抽离 Prompt 分层结构 (L1/L2/L3)
- [x] **Dispatch API 开发**
    - 创建 `/api/dispatch` 路由
    - 实现意图路由分发逻辑 (`handleAction`)
    - 实现 `SendAgentInstanceLLM` 封装 (L3 指令注入)

#### 1.2 前端架构改造
- [x] **意图检测模块**
    - 开发 `useActionDetector` Hook
    - 实现 `[ACTION:xxx]` 正则解析与过滤
- [x] **双流响应机制**
    - 实现 TTS 播放与 API 请求的并行处理逻辑
    - 动态 VAD 通信 (API 已备，逻辑在 Dispatcher)**
    - 封装更新 ASR 参数的 API 方法

---

### Phase 2: 语音小游戏 (Feature: Game)

#### 2.1 游戏引擎 (Server)
- [x] **数据层**
    - 创建 `Source/server/data/games/` 目录
    - 建立 `GameSession` 状态定义与持久化逻辑
- [x] **题库准备**
    - 创建 `Source/server/config/games/turtle_soup.json` (海龟汤, 10题)
    - 创建 `Source/server/config/games/riddle.json` (猜谜, 10题)
- [x] **GameEngine 实现**
    - 实现 `startGame`, `pauseGame`, `resumeGame`, `endGame`
    - 集成 LLM 裁判逻辑 (判断用户推理是否正确)

#### 2.2 前端游戏体验
- [x] **游戏状态管理**
    - 前端 `useZegoRTC` 增加 `activeGameType` 状态
    - `useActionDetector` 解析 `[ACTION:GAME:xxx]` 并同步状态
- [x] **游戏 UI 组件**
    - 新增 `GameStatusCard` 显示当前游戏图标与名称
    - 集成到 `CallPage` 头部区域
    - 优化游戏海报与提示显示 (`GameStatusCard` 进度条与提示墙)

---

### Phase 3: 新闻整理能力 (Feature: News)

#### 3.1 新闻服务 (Server)
- [ ] **NewsService 开发**
    - 集成阿里百炼联网搜索 API (或 MCP 方案)
    - 编写新闻摘要 Prompt (Prompt Engineering)
- [ ] **TTS 情绪适配**
    - 校验 MiniMax 支持的情绪列表
    - 在新闻播报中强制通过 L3 注入情绪标签

#### 3.2 意图触发
- [ ] **System Prompt 调优**
    - 优化新闻触发的 Few-Shot Examples
    - 确保 LLM 稳定输出 `[ACTION:NEWS:xxx]`

---

### Phase 4: 体验优化与验收 (Opt & QA)

#### 4.1 体验打磨
- [ ] **动态 VAD 策略**
    - 调试闲聊 (500ms) 与游戏 (1200ms) 切换的流畅度
- [ ] **异常处理 (人话化)**
    - 封装全局错误拦截器，将 API 错误转化为 AI 引导语
- [ ] **敏感词防御**
    - 在 System Prompt 增加软性拒绝规则

#### 4.2 测试验收
- [ ] **单元测试**
    - GameEngine 状态流转测试
    - Action 解析正则测试
- [ ] **集成测试**
    - 完整体验一局海龟汤 (开局->暂停->恢复->结束)
    - 完整体验一次新闻查询 (意图->搜索->播报)

---

## 🛠 资源需求

| 资源 | 说明 |
|------|------|
| **后端开发** | 1 人 |
| **前端开发** | 1 人 |
| **测试设备** | iOS/Android 真机各一台 (测试 VAD 和音频流) |
| **云资源** | 阿里百炼 API Key, MiniMax 额度 |

