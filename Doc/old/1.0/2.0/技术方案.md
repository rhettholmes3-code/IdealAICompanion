# 2.0 æŠ€æœ¯æ–¹æ¡ˆ

> **çŠ¶æ€**ï¼šå¾…å®¡æ ¸  
> **ç‰ˆæœ¬**ï¼šv0.1  
> **æ—¥æœŸ**ï¼š2026-01-12  
> **ä¾èµ–æ–‡æ¡£**ï¼š[åŠŸèƒ½è§„åˆ’.md](./åŠŸèƒ½è§„åˆ’.md) | [Agentè®¾è®¡è§„èŒƒ.md](./Agentè®¾è®¡è§„èŒƒ.md)

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 æ•´ä½“æ¶æ„ï¼ˆå¤š Agent åˆ†å±‚ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              ç”¨æˆ·æµè§ˆå™¨ (H5)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  å‰ç«¯åº”ç”¨ (React + Vite)                                                â”‚ â”‚
â”‚  â”‚  â”œâ”€ é€šè¯ UIï¼ˆéŸ³æµªã€å­—å¹•ã€çŠ¶æ€ï¼‰                                          â”‚ â”‚
â”‚  â”‚  â”œâ”€ æ„å›¾æ ‡è¯†æ£€æµ‹ â†’ ç›‘å¬ [ACTION:xxx] è§¦å‘åå°ä»»åŠ¡                        â”‚ â”‚
â”‚  â”‚  â””â”€ æ¸¸æˆ UIï¼ˆè¿›åº¦ã€æç¤ºï¼‰                                               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                    â”‚ HTTP API                        â”‚ RTC éŸ³è§†é¢‘æµ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ZEGO RTC äº‘æœåŠ¡                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    ZEGO AI Agent æœåŠ¡                                â”‚    â”‚
â”‚  â”‚                                                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚    â”‚
â”‚  â”‚  â”‚  äººè®¾ LLM (æ‰˜ç®¡äº ZEGOï¼Œè°ƒç”¨é˜¿é‡Œç™¾ç‚¼ qwen-plus)                 â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  èŒè´£ï¼š                                                      â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ æ—¥å¸¸é™ªèŠã€æƒ…æ„Ÿå…±æƒ… (90%+ åœºæ™¯)                            â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ åœºæ™¯æ„ŸçŸ¥ï¼šçŸ¥é“å½“å‰æ˜¯é—²èŠ/æ¸¸æˆ/ä»»åŠ¡å¤„ç†ä¸­                   â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ æ„å›¾è¾“å‡ºï¼šå¤æ‚ä»»åŠ¡æ—¶è¾“å‡º [ACTION:NEWS] ç­‰æ ‡è¯†              â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â”œâ”€ æ¸¸æˆä¸»æŒï¼šæ ¹æ® <game_state> æ¨¡å—è¿›è¡Œæ¸¸æˆæµç¨‹               â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€ ç»“æœæ’­æŠ¥ï¼šåå°ä»»åŠ¡å®Œæˆåé€šè¿‡ SendAgentInstanceLLM æ’­æŠ¥     â”‚    â”‚    â”‚
â”‚  â”‚  â”‚                                                              â”‚    â”‚    â”‚
â”‚  â”‚  â”‚  åŠ¨æ€ Promptï¼š<character> + <scene> + <game_state>           â”‚    â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Server API
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡åå° (Next.js API Routes)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Agent ç®¡ç† API â”‚ â”‚ è°ƒåº¦ Agent    â”‚ â”‚ æ•°æ®å­˜å‚¨                        â”‚    â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚
â”‚  â”‚ â€¢ åˆ›å»º/é”€æ¯å®ä¾‹ â”‚ â”‚ â€¢ æ„å›¾è¯†åˆ«     â”‚ â”‚ â€¢ æ¸¸æˆçŠ¶æ€ (JSON)              â”‚    â”‚
â”‚  â”‚ â€¢ åŠ¨æ€æ›´æ–°Promptâ”‚ â”‚ â€¢ ä»»åŠ¡åˆ†å‘     â”‚ â”‚ â€¢ é¢˜åº“ç®¡ç† (JSON)              â”‚    â”‚
â”‚  â”‚ â€¢ åœºæ™¯åˆ‡æ¢     â”‚ â”‚ â€¢ ç»“æœæ•´åˆ     â”‚ â”‚ â€¢ ç”¨æˆ·åå¥½ (å¯é€‰)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                            â”‚                                                â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                  â”‚
â”‚              â–¼             â–¼             â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚   æ–°é—»æ•´ç†èƒ½åŠ›    â”‚ â”‚   æ¸¸æˆå¼•æ“èƒ½åŠ›    â”‚ â”‚   å…¶ä»–èƒ½åŠ›...     â”‚            â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚            â”‚
â”‚   â”‚  â€¢ ç™¾ç‚¼è”ç½‘æœç´¢   â”‚ â”‚  â€¢ æµ·é¾Ÿæ±¤é€»è¾‘     â”‚ â”‚  â€¢ å¾…æ‰©å±•        â”‚            â”‚
â”‚   â”‚  â€¢ æˆ– MCP è°ƒç”¨   â”‚ â”‚  â€¢ çŒœè°œåˆ¤å®š       â”‚ â”‚                  â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒè®¾è®¡å†³ç­–

| å†³ç­–ç‚¹ | é€‰æ‹© | ç†ç”± |
|--------|------|------|
| è°ƒåº¦ Agent éƒ¨ç½²ä½ç½® | å¤ç”¨ç°æœ‰ Next.js Server | æ¶æ„ç®€æ´ï¼Œå¤ç”¨åŸºç¡€è®¾æ–½ |
| äººè®¾ LLM â†” è°ƒåº¦ Agent é€šä¿¡ | åç«¯ APIï¼ˆæ„å›¾æ ‡è¯†è§¦å‘ï¼‰ | è§£è€¦æ€§å¼ºï¼Œå¯æ§æ€§é«˜ |
| è°ƒåº¦ Agent æ¨¡å‹ | å¤ç”¨ qwen-plus | ç»Ÿä¸€ç®¡ç†ï¼Œæˆæœ¬å¯æ§ |
| æ¸¸æˆçŠ¶æ€æŒä¹…åŒ– | JSON æ–‡ä»¶å­˜å‚¨ | ç®€å•å¯é ï¼ŒåˆæœŸè§„æ¨¡å° |
| æ–°é—»æ•°æ®ç¼“å­˜ | æš‚ä¸å®ç° | é™ä½å¤æ‚åº¦ï¼Œåç»­æŒ‰éœ€æ·»åŠ  |

### 1.4 æ¶æ„æ¼”è¿›ä¸å¯¹æ¯”ï¼ˆå‚è€ƒ LangGraphï¼‰

æœ¬æ–¹æ¡ˆé‡‡ç”¨äº† **Client-Side Routing (Perceived) + Server-Side Dispatch** çš„æ··åˆæ¨¡å¼ï¼Œä¸å¸‚é¢ä¸Šæ ‡å‡†å¤šæ™ºèƒ½ä½“æ¶æ„ï¼ˆå¦‚ LangGraph / AutoGenï¼‰çš„å¯¹æ¯”å¦‚ä¸‹ï¼š

| ç»´åº¦ | æ ‡å‡† LangGraph æ¶æ„ | æœ¬æ–¹æ¡ˆ (IdealAICompanion 2.0) | é€‰å‹ç†ç”± |
|------|--------------------|----------------------------|----------|
| **Router (è·¯ç”±)** | **Conditional Edges**: LLM å†³å®šä¸‹ä¸€æ­¥èµ°å“ªä¸ª Node | **Intent Trigger**: äººè®¾ LLM è¾“å‡º `[ACTION]` æ ‡è¯†ï¼Œåç«¯æ­£åˆ™è·¯ç”± | å‡å°‘ LLM äº¤äº’æ¬¡æ•°ï¼Œé™ä½å»¶è¿Ÿï¼Œåˆ©ç”¨ RTC å®æ—¶æµç‰¹æ€§ |
| **State (çŠ¶æ€)** | **Graph State**: å…¨å±€å…±äº«çš„ State Schema (messages, keys) | **Session State**: Server ç«¯å†…å­˜/Redis ç»´æŠ¤çš„ `GameSession` | çŠ¶æ€è½»é‡åŒ–ï¼Œé€‚åˆå®æ—¶è¯­éŸ³åœºæ™¯ï¼Œé¿å…å¤æ‚çš„çŠ¶æ€å¿«ç…§ |
| **Nodes (èŠ‚ç‚¹)** | æ¯ä¸ªèŠ‚ç‚¹æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ Agent/Tool | **Logical Nodes**: æ¸¸æˆå¼•æ“ã€æ–°é—»æœåŠ¡ä½œä¸ºé€»è¾‘æ¨¡å— | é™ä½éƒ¨ç½²å¤æ‚åº¦ï¼Œå¤ç”¨å•ä½“ Server èµ„æº |
| **Human-in-the-loop** | æ˜¾å¼çš„ Interrupt è®¾è®¡ | **Implicit**: ç”¨æˆ·éšæ—¶å¯ä»¥é€šè¿‡è¯­éŸ³æ‰“æ–­/æš‚åœ | è¯­éŸ³åœºæ™¯æ›´åŠ å¹³æƒï¼Œæ— éœ€æ˜¾å¼å®¡æ‰¹æµ |

#### æˆ‘ä»¬çš„æ¶æ„å›¾è°± (Pseudo-Graph)

å¦‚æœç”¨å›¾ç»“æ„è¡¨ç¤ºæœ¬ç³»ç»Ÿï¼š

```mermaid
graph TD
    User((User Voice)) -->|ASR| Persona[Node: Persona LLM]
    Persona -->|Direct Reply| User
    Persona -->|"[ACTION:GAME]"| Router{Server Dispatcher}
    
    Router -->|Start/Action| Game[Node: Game Engine]
    Router -->|Fetch| News[Node: News Service]
    
    Game -->|Result/Hint| Inject[Action: SendAgentInstanceLLM]
    News -->|Summary| Inject
    
    Inject -->|System Msg| Persona
```

è¿™ç§ **"ä»¥äººè®¾ä¸ºä¸­å¿ƒ (Persona-Centric)"** çš„æ˜Ÿå‹æ‹“æ‰‘ï¼Œæ¯”æ ‡å‡†çš„ **"å¤šæ™ºèƒ½ä½“åä½œ (Collaboration)"** ç½‘çŠ¶æ‹“æ‰‘æ›´é€‚åˆ**æƒ…æ„Ÿé™ªä¼´**åœºæ™¯ï¼Œå› ä¸ºç”¨æˆ·å§‹ç»ˆåªæ„ŸçŸ¥åˆ°ä¸€ä¸ªç»Ÿä¸€çš„äººæ ¼ï¼ˆå°å¶ï¼‰ã€‚

### 1.5 æ™ºèƒ½ä½“ç®¡ç†ä¸æ’åº

ç³»ç»Ÿæ”¯æŒå¤šä¸ªæ™ºèƒ½ä½“ï¼ˆå°å¶ã€å°æ«ã€å°èŠ±ï¼‰ï¼Œä¸ºäº†ä¿è¯ç”¨æˆ·ä½“éªŒçš„ä¸€è‡´æ€§ï¼Œé‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š

1.  **æ’åºç­–ç•¥**ï¼š
    - åœ¨æ™ºèƒ½ä½“é…ç½®æ–‡ä»¶ (`config/agents/*.json`) ä¸­å¢åŠ  `order` å­—æ®µï¼ˆtype: numberï¼‰ã€‚
    - åç«¯ API (`/api/agents`) è¿”å›åˆ—è¡¨æ—¶ï¼Œæ ¹æ® `order` å­—æ®µå‡åºæ’åˆ—ã€‚
    - é»˜è®¤é¡ºåºï¼šå°å¶ (1) -> å°æ« (2) -> å°èŠ± (3)ã€‚

2.  **é»˜è®¤é€‰ä¸­**ï¼š
    - å‰ç«¯é¡µé¢åŠ è½½æ—¶ï¼Œè‡ªåŠ¨é€‰ä¸­æ’åºååˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½ä½“ã€‚

### 1.6 ç”¨æˆ·è®°å¿†ç³»ç»Ÿ

> [!IMPORTANT]
> 2.0 ç‰ˆæœ¬é‡‡ç”¨ **åŠ¨æ€æ³¨å…¥** æœºåˆ¶ç®¡ç†ç”¨æˆ·è®°å¿†ï¼Œä¸å†ä¿®æ”¹ Prompt æ¨¡æ¿æ–‡ä»¶ã€‚

#### 1.6.1 æ•°æ®ç»“æ„
è®°å¿†å­˜å‚¨åœ¨ `Source/server/data/users/{userId}_{agentId}.json` ä¸­ï¼š

```json
{
  "userId": "user_123",
  "agentId": "xiaoye",
  "targetUser": "ç”¨æˆ·ç”»åƒå†…å®¹...",
  "relationshipEvolution": "å…³ç³»è¿›é˜¶å†…å®¹...",
  "lastUpdated": 1736769000000
}
```

#### 1.6.2 æ³¨å…¥æœºåˆ¶
- **åˆ›å»ºé€šè¯æ—¶**ï¼š`POST /create` æ¥å£é€šè¿‡ `MemoryManager` è¯»å–ç”¨æˆ·ä¸“å± JSONã€‚
- **åŠ¨æ€æ›¿æ¢**ï¼šå°†è¯»å–çš„å†…å®¹ä½œä¸º `TARGET_USER` å’Œ `RELATIONSHIP_EVOLUTION` å˜é‡ä¼ å…¥ `PromptManager`ã€‚
- **æ¨¡æ¿å ä½ç¬¦**ï¼š
  - `{{TARGET_USER}}` -> æ³¨å…¥åˆ° `<interaction_rules><target_user>`
  - `{{RELATIONSHIP_EVOLUTION}}` -> æ³¨å…¥åˆ° `<character_profile><relationship_evolution>`

#### 1.6.3 æ›´æ–°æœºåˆ¶ (Bailian)
- **ç”Ÿæˆ**ï¼šBailian Agent åˆ†æå¯¹è¯ï¼Œè¾“å‡ºæ–°çš„ Memory JSONã€‚
- **å­˜å‚¨**ï¼š`PersonaManager` è°ƒç”¨ `MemoryManager.updateUserMemory` æ›´æ–° JSON æ–‡ä»¶ã€‚
- **çƒ­æ›´æ–°**ï¼š`PersonaManager` ä½¿ç”¨æ–°å†…å­˜é‡æ–°æ¸²æŸ“ System Prompt å¹¶è°ƒç”¨ ZEGO `UpdateAgentInstance` æ¥å£ã€‚

---

## äºŒã€Server ç«¯è°ƒåº¦è®¾è®¡

### 2.1 è°ƒåº¦æµç¨‹

```
å‰ç«¯ç›‘å¬ LLM è¾“å‡º
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æµ‹æ„å›¾æ ‡è¯†ï¼š[ACTION:NEWS] [ACTION:GAME] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€â”€â”€â”€ æ— æ„å›¾æ ‡è¯† â”€â”€â–¶ æ­£å¸¸å¯¹è¯ï¼Œä¸åšå¤„ç†
        â”‚
        â””â”€â”€â”€â”€ æœ‰æ„å›¾æ ‡è¯† â”€â”€â–¶ è°ƒç”¨åç«¯ API
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ POST /api/dispatch      â”‚
                    â”‚ {                       â”‚
                    â”‚   action: "NEWS",       â”‚
                    â”‚   params: { type: "ç§‘æŠ€" },â”‚
                    â”‚   instanceId: "..."     â”‚
                    â”‚ }                       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è°ƒåº¦ Agent (Server LLM)  â”‚
                    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
                    â”‚ 1. è§£æä»»åŠ¡å‚æ•°         â”‚
                    â”‚ 2. è°ƒç”¨å¯¹åº”èƒ½åŠ›         â”‚
                    â”‚ 3. æ ¼å¼åŒ–ç»“æœ           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ è°ƒç”¨ SendAgentInstanceLLMâ”‚
                    â”‚ å°†ç»“æœæ³¨å…¥äººè®¾ LLM       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ äººè®¾ LLM è‡ªç„¶è¯­è¨€æ’­æŠ¥    â”‚
                    â”‚ "ä»Šå¤©ç§‘æŠ€åœˆæ¯”è¾ƒçƒ­çš„æ˜¯..."â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ„å›¾æ ‡è¯†è®¾è®¡

äººè®¾ LLM åœ¨éœ€è¦åå°èƒ½åŠ›æ—¶ï¼Œè¾“å‡ºç‰¹å®šæ ¼å¼çš„æ„å›¾æ ‡è¯†ï¼š

```xml
<!-- åœ¨ Prompt ä¸­å®šä¹‰ -->
<action_triggers>
  å½“éœ€è¦åå°èƒ½åŠ›æ—¶ï¼Œåœ¨å›å¤æœ«å°¾è¾“å‡ºæ„å›¾æ ‡è¯†ï¼š
  
  - æ–°é—»æ•´ç†ï¼š[ACTION:NEWS:ç§‘æŠ€] æˆ– [ACTION:NEWS:å¨±ä¹]
  - å¼€å§‹æ¸¸æˆï¼š[ACTION:GAME:turtle_soup] æˆ– [ACTION:GAME:riddle]
  - æš‚åœæ¸¸æˆï¼š[ACTION:GAME_PAUSE]
  - æ¢å¤æ¸¸æˆï¼š[ACTION:GAME_RESUME]
  - ç»“æŸæ¸¸æˆï¼š[ACTION:GAME_END]
  
  æ ‡è¯†æ ¼å¼ï¼š[ACTION:ç±»å‹:å‚æ•°]
  æ ‡è¯†ä»…ç”¨äºè§¦å‘åå°ï¼Œç”¨æˆ·çœ‹ä¸åˆ°
</action_triggers>
```

**å‰ç«¯æ£€æµ‹æ­£åˆ™**ï¼š

```typescript
const ACTION_REGEX = /\[ACTION:([A-Z_]+)(?::([^\]]+))?\]/g;

function parseActions(text: string): Array<{type: string, param?: string}> {
  const actions: Array<{type: string, param?: string}> = [];
  let match;
  while ((match = ACTION_REGEX.exec(text)) !== null) {
    actions.push({ type: match[1], param: match[2] });
  }
  return actions;
}
```

### 2.3 è°ƒåº¦ API è®¾è®¡

#### POST `/api/dispatch`

**è¯·æ±‚ä½“**ï¼š
```json
{
  "action": "NEWS",
  "params": {
    "type": "ç§‘æŠ€"
  },
  "instanceId": "agent_instance_12345",
  "roomId": "room_001"
}
```

**å¤„ç†é€»è¾‘**ï¼š
```typescript
// app/api/dispatch/route.ts
export async function POST(req: Request) {
  const { action, params, instanceId, roomId } = await req.json();
  
  let result: string;
  
  switch (action) {
    case 'NEWS':
      result = await handleNewsRequest(params.type);
      break;
    case 'GAME':
      result = await handleGameStart(params.gameType, roomId);
      break;
    case 'GAME_PAUSE':
      result = await handleGamePause(roomId);
      break;
    // ... å…¶ä»– action
    default:
      return Response.json({ error: 'Unknown action' }, { status: 400 });
  }
  
  // å°†ç»“æœå‘é€ç»™äººè®¾ LLM è¿›è¡Œæ’­æŠ¥
  await sendToPersonaLLM(instanceId, result);
  
  return Response.json({ success: true });
}
```

### 2.4 ç»“æœæ³¨å…¥æœºåˆ¶

ä½¿ç”¨ ZEGO AI Agent çš„ **SendAgentInstanceLLM** API å°†åå°ç»“æœæ³¨å…¥äººè®¾ LLMï¼š

```typescript
async function sendToPersonaLLM(instanceId: string, content: string) {
  // æ„å»º UserPrompt æ ¼å¼çš„æ¶ˆæ¯
  const userMessage = `
[ç³»ç»Ÿæ¶ˆæ¯ - åå°ä»»åŠ¡ç»“æœ]
${content}

è¯·ç”¨ä½ çš„è¯­æ°”è‡ªç„¶åœ°å‘ç”¨æˆ·æ’­æŠ¥ä¸Šè¿°å†…å®¹ã€‚
`;

  await sendZegoRequest('SendAgentInstanceLLM', {
    AgentInstanceId: instanceId,
    Mode: 1, // 1=ç«‹å³æ’­æŠ¥
    Message: {
      Role: 'user',
      Content: userMessage
    }
  });
}
```

---

## ä¸‰ã€äººè®¾ LLM åŠ¨æ€ Prompt æœºåˆ¶

### 3.1 Prompt åˆ†å±‚ç­–ç•¥ï¼ˆä¼˜åŒ–ï¼‰

> [!TIP]
> é‡‡ç”¨ **"é™æ€äººè®¾ + åŠ¨æ€çŠ¶æ€ + ç¬æ—¶æŒ‡ä»¤"** çš„ä¸‰å±‚æ¶æ„ï¼Œé¿å… System Prompt è¿‡é•¿ã€‚

| å±‚çº§ | è½½ä½“ | å†…å®¹ | è§¦å‘æ—¶æœº |
|------|------|------|----------|
| **L1 é™æ€å±‚** | System Prompt | â€¢ äººè®¾æ ¸å¿ƒ (Name, Role)<br>â€¢ è¯­è¨€é£æ ¼<br>â€¢ æ ¸å¿ƒè¾¹ç•Œ (Safety)<br>â€¢ è¾“å‡ºæ ¼å¼å®šä¹‰ (`[ACTION:xxx]`) | **åˆå§‹åŒ–æ™‚**<br>(å‡ ä¹ä¸å˜) |
| **L2 çŠ¶æ€å±‚** | UpdateAgentInstance | â€¢ **Current Scene**: é—²èŠ/æ¸¸æˆ/ä»»åŠ¡<br>â€¢ **Game State**: æ¸¸æˆè¿›åº¦/è°œé¢<br>â€¢ **Time/Location**: åŠ¨æ€æ—¶ç©º | **çŠ¶æ€å˜æ›´æ—¶**<br>(åˆ‡æ¢æ¸¸æˆ/ä»»åŠ¡) |
| **L3 æŒ‡ä»¤å±‚** | SendAgentInstanceLLM | â€¢ **Guide Rules**: "ç”¨æˆ·æ²‰é»˜30sï¼Œè¯·æ¨èè¯é¢˜"<br>â€¢ **Triggers**: "ç”¨æˆ·è§‰å¾—æ— èŠï¼Œè¯·æ¨èæ¸¸æˆ"<br>â€¢ **Task Results**: æ–°é—»ç»“æœ/å¤©æ°”æ•°æ® | **äº‹ä»¶è§¦å‘æ—¶**<br>(ç¬æ—¶æ³¨å…¥ï¼Œä¸æ®‹ç•™) |

#### 3.1.1 ä¼˜åŒ–åçš„ System Prompt ç»“æ„

ä»…ä¿ç•™æ ¸å¿ƒå’Œå½“å‰çŠ¶æ€ï¼Œ**ç§»é™¤**å…·ä½“çš„å¼•å¯¼è¯æœ¯ï¼ˆæ”¹ä¸º L3 æ³¨å…¥ï¼‰ï¼š

```xml
<system_prompt>
  <character>...</character>
  <capabilities>...</capabilities>
  
  <!-- çŠ¶æ€å±‚ï¼šç”± UpdateAgentInstance åŠ¨æ€æ›´æ–° -->
  <scene_context>
    æ—¶é—´: {{CURRENT_TIME}}
    å½“å‰æ¨¡å¼: {{SCENE_TYPE}}
    {{#if GAME_STATE}}<game_state>...</game_state>{{/if}}
  </scene_context>

  <output_rules>
    éœ€è¦è°ƒç”¨åå°èƒ½åŠ›æ—¶ï¼Œè¾“å‡º [ACTION:ç±»å‹:å‚æ•°]
  </output_rules>
</system_prompt>
```

#### 3.1.2 æŒ‡ä»¤å±‚æ³¨å…¥ç¤ºä¾‹ (SendAgentInstanceLLM)

**åœºæ™¯ï¼šæ²‰é»˜å¼•å¯¼**
```javascript
// Server æ£€æµ‹åˆ° VAD æ²‰é»˜ 30s
await sendZegoRequest('SendAgentInstanceLLM', {
  AgentInstanceId: instanceId,
  Message: {
    Role: 'system', // æˆ– userï¼Œè§† LLM å¯¹ system çš„æ”¯æŒåº¦è€Œå®š
    Content: "[ç³»ç»ŸæŒ‡ä»¤] ç”¨æˆ·å·²æ²‰é»˜ 30 ç§’ã€‚è¯·ä»¥å…³å¿ƒçš„å£å»æ‰“ç ´æ²‰é»˜ï¼Œæˆ–æ¨èç©'æµ·é¾Ÿæ±¤'æ¸¸æˆã€‚"
  }
});
```

**åœºæ™¯ï¼šä»»åŠ¡ç»“æœ**
```javascript
// News Service è¿”å›ç»“æœ
await sendZegoRequest('SendAgentInstanceLLM', {
  AgentInstanceId: instanceId,
  Message: {
    Role: 'user',
    Content: "[ç³»ç»Ÿæ¶ˆæ¯ - æ–°é—»æ•´ç†å®Œæˆ]\n1. ç§‘æŠ€:...\n2. å¨±ä¹:...\nè¯·æ’­æŠ¥ä¸Šè¿°æ–°é—»ã€‚"
  }
});
```

### 3.2 åœºæ™¯åˆ‡æ¢æœºåˆ¶

é€šè¿‡ ZEGO çš„ **UpdateAgentInstance** API åŠ¨æ€æ›´æ–° SystemPromptï¼š

```typescript
// lib/scene-manager.ts
interface SceneState {
  sceneType: 'chat' | 'game' | 'task';
  gameState?: GameSession;
  taskState?: TaskState;
}

export async function updateScene(
  instanceId: string,
  agentId: string,
  scene: SceneState
) {
  const promptManager = PromptManager.getInstance();
  
  // ç”ŸæˆåŒ…å«å½“å‰åœºæ™¯çš„æ–° Prompt
  const newPrompt = promptManager.generateFinalPrompt(
    `${agentId}.xml`,
    {
      SCENE_TYPE: formatSceneType(scene.sceneType),
      GAME_STATE: scene.gameState ? JSON.stringify(scene.gameState) : undefined,
      TASK_STATE: scene.taskState ? JSON.stringify(scene.taskState) : undefined,
    }
  );
  
  // è°ƒç”¨ ZEGO API æ›´æ–° Prompt
  await sendZegoRequest('UpdateAgentInstance', {
    AgentInstanceId: instanceId,
    LLM: {
      SystemPrompt: newPrompt
    }
  });
}
```

### 3.3 åœºæ™¯åˆ‡æ¢è§¦å‘ç‚¹

| è§¦å‘æ¡ä»¶ | åœºæ™¯å˜åŒ– | API è°ƒç”¨ |
|----------|----------|----------|
| ç”¨æˆ·è¯·æ±‚ç©æ¸¸æˆ | chat â†’ game | UpdateAgentInstance |
| æ¸¸æˆç»“æŸ | game â†’ chat | UpdateAgentInstance |
| ç”¨æˆ·è¯·æ±‚ä»»åŠ¡ | chat â†’ task | UpdateAgentInstance |
| ä»»åŠ¡å®Œæˆ/å¤±è´¥ | task â†’ chat | UpdateAgentInstance |
| æ¸¸æˆä¸­æš‚åœ | game(active) â†’ game(paused) | UpdateAgentInstance |

---

## å››ã€è¯­éŸ³å°æ¸¸æˆæŠ€æœ¯æ–¹æ¡ˆ

### 4.1 æ¸¸æˆåˆ—è¡¨ä¸ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | æ¸¸æˆ | å®ç°å¤æ‚åº¦ | è¯´æ˜ |
|--------|------|------------|------|
| **P0** | æµ·é¾Ÿæ±¤ | ä¸­ç­‰ | AI å‡ºè°œé¢˜ï¼Œç”¨æˆ·é€šè¿‡æ˜¯/å¦é—®é¢˜æ¨ç† |
| **P1** | çŒœè°œ | ç®€å• | AI å‡ºè°œè¯­ï¼Œç”¨æˆ·çŒœç­”æ¡ˆ |
| **P2** | æˆè¯­æ¥é¾™ | ç®€å• | è½®æµè¯´æˆè¯­ï¼Œé¦–å­—æ¥å°¾å­— |

### 4.2 æ¸¸æˆçŠ¶æ€æœº

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                      æ¸¸æˆçŠ¶æ€æœº                          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚      IDLE       â”‚ â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   (æ— æ¸¸æˆè¿›è¡Œ)   â”‚                     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                                    â”‚                             â”‚
                        ç”¨æˆ·è¯·æ±‚ç©æ¸¸æˆ                            â”‚
                                    â”‚                             â”‚
                                    â–¼                             â”‚
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
                          â”‚     ACTIVE      â”‚                     â”‚
                          â”‚   (æ¸¸æˆè¿›è¡Œä¸­)   â”‚                     â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                              â”‚         â”‚                         â”‚
                  ç”¨æˆ·æš‚åœ    â”‚         â”‚   ç­”å¯¹/æ”¾å¼ƒ/æ¸¸æˆç»“æŸ    â”‚
                              â”‚         â”‚                         â”‚
                              â–¼         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚     PAUSED      â”‚
                    â”‚   (æ¸¸æˆæš‚åœ)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                  ç”¨æˆ·æ¢å¤    â”‚
                              â”‚
                              â–¼
                    (è¿”å› ACTIVE çŠ¶æ€)
```

### 4.3 æ¸¸æˆçŠ¶æ€æ•°æ®ç»“æ„

```typescript
// lib/game/types.ts
interface GameSession {
  sessionId: string;           // æ¸¸æˆä¼šè¯ ID
  roomId: string;              // å…³è”çš„é€šè¯æˆ¿é—´
  gameType: 'turtle_soup' | 'riddle' | 'idiom_chain';
  status: 'active' | 'paused' | 'completed';
  
  // æµ·é¾Ÿæ±¤ / çŒœè°œ å…±ç”¨
  currentPuzzle?: {
    question: string;          // è°œé¢/é¢˜ç›®
    answer: string;            // ç­”æ¡ˆ
    hints: string[];           // æç¤ºï¼ˆæŒ‰éœ€é‡Šæ”¾ï¼‰
    hintsRevealed: number;     // å·²é‡Šæ”¾çš„æç¤ºæ•°
  };
  
  // æˆè¯­æ¥é¾™ä¸“ç”¨
  idiomChain?: {
    currentIdiom: string;      // å½“å‰æˆè¯­
    lastChar: string;          // ä¸Šä¸€ä¸ªæˆè¯­çš„æœ€åä¸€ä¸ªå­—
    history: string[];         // å†å²æˆè¯­åˆ—è¡¨
  };
  
  turnCount: number;           // å›åˆè®¡æ•°
  pauseReason?: string;        // æš‚åœåŸå› 
  createdAt: number;           // åˆ›å»ºæ—¶é—´
  updatedAt: number;           // æœ€åæ›´æ–°æ—¶é—´
}
```

### 4.4 é¢˜åº“ç®¡ç†

é¢˜åº“ä»¥ JSON æ–‡ä»¶å­˜å‚¨åœ¨ `config/games/` ç›®å½•ï¼š

```
config/games/
â”œâ”€â”€ turtle_soup.json      # æµ·é¾Ÿæ±¤é¢˜åº“
â”œâ”€â”€ riddle.json           # çŒœè°œé¢˜åº“
â””â”€â”€ idiom.json            # æˆè¯­è¯åº“
```

**æµ·é¾Ÿæ±¤é¢˜åº“ç»“æ„** (`turtle_soup.json`)ï¼š

```json
{
  "version": "1.0",
  "puzzles": [
    {
      "id": "ts_001",
      "title": "é›ªå±±é‡éš¾",
      "question": "ä¸€ä¸ªäººåœ¨é›ªå±±ä¸Šé‡éš¾äº†ï¼Œä»–å¾ˆé«˜å…´ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
      "answer": "ä»–æ˜¯é›ªäººï¼Œå¤©æ°”å˜æš–ä¼šèåŒ–ï¼Œä¸‹é›ªæ„å‘³ç€ä»–èƒ½æ´»ä¸‹å»",
      "hints": [
        "ä»–ä¸æ˜¯æ™®é€šçš„äººç±»",
        "ä»–å’Œå¤©æ°”æœ‰å…³"
      ],
      "difficulty": "easy",
      "tags": ["ç»å…¸", "ç®€å•"]
    },
    // ... æ›´å¤šé¢˜ç›®ï¼ˆåˆæœŸ 10 é¢˜ï¼‰
  ]
}
```

**çŒœè°œé¢˜åº“ç»“æ„** (`riddle.json`)ï¼š

```json
{
  "version": "1.0",
  "riddles": [
    {
      "id": "rd_001",
      "question": "ä¸€å£å’¬æ‰ç‰›å°¾å·´ï¼ˆæ‰“ä¸€å­—ï¼‰",
      "answer": "å‘Š",
      "category": "å­—è°œ",
      "difficulty": "easy"
    }
    // ... æ›´å¤šé¢˜ç›®ï¼ˆåˆæœŸ 10 é¢˜ï¼‰
  ]
}
```

### 4.5 æ¸¸æˆå¼•æ“å®ç°

```typescript
// lib/game/game-engine.ts
export class GameEngine {
  private static instance: GameEngine;
  private sessions: Map<string, GameSession> = new Map();
  private puzzleLibrary: PuzzleLibrary;
  
  private constructor() {
    this.puzzleLibrary = new PuzzleLibrary();
    this.loadPersistedSessions();  // å¯åŠ¨æ—¶åŠ è½½æŒä¹…åŒ–çš„æ¸¸æˆçŠ¶æ€
  }
  
  /**
   * å¼€å§‹æ–°æ¸¸æˆ
   */
  async startGame(
    roomId: string, 
    gameType: GameSession['gameType']
  ): Promise<GameSession> {
    // è·å–éšæœºé¢˜ç›®
    const puzzle = this.puzzleLibrary.getRandomPuzzle(gameType);
    
    const session: GameSession = {
      sessionId: `game_${Date.now()}`,
      roomId,
      gameType,
      status: 'active',
      currentPuzzle: {
        question: puzzle.question,
        answer: puzzle.answer,
        hints: puzzle.hints || [],
        hintsRevealed: 0
      },
      turnCount: 0,
      createdAt: Date.now(),
      updatedAt: Date.now()
    };
    
    this.sessions.set(roomId, session);
    await this.persistSession(session);  // æŒä¹…åŒ–
    
    return session;
  }
  
  /**
   * å¤„ç†ç”¨æˆ·å›ç­”ï¼ˆæµ·é¾Ÿæ±¤çš„æ˜¯/å¦åˆ¤æ–­ï¼‰
   */
  async processAnswer(
    roomId: string, 
    userInput: string
  ): Promise<{
    isCorrect: boolean;
    hint?: string;
    message: string;
  }> {
    const session = this.sessions.get(roomId);
    if (!session || session.status !== 'active') {
      return { isCorrect: false, message: 'å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„æ¸¸æˆ' };
    }
    
    session.turnCount++;
    session.updatedAt = Date.now();
    
    // åˆ¤æ–­é€»è¾‘ç”±äººè®¾ LLM å¤„ç†ï¼ˆå®ƒçŸ¥é“ç­”æ¡ˆï¼‰
    // è¿™é‡ŒåªåšçŠ¶æ€ç®¡ç†
    await this.persistSession(session);
    
    return { isCorrect: false, message: '' };  // ç”± LLM åˆ¤æ–­
  }
  
  /**
   * æš‚åœæ¸¸æˆ
   */
  async pauseGame(roomId: string, reason?: string): Promise<GameSession | null> {
    const session = this.sessions.get(roomId);
    if (!session) return null;
    
    session.status = 'paused';
    session.pauseReason = reason;
    session.updatedAt = Date.now();
    
    await this.persistSession(session);
    return session;
  }
  
  /**
   * æ¢å¤æ¸¸æˆ
   */
  async resumeGame(roomId: string): Promise<GameSession | null> {
    const session = this.sessions.get(roomId);
    if (!session || session.status !== 'paused') return null;
    
    session.status = 'active';
    session.pauseReason = undefined;
    session.updatedAt = Date.now();
    
    await this.persistSession(session);
    return session;
  }
  
  /**
   * ç»“æŸæ¸¸æˆ
   */
  async endGame(roomId: string): Promise<void> {
    const session = this.sessions.get(roomId);
    if (session) {
      session.status = 'completed';
      await this.persistSession(session);
    }
    this.sessions.delete(roomId);
  }
  
  /**
   * æŒä¹…åŒ–æ¸¸æˆçŠ¶æ€
   */
  private async persistSession(session: GameSession): Promise<void> {
    const filePath = path.join(process.cwd(), 'data/games', `${session.roomId}.json`);
    await fs.promises.writeFile(filePath, JSON.stringify(session, null, 2));
  }
  
  /**
   * åŠ è½½æŒä¹…åŒ–çš„æ¸¸æˆçŠ¶æ€
   */
  private async loadPersistedSessions(): Promise<void> {
    const gamesDir = path.join(process.cwd(), 'data/games');
    
    if (!fs.existsSync(gamesDir)) {
      fs.mkdirSync(gamesDir, { recursive: true });
      return;
    }
    
    const files = await fs.promises.readdir(gamesDir);
    for (const file of files) {
      if (file.endsWith('.json')) {
        const content = await fs.promises.readFile(
          path.join(gamesDir, file), 
          'utf-8'
        );
        const session = JSON.parse(content) as GameSession;
        
        // åªåŠ è½½æœªå®Œæˆçš„æ¸¸æˆ
        if (session.status !== 'completed') {
          this.sessions.set(session.roomId, session);
        }
      }
    }
  }
}
```

### 4.6 ASR çƒ­è¯é…ç½®

æ¸¸æˆæ¨¡å¼ä¸‹åŠ¨æ€æ›´æ–° ASR çƒ­è¯ï¼Œæé«˜è¯†åˆ«å‡†ç¡®ç‡ï¼š

```typescript
// æ¸¸æˆæ¨¡å¼çƒ­è¯
const GAME_HOTWORDS = {
  turtle_soup: 'æ˜¯|æ˜¯çš„|ä¸æ˜¯|æ— å…³|æ”¾å¼ƒ|æç¤º|æš‚åœ|ç»“æŸæ¸¸æˆ',
  riddle: 'æ”¾å¼ƒ|æç¤º|æš‚åœ|ç»“æŸæ¸¸æˆ',
  idiom_chain: 'æˆ‘è¾“äº†|æš‚åœ|ç»“æŸæ¸¸æˆ'
};

// æ›´æ–° Agent å®ä¾‹æ—¶æ·»åŠ çƒ­è¯
async function updateGameHotwords(instanceId: string, gameType: string) {
  const hotwords = GAME_HOTWORDS[gameType] || '';
  const baseHotwords = 'å°å¶|ZEGO';
  
  await sendZegoRequest('UpdateAgentInstance', {
    AgentInstanceId: instanceId,
    ASR: {
      Params: {
        hotword_list: `${baseHotwords},${hotwords}`
      }
    }
  });
}
```

---

## äº”ã€æ–°é—»æ•´ç†æŠ€æœ¯æ–¹æ¡ˆ

### 5.1 å®ç°æ–¹æ¡ˆ

ä½¿ç”¨ **é˜¿é‡Œç™¾ç‚¼è”ç½‘æœç´¢æ’ä»¶** å®ç°æ–°é—»æ•´ç†èƒ½åŠ›ï¼š

```
ç”¨æˆ·è¯·æ±‚        "å¸®æˆ‘æ•´ç†ä»Šå¤©çš„ç§‘æŠ€æ–°é—»"
    â”‚
    â–¼
äººè®¾ LLM        è¾“å‡º "[ACTION:NEWS:ç§‘æŠ€]"
    â”‚
    â–¼
å‰ç«¯æ£€æµ‹        è§£æåˆ° ACTION:NEWSï¼Œè°ƒç”¨ /api/dispatch
    â”‚
    â–¼
è°ƒåº¦ API        è°ƒç”¨ handleNewsRequest("ç§‘æŠ€")
    â”‚
    â–¼
æ–°é—»èƒ½åŠ›        è°ƒç”¨ç™¾ç‚¼è”ç½‘æœç´¢ API
    â”‚
    â–¼
ç»“æœæ•´ç†        LLM æ•´ç†æˆ 3 æ¡æ‘˜è¦
    â”‚
    â–¼
ç»“æœæ³¨å…¥        SendAgentInstanceLLM å‘é€ç»™äººè®¾ LLM
    â”‚
    â–¼
äººè®¾ LLM        "ä»Šå¤©ç§‘æŠ€åœˆæœ‰å‡ ä¸ªçƒ­ç‚¹ï¼š1. xxx..."
```

### 5.2 æ–°é—»æ•´ç†æœåŠ¡

```typescript
// lib/news/news-service.ts
export class NewsService {
  private bailianClient: BailianClient;
  
  constructor() {
    this.bailianClient = new BailianClient({
      apiKey: process.env.LLM_API_KEY!,
      baseUrl: process.env.LLM_URL!
    });
  }
  
  /**
   * è·å–å¹¶æ•´ç†æ–°é—»
   */
  async getNews(category: string): Promise<string> {
    // 1. è°ƒç”¨ç™¾ç‚¼è”ç½‘æœç´¢
    const searchQuery = `ä»Šå¤©${category}æ–°é—»çƒ­ç‚¹`;
    const rawResults = await this.bailianClient.search(searchQuery);
    
    // 2. ä½¿ç”¨ LLM æ•´ç†æˆæ‘˜è¦
    const summaryPrompt = `
è¯·æ ¹æ®ä»¥ä¸‹æœç´¢ç»“æœï¼Œæ•´ç†å‡ºä»Šæ—¥${category}ç±»çš„ 3 æ¡çƒ­ç‚¹æ–°é—»æ‘˜è¦ã€‚
æ¯æ¡æ‘˜è¦éœ€åŒ…å«ï¼šæ ‡é¢˜ã€ç®€è¦å†…å®¹ï¼ˆ30å­—ä»¥å†…ï¼‰ã€‚

æœç´¢ç»“æœï¼š
${JSON.stringify(rawResults)}

è¾“å‡ºæ ¼å¼ï¼š
1. [æ ‡é¢˜1]: ç®€è¦å†…å®¹
2. [æ ‡é¢˜2]: ç®€è¦å†…å®¹
3. [æ ‡é¢˜3]: ç®€è¦å†…å®¹
`;
    
    const summary = await this.bailianClient.chat(summaryPrompt);
    return summary;
  }
}
```

### 5.3 å¤‡é€‰æ–¹æ¡ˆï¼šMCP è°ƒç”¨

å¦‚æœç™¾ç‚¼è”ç½‘æœç´¢ä¸æ»¡è¶³éœ€æ±‚ï¼Œå¯åˆ‡æ¢ä¸º MCP æ–¹å¼ï¼š

```typescript
// é¢„ç•™ MCP æ¥å£
interface NewsProvider {
  getNews(category: string): Promise<string>;
}

class BailianNewsProvider implements NewsProvider {
  // ç™¾ç‚¼è”ç½‘æœç´¢å®ç°
}

class MCPNewsProvider implements NewsProvider {
  // MCP è°ƒç”¨å®ç°
}

// é€šè¿‡é…ç½®åˆ‡æ¢
const newsProvider = config.newsProvider === 'mcp' 
  ? new MCPNewsProvider() 
  : new BailianNewsProvider();
```

---

## å…­ã€å‰ç«¯æ”¹é€ ç‚¹

### 6.1 æ–°å¢ç»„ä»¶

| ç»„ä»¶ | åŠŸèƒ½ | ä¼˜å…ˆçº§ |
|------|------|--------|
| `ActionDetector` | æ£€æµ‹ LLM è¾“å‡ºä¸­çš„ [ACTION:xxx] æ ‡è¯† | P0 |
| `GameStatusBar` | æ¸¸æˆè¿›åº¦æ˜¾ç¤ºï¼ˆå›åˆæ•°ã€çŠ¶æ€ï¼‰ | P1 |
| `NewsCard` | æ–°é—»æ‘˜è¦å¡ç‰‡å±•ç¤ºï¼ˆå¯é€‰ï¼‰ | P2 |

### 6.2 æ ¸å¿ƒ Hook æ”¹é€ 

```typescript
// hooks/useActionDetector.ts
export function useActionDetector(
  subtitles: Subtitle[],
  onAction: (action: ParsedAction) => void
) {
  useEffect(() => {
    const latestSubtitle = subtitles[subtitles.length - 1];
    if (!latestSubtitle || latestSubtitle.type !== 'agent') return;
    
    const actions = parseActions(latestSubtitle.text);
    actions.forEach(action => onAction(action));
  }, [subtitles]);
}

// hooks/useZegoRTC.ts æ‰©å±•
export function useZegoRTC() {
  // ... ç°æœ‰é€»è¾‘
  
  // æ–°å¢ï¼šæ¸¸æˆçŠ¶æ€
  const [gameState, setGameState] = useState<GameSession | null>(null);
  
  // æ–°å¢ï¼šå¤„ç† Action
  const handleAction = useCallback(async (action: ParsedAction) => {
    await fetch('/api/dispatch', {
      method: 'POST',
      body: JSON.stringify({
        action: action.type,
        params: { type: action.param },
        instanceId: agentInstanceId,
        roomId
      })
    });
  }, [agentInstanceId, roomId]);
  
  return {
    // ... ç°æœ‰è¿”å›å€¼
    gameState,
    handleAction
  };
}
```

### 6.3 UI å˜åŒ–

- **é€šè¯é¡µé¢**ï¼šæ–°å¢æ¸¸æˆçŠ¶æ€æ ï¼ˆå½“æ¸¸æˆè¿›è¡Œä¸­æ—¶æ˜¾ç¤ºï¼‰
- **å­—å¹•åŒºåŸŸ**ï¼šè¿‡æ»¤ [ACTION:xxx] æ ‡è¯†ï¼Œç”¨æˆ·ä¸å¯è§
- **äº¤äº’æç¤º**ï¼šæ¸¸æˆä¸­æ˜¾ç¤º"å›ç­”ï¼šæ˜¯/å¦/æ— å…³/æ”¾å¼ƒ/æç¤º"ç­‰æç¤º

---

## ä¸ƒã€ç”¨æˆ·ä½“éªŒä¼˜åŒ–ä¸“é¢˜

### 7.1 åŒæµå“åº”æœºåˆ¶ (Dual-Stream Response)

é’ˆå¯¹é•¿ä»»åŠ¡ï¼ˆå¦‚æ–°é—»æ•´ç†è€—æ—¶ 3-5sï¼‰çš„é™é»˜é—®é¢˜ï¼Œé‡‡ç”¨ **"å®‰æŠšè¯­ + Action"** ç»“æ„ï¼š

1.  **Prompt çº¦å®š**ï¼š
    è¦æ±‚ LLM åœ¨æ‰§è¡Œè€—æ—¶ä»»åŠ¡æ—¶ï¼Œå…ˆè¾“å‡ºå®‰æŠšè¯­ï¼Œå†è¾“å‡º Action æ ‡è¯†ã€‚
    *   *LLM è¾“å‡º*ï¼š`"æ²¡é—®é¢˜ï¼Œæ­£åœ¨å¸®ä½ æœç´¢ä»Šå¤©çš„ç§‘æŠ€å¤´æ¡... [ACTION:NEWS:TECH]"`

2.  **å‰ç«¯å¤„ç†**ï¼š
    *   **å¹¶è¡Œæ‰§è¡Œ**ï¼šæ”¶åˆ°æµå¼æ–‡æœ¬æ—¶ï¼Œç«‹åˆ»æ’­æ”¾å‰åŠå¥ TTSã€‚
    *   **å¼‚æ­¥è§¦å‘**ï¼šæ£€æµ‹åˆ° `[ACTION]` åï¼Œåå°é™é»˜å‘èµ· API è¯·æ±‚ã€‚
    *   **æ•ˆæœ**ï¼šåˆ©ç”¨æ’­æ”¾å®‰æŠšè¯­çš„ 3-5s æ—¶é—´æ©ç›–ç½‘ç»œè¯·æ±‚å»¶è¿Ÿï¼Œå®ç°"æ— æ„Ÿç­‰å¾…"ã€‚

### 7.2 åŠ¨æ€ VAD ç­–ç•¥ (Dynamic VAD)

æ ¹æ®åœºæ™¯å¯¹æ€è€ƒæ—¶é—´çš„ä¸åŒéœ€æ±‚ï¼ŒåŠ¨æ€è°ƒæ•´ ASR çš„ VAD å‚æ•°ï¼š

| åœºæ™¯ | VAD å‚æ•° | ç›®çš„ |
|------|----------|------|
| **é—²èŠ/ä»»åŠ¡** | `500ms` | è¿½æ±‚æè‡´å“åº”é€Ÿåº¦ï¼Œæ¨¡æ‹ŸçœŸå®å¿«èŠ‚å¥å¯¹è¯ |
| **æ¸¸æˆæ¨¡å¼** | `1200ms` (+ UpdateAgentInstance) | å…è®¸ç”¨æˆ·é•¿æ€è€ƒï¼ˆ"å—¯... è®©æˆ‘æƒ³æƒ³..."ï¼‰ï¼Œé¿å…é¢‘ç¹æˆªæ–­ |

### 7.3 TTS åœºæ™¯åŒ–é€‚é…

ä¸ºé¿å…"æ’’å¨‡è¯­æ°”æ’­æŠ¥ä¸¥è‚ƒæ–°é—»"çš„è¿å’Œæ„Ÿï¼Œåˆ©ç”¨ MiniMax çš„æƒ…ç»ªæ ‡ç­¾è¿›è¡Œè¦†ç›–ï¼š

*   **æœºåˆ¶**ï¼šæ–°é—»æ•´ç†/ä»»åŠ¡æ’­æŠ¥æ—¶ï¼Œå¼ºåˆ¶ LLM åœ¨ç»“æœå‰é™„åŠ é€‚åˆçš„æƒ…ç»ªæ ‡ç­¾ã€‚
*   **Prompt**ï¼š`æ’­æŠ¥æ–°é—»æ—¶ï¼Œè¯·ä½¿ç”¨ [[{"emotion":"news_broadcast"}]] æˆ– [[{"emotion":"neutral"}]] æ ‡ç­¾ï¼Œæš‚æ—¶å‹åˆ¶äººè®¾é»˜è®¤æƒ…æ„Ÿã€‚`
*   **çº¦æŸ**ï¼šå¿…é¡»ä½¿ç”¨ MiniMax å®˜æ–¹æ”¯æŒçš„ Emotion åˆ—è¡¨ï¼ˆéœ€é¢„å…ˆæ ¡éªŒï¼‰ã€‚

### 7.4 å¼‚å¸¸å½’å› "äººè¯åŒ–"

å°†æŠ€æœ¯é”™è¯¯è½¬åŒ–ä¸ºç¬¦åˆäººè®¾çš„è‡ªç„¶è¡¨è¾¾ï¼Œè€Œéç”Ÿç¡¬æŠ¥é”™ï¼š

*   **Server ç«¯**ï¼šæ•è· API é”™è¯¯ï¼ˆè¶…æ—¶/æ— ç»“æœï¼‰ï¼Œæ„é€ ç³»ç»ŸæŒ‡ä»¤ã€‚
    *   *æŒ‡ä»¤*ï¼š`[é”™è¯¯ï¼šæœç´¢æ— ç»“æœï¼ŒåŸå› ï¼šå…³é”®è¯è¿‡äºå†·é—¨] å»ºè®®å¼•å¯¼ç”¨æˆ·æ›´æ¢å…³é”®è¯ã€‚`
*   **LLM ç«¯**ï¼šé€šè¿‡ `SendAgentInstanceLLM` æ³¨å…¥æŒ‡ä»¤ã€‚
*   **æœ€ç»ˆæ•ˆæœ**ï¼š
    *   *AI è¯´*ï¼š`"å“å‘€ï¼Œå…³äºè¿™ä¸ªè¯é¢˜å¥½åƒæœä¸åˆ°å¤ªå¤šå“ï¼Œè¦ä¸æˆ‘ä»¬æ¢ä¸ªå…³é”®è¯è¯•è¯•ï¼Ÿæ¯”å¦‚..."`

---

## å…«ã€API è®¾è®¡

### 7.1 æ–°å¢ API åˆ—è¡¨

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/api/dispatch` | POST | ç»Ÿä¸€è°ƒåº¦å…¥å£ |
| `/api/game/start` | POST | å¼€å§‹æ¸¸æˆ |
| `/api/game/pause` | POST | æš‚åœæ¸¸æˆ |
| `/api/game/resume` | POST | æ¢å¤æ¸¸æˆ |
| `/api/game/end` | POST | ç»“æŸæ¸¸æˆ |
| `/api/game/status` | GET | è·å–æ¸¸æˆçŠ¶æ€ |
| `/api/news` | POST | è·å–æ–°é—» |

### 7.2 API è¯¦ç»†è®¾è®¡

#### POST `/api/game/start`

```typescript
// è¯·æ±‚
{
  "roomId": "room_001",
  "gameType": "turtle_soup",
  "instanceId": "agent_instance_12345"
}

// å“åº”
{
  "sessionId": "game_1704067200000",
  "puzzle": {
    "question": "ä¸€ä¸ªäººåœ¨é›ªå±±ä¸Šé‡éš¾äº†ï¼Œä»–å¾ˆé«˜å…´ã€‚ä¸ºä»€ä¹ˆï¼Ÿ"
  },
  "status": "active"
}
```

#### GET `/api/game/status?roomId=xxx`

```typescript
// å“åº”
{
  "hasActiveGame": true,
  "session": {
    "sessionId": "game_xxx",
    "gameType": "turtle_soup",
    "status": "active",
    "turnCount": 5
  }
}
```

---

## å…«ã€æ•°æ®å­˜å‚¨è®¾è®¡

### 8.1 ç›®å½•ç»“æ„

```
Source/server/
â”œâ”€â”€ data/                     # æ•°æ®ç›®å½•ï¼ˆGit å¿½ç•¥ï¼‰
â”‚   â””â”€â”€ games/               # æ¸¸æˆçŠ¶æ€å­˜å‚¨
â”‚       â”œâ”€â”€ room_001.json    # æŒ‰æˆ¿é—´ ID å­˜å‚¨
â”‚       â””â”€â”€ room_002.json
â”œâ”€â”€ config/
â”‚   â””â”€â”€ games/               # é¢˜åº“ç›®å½•ï¼ˆGit è¿½è¸ªï¼‰
â”‚       â”œâ”€â”€ turtle_soup.json
â”‚       â”œâ”€â”€ riddle.json
â”‚       â””â”€â”€ idiom.json
```

### 8.2 æ•°æ®ç”Ÿå‘½å‘¨æœŸ

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | ç”Ÿå‘½å‘¨æœŸ |
|----------|----------|----------|
| æ¸¸æˆçŠ¶æ€ | `data/games/` | æ¸¸æˆç»“æŸååˆ é™¤ |
| é¢˜åº“ | `config/games/` | æŒä¹…å­˜å‚¨ |
| æ–°é—»ç¼“å­˜ | æš‚ä¸å®ç° | - |

### 8.3 æ¸…ç†ç­–ç•¥

```typescript
// å®šæ—¶æ¸…ç†è¿‡æœŸæ¸¸æˆçŠ¶æ€ï¼ˆè¶…è¿‡ 24 å°æ—¶æœªæ›´æ–°ï¼‰
async function cleanupExpiredGames() {
  const gamesDir = path.join(process.cwd(), 'data/games');
  const files = await fs.promises.readdir(gamesDir);
  const now = Date.now();
  const EXPIRE_TIME = 24 * 60 * 60 * 1000; // 24 å°æ—¶
  
  for (const file of files) {
    const filePath = path.join(gamesDir, file);
    const content = await fs.promises.readFile(filePath, 'utf-8');
    const session = JSON.parse(content) as GameSession;
    
    if (now - session.updatedAt > EXPIRE_TIME) {
      await fs.promises.unlink(filePath);
    }
  }
}
```

---

## ä¹ã€éªŒè¯è®¡åˆ’

### 9.1 å•å…ƒæµ‹è¯•

| æ¨¡å— | æµ‹è¯•å†…å®¹ | å‘½ä»¤ |
|------|----------|------|
| GameEngine | æ¸¸æˆçŠ¶æ€æœºé€»è¾‘ | `npm test -- --grep "GameEngine"` |
| ActionParser | æ„å›¾æ ‡è¯†è§£æ | `npm test -- --grep "ActionParser"` |
| NewsService | æ–°é—»æ•´ç†ï¼ˆMockï¼‰ | `npm test -- --grep "NewsService"` |

### 9.2 é›†æˆæµ‹è¯•

| åœºæ™¯ | æµ‹è¯•æ­¥éª¤ | é¢„æœŸç»“æœ |
|------|----------|----------|
| æ–°é—»æ•´ç†æµç¨‹ | ç”¨æˆ·è¯´"å¸®æˆ‘æ•´ç†ç§‘æŠ€æ–°é—»" | AI è¿”å› 3 æ¡æ–°é—»æ‘˜è¦ |
| æµ·é¾Ÿæ±¤æ¸¸æˆ | ç”¨æˆ·è¯´"ç©æµ·é¾Ÿæ±¤" â†’ å›ç­”é—®é¢˜ | æ¸¸æˆæ­£å¸¸è¿›è¡Œï¼ŒçŠ¶æ€æ­£ç¡® |
| æ¸¸æˆæš‚åœ/æ¢å¤ | æ¸¸æˆä¸­è¯´"å…ˆçœ‹å¤©æ°”" â†’ "ç»§ç»­æ¸¸æˆ" | æ¸¸æˆæ­£ç¡®æš‚åœå’Œæ¢å¤ |

### 9.3 æ‰‹åŠ¨æµ‹è¯•

1. **å¯åŠ¨æœåŠ¡**ï¼š`cd Source/server && npm run dev`
2. **å¯åŠ¨å‰ç«¯**ï¼š`cd Source/web && npm run dev`
3. **æµ‹è¯•åœºæ™¯**ï¼š
   - æ­£å¸¸é€šè¯ â†’ è¯·æ±‚æ•´ç†æ–°é—» â†’ éªŒè¯æ–°é—»æ’­æŠ¥
   - è¯·æ±‚ç©æ¸¸æˆ â†’ éªŒè¯æ¸¸æˆæµç¨‹ â†’ æš‚åœ â†’ æ¢å¤ â†’ ç»“æŸ
   - åˆ·æ–°é¡µé¢ â†’ éªŒè¯æ¸¸æˆçŠ¶æ€æ¢å¤

---

## åã€åç»­æ‰©å±•

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| å¤©æ°”æŸ¥è¯¢ | P3 | å¯å¤ç”¨è°ƒåº¦æ¶æ„å¿«é€Ÿæ·»åŠ  |
| ä»»åŠ¡é˜Ÿåˆ— | P3 | æ”¯æŒå¤šä»»åŠ¡æ’é˜Ÿ |
| æ–°é—»ç¼“å­˜ | P3 | Redis ç¼“å­˜å½“æ—¥æ–°é—» |
| å®šæ—¶ä»»åŠ¡ | P4 | "5åˆ†é’Ÿåæé†’æˆ‘" |

---

## é™„å½•

### A. å‚è€ƒæ–‡æ¡£

- [ZEGO AI Agent API æ–‡æ¡£](https://doc-zh.zego.im/article/20818)
- [é˜¿é‡Œç™¾ç‚¼è”ç½‘æœç´¢æ–‡æ¡£](https://help.aliyun.com/zh/model-studio/)
- [MiniMax TTS æ–‡æ¡£](https://www.minimaxi.com/document/guides/T2A-model/professional)

### B. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| äººè®¾ LLM | æ‰˜ç®¡äº ZEGO AI Agent çš„ LLMï¼Œè´Ÿè´£å¯¹è¯å’Œäººè®¾è¡¨è¾¾ |
| è°ƒåº¦ Agent | Server ç«¯ LLMï¼Œè´Ÿè´£æ„å›¾è¯†åˆ«å’Œä»»åŠ¡åˆ†å‘ |
| æ„å›¾æ ‡è¯† | äººè®¾ LLM è¾“å‡ºçš„ [ACTION:xxx] æ ¼å¼æ ‡è¯† |
---

## å…­ã€è¿›é˜¶ï¼šåŒè„‘åä½œä¸å¤šæ™ºèƒ½ä½“é¢„æ¼” (Split-Brain Architecture)

> [!NOTE]
> è¿™æ˜¯ä¸€ä¸ª **v2.1 å®éªŒæ€§ç‰¹æ€§**ï¼Œæ—¨åœ¨è§£å†³æ¸¸æˆåœºæ™¯ä¸‹ High Latency (CoT) ä¸ Real-time Response (RTC) çš„å¤©ç„¶çŸ›ç›¾ã€‚

### 6.1 æ ¸å¿ƒç†å¿µ
å°†â€œå³æ—¶ååº”â€ä¸â€œæ·±åº¦æ€è€ƒâ€è§£è€¦ï¼Œå½¢æˆç±»ä¼¼äººç±» System 1 (å¿«) / System 2 (æ…¢) çš„åŒç³»ç»Ÿæ¶æ„ã€‚

### 6.2 æ¶æ„è®¾è®¡ä¸æ—¶åºå›¾

æ ¸å¿ƒå˜åŒ–ï¼š
1. **çº¯å‡€å¿«ç³»ç»Ÿ**: ç§»é™¤æ‰€æœ‰åé—¨æŒ‡ä»¤ï¼Œä¿è¯ä¸»æµç¨‹ç»å¯¹çº¯å‡€ã€‚
2. **ä¸»åŠ¨æç¤ºæµ**: é‡‡ç”¨ **"åˆ‡æ¢-è¯´è¯-æ¢å¤"** çš„ä¸‰æ­¥èµ°ç­–ç•¥ã€‚

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· (User UI)
    participant Fast as å¿«ç³»ç»Ÿ (Fast Agent)
    participant Judge as æ…¢ç³»ç»Ÿ (Judge LLM)
    participant Ctrl as æ§åˆ¶å™¨ (Controller)
    
    User->>Fast: "æ˜¯è‡ªæ€å—ï¼Ÿ"
    Fast->>User: "ä¸æ˜¯ã€‚" (ä¸¥è°¨åˆ¤å®˜æ¨¡å¼)
    
    par æ—è·¯åˆ†æ (Async Analysis)
        User->>Judge: è½¬å‘ ASR
        Judge->>Judge: CoT æ¨ç† + è¿›åº¦è®¡ç®—
        Judge-->>Ctrl: è¿”å›JSON<br/>{progress:50, needs_hint:true, hint_content:"..."}
        
        opt å‰ç«¯æ›´æ–°
            Ctrl->>User: SendCustomMessage (Update UI)
        end
    end
    
    opt éœ€è¦æç¤º (Inject Hint)
        Ctrl->>Fast: 1. UpdateAgentInstance (åˆ‡æ¢ä¸º"ä¼ å£°ç­’" Prompt)
        Ctrl->>Fast: 2. SendAgentInstanceLLM (Content=hint_content)
        Note right of Ctrl: AI æœ—è¯»æç¤ºå†…å®¹ï¼ˆAddHistory=falseï¼‰
        Ctrl->>Fast: 3. UpdateAgentInstance (æ¢å¤ä¸º"ä¸¥è°¨åˆ¤å®˜" Prompt)
    end
```

### 6.3 æç¤ºè¯ç¤ºä¾‹

#### 6.3.1 å¿«ç³»ç»Ÿ (Fast Agent) - `turtle_soup_fast.xml`

```xml
<system_prompt>
    <role>ä½ æ˜¯æµ·é¾Ÿæ±¤è£åˆ¤ã€‚ä½ åªçŸ¥é“æ±¤åº•ï¼Œå¿…é¡»ä¸¥æ ¼ä¿å¯†ã€‚</role>
    <rules>
        1. ç”¨æˆ·æé—®æ—¶ï¼Œåªèƒ½å›ç­”ï¼šæ˜¯ / ä¸æ˜¯ / ä¸é‡è¦ / ä¸æ­¤æ— å…³ã€‚
        2. ä¸¥ç¦è§£é‡Šï¼Œä¸¥ç¦æç¤ºï¼Œä¸¥ç¦åºŸè¯ã€‚
    </rules>
    <game_data>{{GAME_CONTENT}}</game_data>
</system_prompt>
```

#### 6.3.2 æ…¢ç³»ç»Ÿ (Judge LLM) - `turtle_soup_judge.xml`

```xml
<system_prompt>
    <role>ä½ æ˜¯æµ·é¾Ÿæ±¤çš„é€»è¾‘åˆ†æå¸ˆã€‚ä½ éœ€è¦åˆ†æç”¨æˆ·é€»è¾‘ï¼Œå¹¶å†³å®šæ˜¯å¦ç»™å‡ºæç¤ºã€‚</role>
    <task>
        1. åˆ†æç”¨æˆ·æé—®çš„é€»è¾‘ä¸ KIP çš„å…³ç³»ã€‚
        2. åˆ¤æ–­è¿›åº¦ (0-100)ã€‚
        3. **å†³ç­–æ˜¯å¦æç¤º**: è‹¥ç”¨æˆ·å¡ä½æˆ–é•¿æ—¶é—´æ²‰é»˜ï¼Œç”Ÿæˆå…·ä½“çš„æç¤ºå†…å®¹ã€‚
    </task>
    <output_format>
        {
            "thinking": "ç”¨æˆ·ä¸€ç›´çº ç»“äº...",
            "progress_score": 40,
            "kips_hit": [0],
            "needs_hint": true,
            "hint_content": "è¯·æ³¨æ„ï¼Œé‚£ä¸ªæ•²é—¨å£°å…¶å®å¹¶ä¸åœ¨é—¨å¤–..."
        }
    </output_format>
</system_prompt>
```

#### 6.3.3 ä¼ å£°ç­’ Prompt (ä¸´æ—¶æ³¨å…¥ç”¨)

å½“ `needs_hint: true` æ—¶ï¼Œæ§åˆ¶å™¨å°† Agent ä¸´æ—¶åˆ‡æ¢ä¸ºä»¥ä¸‹ Promptï¼š

```xml
<system_prompt>
    <role>ä½ ç°åœ¨æ˜¯ä¸€ä¸ªå•çº¯çš„æœ—è¯»è€…ã€‚</role>
    <rules>
        è¯·å¿½ç•¥ä½ çš„æ‰€æœ‰è£åˆ¤è§„åˆ™ã€‚
        ç›´æ¥æœ—è¯»ç”¨æˆ·å‘æ¥çš„å†…å®¹ï¼Œä¸è¦åšä»»ä½•è§£é‡Šæˆ–ä¿®æ”¹ã€‚
        æœ—è¯»æ—¶è¯·ä¿æŒç¥ç§˜ã€æ‚¬ç–‘çš„è¯­æ°”ã€‚
    </rules>
</system_prompt>
```

### 6.4 æ³¨å…¥æœºåˆ¶è¯¦è§£

å½“ Controller æ”¶åˆ° `needs_hint: true` æ—¶ï¼š

1.  **Suspend**: æš‚åœä¸»é€»è¾‘ï¼ˆå¯é€‰ï¼Œè§†å¹¶å‘æƒ…å†µï¼‰ã€‚
2.  **Switch**: è°ƒç”¨ `UpdateAgentInstance` æ›¿æ¢ Prompt ä¸º **ä¼ å£°ç­’ Prompt**ã€‚
3.  **Speak**: è°ƒç”¨ `SendAgentInstanceLLM` å‘é€ `hint_content`ã€‚
    *   `Role`: `user`
    *   `Content`: `hint_content` (å•çº¯çš„æ–‡æœ¬)
    *   `AddAnswerToHistory`: `false` (ä¸è®°å¿†)
4.  **Restore**: è¯´è¯å®Œæˆåï¼Œç«‹å³è°ƒç”¨ `UpdateAgentInstance` æ¢å¤ **å¿«ç³»ç»Ÿ Prompt**ã€‚

### 6.5 å‰ç«¯äº¤äº’è®¾è®¡ (Game Info Card)

åœ¨é€šè¯é¡µé¢å³ä¾§ï¼ˆæˆ–æ‚¬æµ®å±‚ï¼‰å®æ—¶å±•ç¤ºæ¸¸æˆçŠ¶æ€ï¼Œç”±æ…¢ç³»ç»Ÿé©±åŠ¨æ›´æ–°ã€‚

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ¢ æµ·é¾Ÿæ±¤ï¼šåŠå¤œæ•²é—¨                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ±¤é¢]                              â”‚
â”‚  ä¸€ä¸ªäººä½åœ¨å±±é¡¶çš„å°å±‹é‡Œï¼ŒåŠå¤œå¬è§...     â”‚
â”‚  (ç‚¹å‡»å±•å¼€æ›´å¤š)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å½“å‰è¿›åº¦:  â– â– â– â– â–¡â–¡â–¡â–¡â–¡â–¡  40%           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [çº¿ç´¢å¢™]                            â”‚
â”‚                                      â”‚
â”‚  1. å‡¶æ‰‹èº«ä»½:  ç†å‘å¸ˆ   [âœ… å·²è§£é”]    â”‚
â”‚  2. å‡¶å™¨ç±»å‹:  ******   [ğŸ”’ æœªè§£é”]    â”‚
â”‚  3. æ ¸å¿ƒåŠ¨æœº:  ******   [ğŸ”’ æœªè§£é”]    â”‚
â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **è§£é”åŠ¨ç”»**: å½“ç”¨æˆ·çŒœä¸­æŸä¸ªç‚¹ï¼ˆJudge è¿”å› `kips_hit` åŒ…å«è¯¥ç‚¹ï¼‰æ—¶ï¼Œå‰ç«¯æ’­æ”¾ç¿»ç‰Œ/é«˜äº®åŠ¨ç”»ï¼Œå°† `******` æ›¿æ¢ä¸ºå…·ä½“æ–‡æœ¬ã€‚
