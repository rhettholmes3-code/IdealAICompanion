# 测试用例

## 1. 测试概览

### 1.1 测试目标
- 验证所有功能符合 PRD 需求
- 确保 UI/UX 符合设计规范
- 保证跨浏览器兼容性
- 验证性能和稳定性
- 确保异常场景处理正确

### 1.2 测试环境

#### 浏览器支持
- Chrome 100+ (桌面 + 移动)
- Safari 15+ (桌面 + 移动)
- Firefox 100+
- Edge 100+

#### 设备
- 桌面: macOS, Windows
- 移动: iOS 15+, Android 10+

#### 网络环境
- 4G/5G 移动网络
- Wi-Fi
- 弱网环境 (模拟)

---

## 2. 功能测试用例

### 2.1 创建通话页面

#### TC-F-001: 页面加载
**前置条件**: 无  
**测试步骤**:
1. 在浏览器中打开应用 URL
2. 等待页面加载完成

**预期结果**:
- ✅ 背景图正确显示 (小叶形象)
- ✅ 通话按钮显示在底部居中
- ✅ 设置按钮显示在右上角
- ✅ 通话按钮有脉冲发光动画
- ✅ 页面加载时间 < 3 秒

---

#### TC-F-002: 点击通话按钮
**前置条件**: 页面已加载  
**测试步骤**:
1. 点击底部的通话按钮
2. 观察页面切换

**预期结果**:
- ✅ 页面切换到通话页面
- ✅ 过渡动画流畅 (0.3s)
- ✅ 浏览器请求麦克风权限

---

#### TC-F-003: 点击设置按钮
**前置条件**: 页面已加载  
**测试步骤**:
1. 点击右上角设置按钮

**预期结果**:
- ✅ 显示 Toast 提示 "设置功能开发中..."
- ✅ Toast 3 秒后自动消失

---

### 2.2 通话页面 - 基础功能

#### TC-F-004: 进入通话页面
**前置条件**: 点击通话按钮  
**测试步骤**:
1. 授权麦克风权限
2. 等待通话建立

**预期结果**:
- ✅ 左上角显示亲密度徽章 "🌿 Lv.2 熟悉"
- ✅ 情绪标签显示 "💭 好奇"
- ✅ AI 名称显示 "小叶"
- ✅ Agent 状态显示 "👂 倾听中..."
- ✅ 右上角显示更多按钮
- ✅ 底部显示控制区 (麦克风 + 挂断按钮)
- ✅ 音浪区域显示在控制区上方

---

#### TC-F-005: AI 欢迎语
**前置条件**: 通话已建立  
**测试步骤**:
1. 等待 AI 主动说话
2. 观察字幕和音频

**预期结果**:
- ✅ 3 秒内听到 AI 欢迎语音频
- ✅ 字幕区显示 AI 消息 (左对齐，毛玻璃气泡)
- ✅ Agent 状态切换为 "💬 说话中"
- ✅ 音浪动画跟随 AI 语音波动

---

#### TC-F-006: 用户说话
**前置条件**: 通话已建立，麦克风已开启  
**测试步骤**:
1. 对着麦克风说话
2. 观察 UI 变化

**预期结果**:
- ✅ 音浪动画实时变化 (纵波效果，10 条高度不同)
- ✅ Agent 状态显示 "👂 倾听中..."
- ✅ 说话结束后，字幕区显示用户消息 (右对齐，蓝色渐变气泡)
- ✅ ASR 识别准确率 > 90%

---

#### TC-F-007: AI 回复
**前置条件**: 用户已说话  
**测试步骤**:
1. 等待 AI 回复
2. 观察字幕和音频

**预期结果**:
- ✅ Agent 状态切换 "🧠 思考中" → "💬 说话中"
- ✅ **状态通过房间信令获取**，自动同步，无需前端猜测
- ✅ 字幕流式展示 (带闪烁光标)
- ✅ **字幕中包含情绪标签**（如 [happy] 你好呀）
- ✅ **听到的语音不包含情绪标签**（TTS 已过滤）
- ✅ **前端解析情绪标签**，更新情绪 UI 为 "😄 开心"
- ✅ **显示的字幕移除了情绪标签**（如 "你好呀"）
- ✅ 回复响应时间 < 3 秒

---

### 2.3 通话页面 - 交互功能

#### TC-F-008: 麦克风开关
**前置条件**: 通话已建立  
**测试步骤**:
1. 点击麦克风按钮
2. 观察状态变化
3. 再次点击恢复

**预期结果**:
- ✅ 第一次点击: 图标变为 `mic_off`，标签显示 "已静音"，按钮背景变红
- ✅ 音浪动画停止
- ✅ 第二次点击: 图标恢复 `mic`，标签显示 "麦克风"，背景恢复
- ✅ 音浪动画恢复

---

#### TC-F-009: 挂断通话
**前置条件**: 通话进行中  
**测试步骤**:
1. 点击红色挂断按钮
2. 观察页面变化

**预期结果**:
- ✅ 页面切换回创建通话页面
- ✅ 过渡动画流畅
- ✅ 后端销毁 Agent 实例
- ✅ WebSocket 连接断开

---

#### TC-F-010: 字幕手动滚动
**前置条件**: 字幕区有多条消息  
**测试步骤**:
1. 向上滚动字幕区查看历史消息
2. 等待新消息到达
3. 滚动到底部

**预期结果**:
- ✅ 向上滚动后，新消息不自动滚动到底部
- ✅ 手动滚动到底部后，新消息恢复自动滚动
- ✅ 历史消息正确显示 (支持消息持久化)

---

### 2.4 高级功能

#### TC-F-011: AI 主动问候
**前置条件**: 通话已建立  
**测试步骤**:
1. 保持沉默 3 秒
2. 继续沉默至 10 秒
3. 继续沉默至 30 秒
4. 之后每 30 秒观察一次

**预期结果**:
- ✅ 沉默 3s 时，AI 第一次主动问候
- ✅ 沉默 10s 时，AI 第二次主动问候
- ✅ 沉默 30s 时，AI 第三次主动问候
- ✅ 之后每 30s，AI 持续问候
- ✅ 计时规则：从 AI 说话结束开始计时

---

#### TC-F-012: 断线重连
**前置条件**: 通话进行中  
**测试步骤**:
1. 关闭页面
2. 30 秒内重新打开页面
3. 等待 90 秒后重新打开页面

**预期结果**:
- ✅ 30 秒内返回：通话恢复，历史消息显示
- ✅ 90 秒后返回：Agent 实例已销毁，需重新创建

---

#### TC-F-013: 情绪标签透传
**前置条件**: 通话进行中  
**测试步骤**:
1. 触发 AI 回复
2. 检查字幕消息原始数据
3. 检查 TTS 语音
4. 检查前端情绪 UI
5. 检查显示的字幕文本

**预期结果**:
- ✅ 字幕原始数据包含情绪标签（如 `[happy] 你好呀`）
- ✅ TTS 语音无情绪标签朗读（过滤成功）
- ✅ 前端正确解析情绪（`emotion: 'happy'`）
- ✅ 情绪 UI 更新（显示 "😄 开心"）
- ✅ 显示的字幕不包含 `[happy]`（已清洗）

---

#### TC-F-014: Agent 状态信令
**前置条件**: 通话进行中  
**测试步骤**:
1. 观察 Agent 状态变化
2. 检查状态数据来源

**预期结果**:
- ✅ 用户说话时：状态自动切换 idle → listening
- ✅ AI 思考时：状态自动切换 listening → thinking
- ✅ AI 说话时：状态自动切换 thinking → speaking
- ✅ **状态通过房间信令获取**（`roomExtraInfoUpdate` 事件）
- ✅ 状态切换延迟 < 200ms

---

### 2.5 异常处理

#### TC-F-013: 麦克风权限拒绝
**前置条件**: 无  
**测试步骤**:
1. 点击通话按钮
2. 拒绝麦克风权限

**预期结果**:
- ✅ 显示 Toast 错误提示 "需要麦克风权限才能通话"
- ✅ 提示如何在浏览器设置中开启权限
- ✅ 返回创建通话页面

---

#### TC-F-014: 网络断开
**前置条件**: 通话进行中  
**测试步骤**:
1. 断开网络连接
2. 观察 UI 反馈
3. 恢复网络

**预期结果**:
- ✅ 显示 Toast "网络连接已断开"
- ✅ Agent 状态显示异常图标
- ✅ 网络恢复后自动重连
- ✅ 显示 Toast "网络已恢复"

---

#### TC-F-015: LLM 超时
**前置条件**: 通话进行中  
**测试步骤**:
1. 模拟 LLM API 超时 (> 10s)
2. 观察 UI 反馈

**预期结果**:
- ✅ Agent 状态显示 "思考中" 超过 5s 后
- ✅ 显示 Toast "AI 响应超时，请重试"
- ✅ 可以继续说话触发新的回复

---

#### TC-F-016: ZEGO SDK 错误
**前置条件**: 通话进行中  
**测试步骤**:
1. 触发 ZEGO SDK 错误 (如房间满员)
2. 观察错误处理

**预期结果**:
- ✅ 显示 Toast 包含错误码和描述
- ✅ 例如: "错误 1002001: 房间已满"
- ✅ 提供相应的操作建议

---

## 3. UI/UX 测试用例

### 3.1 视觉设计

#### TC-UI-001: 毛玻璃风格
**验证点**:
- ✅ 所有面板使用毛玻璃效果 (backdrop-filter: blur)
- ✅ 边框颜色: rgba(255, 255, 255, 0.12)
- ✅ 背景颜色: rgba(15, 23, 42, 0.6)

---

#### TC-UI-002: 色彩规范
**验证点**:
- ✅ 主色调: 蓝紫渐变 (#60A5FA → #A78BFA)
- ✅ 背景暗色: #0F172A
- ✅ AI 消息气泡: rgba(30, 41, 59, 0.85)
- ✅ 用户消息气泡: 蓝色渐变 (#3B82F6 → #60A5FA)

---

#### TC-UI-003: 字体规范
**验证点**:
- ✅ 全局字体: Noto Sans SC
- ✅ AI 名称: 18px, font-weight: 600
- ✅ 状态文字: 12px
- ✅ 消息文字: 13px, line-height: 1.5

---

#### TC-UI-004: 图标规范
**验证点**:
- ✅ 使用 Material Symbols Outlined
- ✅ 状态图标: call, mic, mic_off, call_end, settings, more_horiz
- ✅ 图标大小与设计稿一致

---

### 3.2 响应式布局

#### TC-UI-005: 移动端适配 (390px 宽度)
**预期结果**:
- ✅ 所有元素正确显示，无横向滚动
- ✅ 字幕区自适应高度
- ✅ 按钮大小适合触摸 (最小 44x44 px)

---

#### TC-UI-006: 桌面端适配 (> 768px 宽度)
**预期结果**:
- ✅ 容器最大宽度 390px，居中显示
- ✅ 布局比例保持一致

---

### 3.3 动画效果

#### TC-UI-007: 通话按钮动画
**验证点**:
- ✅ 脉冲发光动画 (2s 循环)
- ✅ 点击时缩放效果 (scale 0.95)

---

#### TC-UI-008: 音浪动画
**验证点**:
- ✅ 静默时显示细线 (高度 2px)
- ✅ 有声音时纵波扩展 (最大 48px)
- ✅ 10 条音浪高度不同，形成波形
- ✅ 动画帧率 > 30 FPS

---

#### TC-UI-009: 状态切换动画
**验证点**:
- ✅ 页面切换过渡: 0.3s ease
- ✅ 消息出现动画: 淡入 + 向上滑动
- ✅ 状态点呼吸动画 (1.5s 循环)

---

### 3.4 交互反馈

#### TC-UI-010: 按钮点击反馈
**验证点**:
- ✅ 所有按钮点击时有缩放效果
- ✅ 无延迟感 (< 100ms)

---

#### TC-UI-011: Toast 提示
**验证点**:
- ✅ 从顶部滑入 (0.3s)
- ✅ 显示 3 秒后自动消失
- ✅ 错误提示使用红色背景

---

## 4. 性能测试用例

### 4.1 加载性能

#### TC-P-001: 首屏加载时间
**预期结果**:
- ✅ LCP (Largest Contentful Paint) < 2.5s
- ✅ FID (First Input Delay) < 100ms
- ✅ CLS (Cumulative Layout Shift) < 0.1

---

#### TC-P-002: 资源加载
**预期结果**:
- ✅ ZEGO SDK 文件大小 < 1 MB
- ✅ 背景图片优化 (WebP 格式，< 200 KB)
- ✅ 字体文件懒加载

---

### 4.2 运行性能

#### TC-P-003: 音频延迟
**预期结果**:
- ✅ 端到端延迟 < 500ms (国内网络)
- ✅ 音频卡顿率 < 1%

---

#### TC-P-004: 内存使用
**预期结果**:
- ✅ 通话 30 分钟后，内存增长 < 100 MB
- ✅ 无明显内存泄漏

---

#### TC-P-005: CPU 使用
**预期结果**:
- ✅ 空闲时 CPU < 5%
- ✅ 通话时 CPU < 30% (移动设备)

---

### 4.3 弱网优化

#### TC-P-006: 4G 网络
**预期结果**:
- ✅ 通话正常建立
- ✅ 音频清晰无断续

---

#### TC-P-007: 弱网环境 (模拟 50% 丢包)
**预期结果**:
- ✅ 自动降低码率
- ✅ 音频仍可理解 (可接受的质量损失)
- ✅ 显示弱网提示

---

## 5. 兼容性测试用例

### 5.1 浏览器兼容性

#### TC-C-001: Chrome (桌面)
**验证版本**: Chrome 100+  
**预期结果**: ✅ 所有功能正常

---

#### TC-C-002: Safari (桌面)
**验证版本**: Safari 15+  
**预期结果**: ✅ 所有功能正常

---

#### TC-C-003: Firefox
**验证版本**: Firefox 100+  
**预期结果**: ✅ 所有功能正常

---

#### TC-C-004: Edge
**验证版本**: Edge 100+  
**预期结果**: ✅ 所有功能正常

---

#### TC-C-005: Chrome (移动)
**验证版本**: Chrome Android 100+  
**预期结果**: ✅ 所有功能正常，触摸交互流畅

---

#### TC-C-006: Safari (移动)
**验证版本**: Safari iOS 15+  
**预期结果**: ✅ 所有功能正常，麦克风权限正常

---

### 5.2 设备兼容性

#### TC-C-007: iOS 设备
**验证设备**: iPhone 12 及以上  
**预期结果**:
- ✅ 布局适配正确
- ✅ 音频采集和播放正常
- ✅ 无刘海遮挡问题

---

#### TC-C-008: Android 设备
**验证设备**: Android 10 及以上  
**预期结果**:
- ✅ 布局适配正确
- ✅ 音频采集和播放正常
- ✅ 各品牌手机兼容 (华为、小米、OPPO)

---

## 6. 集成测试用例

### 6.1 前后端集成

#### TC-I-001: Token 生成
**验证流程**:
1. 前端请求 `/api/auth/token`
2. 后端生成 Token
3. 前端使用 Token 登录房间

**预期结果**:
- ✅ Token 格式正确
- ✅ Token 有效期 24 小时
- ✅ 前端能成功登录

---

#### TC-I-002: Agent 注册
**验证流程**:
1. 后端调用 ZEGO AI Agent API
2. 注册智能体 "xiaoye_v1"
3. 验证注册成功

**预期结果**:
- ✅ AgentId 返回正确
- ✅ LLM/TTS 配置正确

---

#### TC-I-003: Agent 实例创建
**验证流程**:
1. 前端请求 `/api/agent/create`
2. 后端创建 Agent 实例
3. Agent 加入房间并推流

**预期结果**:
- ✅ AgentInstanceId 返回
- ✅ 前端能拉取 Agent 流

---

#### TC-I-004: Agent 实例销毁
**验证流程**:
1. 用户挂断
2. 前端请求 `/api/agent/destroy`
3. 后端销毁实例

**预期结果**:
- ✅ 实例销毁成功
- ✅ 资源释放

---

### 6.2 ZEGO 服务集成

#### TC-I-005: Express SDK 推流
**验证流程**:
1. 用户加入房间
2. 开启麦克风
3. 推流到 ZEGO 服务器

**预期结果**:
- ✅ 推流成功
- ✅ 流 ID 正确

---

#### TC-I-006: 字幕组件集成
**验证流程**:
1. 使用 ZEGO 字幕处理类
2. 监听字幕事件
3. 显示字幕

**预期结果**:
- ✅ 字幕实时更新
- ✅ 历史消息持久化

---

## 7. 回归测试检查清单

在每次迭代后执行以下核心功能检查：

- [ ] 创建通话页面正常显示
- [ ] 点击通话按钮能进入通话
- [ ] 听到 AI 欢迎语
- [ ] 用户说话能被识别并显示字幕
- [ ] AI 回复正常
- [ ] 麦克风开关正常
- [ ] 挂断能返回首页
- [ ] 音浪动画正常
- [ ] 字幕滚动正常
- [ ] 移动端布局正确

---

## 8. 测试报告模板

### 测试执行记录

| 用例编号 | 用例名称 | 执行结果 | 缺陷ID | 备注 |
|---------|---------|---------|-------|------|
| TC-F-001 | 页面加载 | ✅ PASS | - | - |
| TC-F-002 | 点击通话按钮 | ❌ FAIL | BUG-001 | 过渡动画卡顿 |
| ... | ... | ... | ... | ... |

### 缺陷跟踪

| 缺陷ID | 标题 | 严重程度 | 状态 | 修复版本 |
|-------|------|---------|------|---------|
| BUG-001 | 页面过渡动画卡顿 | 中 | 已修复 | v0.1.1 |

---

## 附录

### A. 测试数据

- **测试房间ID**: `test_room_001`
- **测试用户ID**: `test_user_001`
- **测试 Agent ID**: `xiaoye_v1`

### B. 测试工具

- **浏览器调试**: Chrome DevTools
- **网络模拟**: Chrome DevTools > Network > Throttling
- **性能监控**: Lighthouse
- **兼容性测试**: BrowserStack
- **API 测试**: Postman

### C. 自动化测试 (未来规划)

- 使用 Playwright 进行 E2E 测试
- 使用 Jest + React Testing Library 进行单元测试
- CI/CD 集成自动化测试
