# 开发计划

## 1. 项目信息

**项目名称**: 理想 AI 伴侣 H5 App  
**代号**: IdealAICompanion  
**预计工期**: 2-3 周  
**开发模式**: 个人项目，迭代开发

---

## 2. 开发阶段规划

### 阶段一：环境搭建与基础集成 (3-4 天)

#### 任务 1.1: 初始化项目结构
- [x] 创建 Source 目录
- [x] 初始化 React 前端项目 (Vite + TypeScript + Tailwind CSS)
  ```bash
  cd Source
  npm create vite@latest web -- --template react-ts
  cd web
  npm install
  npm install -D tailwindcss postcss autoprefixer
  npx tailwindcss init -p
  ```
- [x] 初始化 Next.js 后端项目
  ```bash
  cd Source
  npx create-next-app@latest server --typescript --app --no-src-dir
  ```
- [x] 配置 Tailwind CSS
  - [x] 更新 `tailwind.config.js`
  - [x] 配置 `index.css` (适配 v4 语法)
  - [x] 参考 Prototype 中的毛玻璃风格，转换为 Tailwind 类

**验证**: 运行 `npm run dev`，访问 `http://localhost:5173` 正常

#### 任务 1.2: ZEGO SDK 集成
- [x] 下载 ZEGO Express SDK (AI Agent 优化版本)
  - 访问 [下载页面](https://doc-zh.zego.im/aiagent-web/introduction/download)
- [x] 通过 npm 安装 SDK
- [x] 下载 ZEGO 字幕处理类
  - [x] 放置到 `Source/web/src/lib/zego-subtitle.ts`
- [x] 创建 RTC Hook: `src/hooks/useZegoRTC.ts`

**验证**: 在 React 组件中成功导入并初始化 SDK

#### 任务 1.3: ZEGO AI Agent API 客户端封装
- [x] 实现 `lib/zego.ts` (API 封装)
  - [x] `generateSignature()`: API 签名
  - [x] `sendRequest()`: 通用请求方法
  - [x] `RegisterAgent` 路由实现
  - [x] `CreateAgentInstance` 路由实现
- [x] `destroyAgentInstance()`: 销毁实例

**验证**: 通过 Postman 测试 `/api/agent/register` 接口成功

---

---

### 阶段二：多智能体支持与 Prompt 优化 (已完成 ✅)

#### 任务 2.1: Server 端多智能体架构重构（待开发）
- [x] 创建 `Source/server/config/agents/` 目录
- [x] 迁移现有 `agent-config.json` 到 `config/agents/xiaoye.json`
- [x] 扩展配置加载逻辑，支持扫描目录加载多个智能体
- [x] 增加 `GET /api/agents` 接口，返回可用智能体列表
- [x] 更新 `POST /api/agent/create` 接口，支持接收 `agentId` 参数

#### 任务 2.2: Prompt 模板迁移（待开发）
- [x] 将 `source/server/config/prompts/xiaoye.xml` 内容直接合并入 `xiaoye.json` 的 `systemPrompt` 字段
- [x] 移除 `prompt-manager.ts` 中对文件读取的依赖，改为从配置对象中通过 key 读取
- [x] 确保动态变量替换逻辑依然可用

#### 任务 2.3: 前端多智能体选择（待开发）
- [x] `CreateCallPage` 增加“设置”按钮
- [x] 实现设置弹窗/面板，调用 `/api/agents` 获取列表
- [x] 实现切换智能体逻辑：
  - 更新全局状态（当前选中的 agentId）
  - 联动更新背景图
- [x] 更新 `startCall` 逻辑，传递选中的 `agentId`

#### 任务 2.4: 验证与测试
- [x] 验证 `/api/agents` 返回数据格式正确
- [x] 验证切换智能体后背景图更新及时
- [x] 验证通话时加载的是对应智能体的配置 (Prompt, 音色)

---

### 阶段三: Agent 配置与 Prompt 设计 (已完成)

#### 任务 3.1: Prompt 模板开发 (已完成)
- [x] 创建 `config/prompts/xiaoye.xml` (目前集成在 json 中)
- [x] 根据 PRD 中的完整示例编写 Prompt
- [x] 实现 `lib/prompt-manager.ts`
  - [x] 动态参数替换（时间、场景、情绪等）

**验证**: 手动调用阿里百炼 API 测试 Prompt 效果

#### 任务 2.2: Agent 注册配置
- [x] 创建 `config/agent-config.json`
  ```json
  {
    "agentId": "xiaoye_v1",
    "name": "小叶",
    "llm": {
      "url": "https://dashscope.aliyuncs.com/compatible-mode/v1",
      "model": "qwen-plus"
    },
    "tts": {
      "vendor": "MiniMax",
      "model": "speech-01-turbo",
      "voice_id": "Congyue"
    }
  }
  ```
- [x] 实现 `/api/agent/register` 接口

**验证**: 成功注册 Agent 并获取 AgentId

---

### 阶段三：前端核心功能开发 (4-5 天)

#### 任务 3.1: 基础组件开发
- [x] 实现 `CallPage.tsx`
  - [x] 参考 `Prototype/index.html` 的布局 and 交互
  - [x] 使用 Tailwind CSS 实现毛玻璃风格
- [x] 实现 `Waveform.tsx` 音浪组件
  - [x] 纵波效果 (10 条，高度不同)
- [x] 实现状态展示与情绪标签解析

**验证**: UI 与 Prototype 一致，响应式布局正常

#### 任务 3.2: RTC 流程实现
- [x] 实现 Token 获取 (`/api/auth/token`) (正式版加密已打通)
- [x] 实现 `useZegoRTC.ts` Hook
  - [x] `init()`: 初始化 Engine
  - [x] `loginRoom()`: 登录房间
  - [x] `startPublish()`: 开始推流
  - [x] `startPlay()`: 播放 AI 流
  - [x] `logout()`: 登出房间

**验证**: 用户能够加入房间并推流

#### 任务 3.3: AI 通话集成
- [x] 实现 `/api/agent/create` 接口
- [x] 前端调用创建 Agent 实例
- [x] 监听 `roomStreamUpdate` 事件
- [x] 自动拉取 AI 流并播放 (已在 Hook 中实现)

**验证**: 用户能听到 AI 的欢迎语

#### 任务 3.4: 字幕功能实现
- [x] 集成 ZEGO 字幕处理类
- [x] 实现 `SubtitleDisplay.tsx` 组件
  - [x] AI 消息左对齐
  - [x] 用户消息右对齐
  - [x] 流式展示 (基于情绪解析)
- [x] 智能滚动优化 (handleScroll)

**验证**: 字幕能够正确显示并持久化

- [x] 接入实时音量回调
- [x] 动态更新音浪高度
- [x] 优化动画性能 (CSS Animation)

**验证**: 音浪跟随音量实时变化

---

### 阶段四：UI/UX 优化与交互完善 (2-3 天)

- [x] 实现手动滚动检测
- [x] 实现自动滚动逻辑
- [x] 添加"滚动到底部"提示

**验证**: 手动滚动后新消息不自动滚动，滚动到底部后恢复

- [x] 实现 Agent 状态展示
- [x] 实现情绪标签展示
- [x] 实现亲密度等级展示 (静态展示已添加)

**验证**: 状态能够正确切换，使用 `recvExperimentalAPI` 监听 `Cmd=6`

- [x] 监听 ZEGO SDK 错误码 (基础错误处理已集成)
- [x] 实现 Toast 提示组件
- [x] 异常场景处理 (麦克风权限等)

**验证**: 各种异常场景都有友好提示

---

### 阶段五：高级功能开发 (3-4 天)

- [x] 实现沉默检测逻辑
- [x] 调用 ZEGO AI Agent API 主动说话接口
- [x] 测试主动问候效果

**验证**: 用户沉默时 AI 会主动问候

- [x] 实现页面关闭检测 (`beforeunload`)
- [x] 实现 1 分钟延迟销毁逻辑
- [ ] 实现断线重连

**验证**: 基础生命周期清理已完成

#### 任务 5.3: Prompt 动态更新 (可选)
- [ ] 实现情感参数更新接口
- [ ] 调用阿里百炼 Responses API
- [ ] 通过 ZEGO API 更新 SystemPrompt

**验证**: 情绪状态能够动态更新

---

### 阶段六：测试与优化 (2-3 天)

#### 任务 6.1: 功能测试
- [ ] 通话流程完整测试
- [ ] 字幕显示测试
- [ ] 异常场景测试
- [ ] 浏览器兼容性测试
  - Chrome
  - Safari
  - Firefox
  - 移动端浏览器

#### 任务 6.2: 性能优化
- [ ] 音频质量优化 (编码参数调整)
- [ ] 网络适配优化 (弱网测试)
- [ ] 页面加载速度优化

#### 任务 6.3: 用户体验优化
- [ ] 操作流程优化
- [ ] 提示文案优化
- [ ] 动画效果调优

#### 任务 6.4: 缺陷修复 (已完成)
- [x] 修复 TTS 括号过滤失效问题 (改为 FilterText 对象数组格式，并在 `create/route.ts` 中补充了 `[]` 和 `【】` 的支持)
- [x] 修复 TTS 情绪标签不生效问题 (Prompt 适配 ZEGO 官方格式 `[[{"emotion":"happy"}]]`，移除了错误的 `voice_setting` 嵌套)
- [x] 微调中文括号支持
- [x] 修复前端情绪显示问题
  - 添加 EMOTION_MAP 将英文情绪值转换为中文显示
  - 使用双标签方案：`[[{"emotion":"happy"}]] (happy)` - TTS标签被ZEGO过滤，显示标签用于前端提取

---

### 阶段七：功能增强与优化 (2026-01-08 完成)

#### 任务 7.1: 对话长度优化 (已完成)
- [x] 添加 LLM 参数控制
  - `MaxTokens: 100` 限制输出长度
  - `PresencePenalty: 0.3` 惩罚重复
  - `FrequencyPenalty: 0.3` 避免啰嗦
- [x] 强化 Prompt 约束
  - 添加回复长度控制（2-3句话，30-50字）
  - 统一约束到 `<output_rules>`
- [x] 重写 Few-Shot 示例为短句风格
  - 从 6 个示例精简到 3 个
  - 每个示例控制在 1-2 句话

**效果**: AI 回复从 5-6 句话缩短到 2-3 句话

#### 任务 7.2: 动态场景功能 (已完成)
- [x] 创建功能配置系统
  - 新建 `config/features.json` 统一管理实验性功能
  - 实现 `FeatureManager` 单例类
  - 支持功能开关和热更新
- [x] 实现动态场景生成
  - 时间段智能推断（早晨/上午/中午/下午/傍晚/晚上/深夜）
  - 星期几识别（工作日/周末）
  - 特殊时段处理（周五晚上）
  - 用户画像集成（加班习惯优化）
- [x] Agent 创建集成
  - 实现 `extractUserProfile()` 提取用户画像
  - 场景动态替换占位符 `{{CURRENT_TIME}}`, `{{LOCATION}}`, `{{INTERACTION_GOAL}}`

**效果**: AI 根据实际时间和用户习惯自动调整场景上下文

#### 任务 7.3: 系统提示词优化 (已完成)
- [x] 精简人设描述（从详细段落 → 核心要点）
- [x] 合并重复约束（移除 `<CRITICAL_CONSTRAINT>`）
- [x] 简化示例对话（6个 → 3个）
- [x] 优化场景描述格式（精简文本）
- [x] 调整时间段边界（17:00 提前到下班时段）
- [x] 同步优化小花提示词

**效果**: 提示词从 110行/4.3KB → 63行/1.8KB（减少 58%）

---

### 阶段八：交互体验增强 (规划中)

#### 任务 8.1: 多样化开场白 ✅
- [x] 实现 `greeting-prompt-generator.ts`
  - 结合动态场景生成欢迎 Prompt
  - 支持不同时间段和场景的开场白模板
- [x] 修改 `/api/agent/talk-first` 接口
  - 在 `welcome` 级别时注入动态场景信息
  - 使用 `SendAgentInstanceLLM` + `AddAnswerToHistory: true`
- [x] 更新场景推断逻辑
  - 6:00-9:59 通勤路上，10:00-18:59 办公室
  - 19:00-20:59 下班放松，21:00+ 夜晚/深夜
- [x] 测试验证
  - 验证不同场景的开场白效果 ✅

**完成日期**: 2026-01-08

**效果**: AI 开场白根据时间和场景自动调整

#### 任务 8.2: 主动话题推荐 ✅
- [x] 配置管理
  - 在 `features.json` 添加 `proactive_topic` 配置
  - 支持 LLM 模式，可配置话题模板
- [x] 扩展 talk-first API
  - 所有沉默级别都注入场景信息
  - 使用 `SendAgentInstanceLLM` + `AddAnswerToHistory: true`
- [x] 清理冗余配置
  - 移除 `xiaoye.json` 中的静态 interaction 配置
- [x] 测试验证
  - 编译通过 ✅

**完成日期**: 2026-01-08

**效果**: AI 根据场景智能推荐话题，减少冷场

#### 任务 8.3: 规则引擎扩展（可选）
- [ ] 设计规则库数据结构
- [ ] 实现规则匹配引擎
- [ ] 补充 10-15 条常见场景规则
- [ ] 支持混合模式（规则优先，LLM 兜底）

**效果**: 降低 LLM 调用成本，提升响应速度

---

### 阶段九：2.0 版本升级 (v2.0 核心)

#### 任务 9.1: 多智能体架构重构 (P0)
- [ ] 实现 `Dispatcher` 调度逻辑 (Prompt + 意图解析)
- [ ] 拆分 `Persona LLM` 与后台任务逻辑
- [ ] 实现 `TaskQueue` 任务队列管理

#### 任务 9.2: 语音游戏引擎 (P0)
- [ ] 实现 `GameManager` 状态机
- [ ] 开发 **海龟汤** 游戏逻辑 (内置题库 + 判定)
- [ ] 开发 **猜谜** 游戏逻辑
- [ ] 优化游戏模式下的 TTS/ASR (热词增强)
- [ ] 前端游戏状态 UI 组件 (`GameCard.tsx`)

#### 任务 9.3: 新闻摘要与能力引导 (P1)
- [ ] 对接阿里百炼联网搜索 API
- [ ] 实现新闻渐进式播报策略
- [ ] 优化开场白与主动引导逻辑 (结合沉默检测)

---

## 3. 里程碑

| 里程碑 | 完成标志 | 预计时间 |
|--------|---------|----------|
| M1: 基础框架搭建 | 后端项目运行，SDK 集成完成 | Day 4 |
| M2: Agent 注册成功 | 能够注册 Agent 并配置 Prompt | Day 7 |
| M3: 基础通话功能 | 用户能够与 AI 进行语音对话 | Day 12 |
| M4: 完整 UI/UX | 所有 UI 功能完成，交互流畅 | Day 15 |
| M5: 高级功能 | 主动说话、生命周期管理完成 | Day 19 |
| M6: v1.0 发布 | 测试通过，性能达标 | Day 21 |
| M7: v2.0 架构升级 | 多智能体分层架构跑通 | Day 25 |
| M8: 游戏引擎接入 | 海龟汤游戏逻辑完成 | Day 28 |
| M9: v2.0 发布 | 新闻整理、完整游戏与能力引导上线 | Day 32 |

---

## 4. 风险管理

### 高风险项

| 风险 | 应对措施 |
|------|---------|
| ZEGO SDK 文档不全或示例缺失 | 联系 ZEGO 技术支持，参考 GitHub 示例代码 |
| LLM 响应质量不达标 | 多轮测试优化 Prompt，必要时切换模型 |
| 音频延迟或卡顿 | 调整编码参数，测试不同网络环境 |

### 中风险项

| 风险 | 应对措施 |
|------|---------|
| 浏览器兼容性问题 | 优先保证 Chrome/Safari，其他浏览器降级处理 |
| Prompt 参数调优耗时 | 预留 2-3 天 Buffer 时间 |

---

## 5. 资源需求

### 开发环境
- **硬件**: Mac (已有)
- **软件**: 
  - Node.js 18+
  - 现代浏览器
  - VSCode / WebStorm

### 外部服务
- **ZEGO**:
  - AppID: 453368898
  - AppSign: a841d047...
  - AI Agent API 访问权限
- **阿里百炼**: 
  - API Key (需申请)
- **MiniMax TTS**: 
  - API Key (需申请)

### 参考资料
- [ZEGO AI Agent Web 文档](https://doc-zh.zego.im/aiagent-web/quick-start)
- [ZEGO AI Agent Server 文档](https://doc-zh.zego.im/aiagent-server/quick-start)
- [ZEGO Express SDK 文档](https://doc-zh.zego.im/real-time-voice-web/quick-start/integrating-sdk)

---

## 6. 交付物

### 代码仓库
```
IdealAICompanion/
├── Doc/
│   ├── PRD.md
│   ├── UX-Design.md
│   ├── 技术方案.md
│   └── 开发计划.md
├── Prototype/          # 原型参考 (仅供 UI/UX 参考)
│   ├── index.html
│   ├── assets/
│   └── ...
└── Source/             # 实际开发代码
    ├── web/            # 前端 React 项目
    │   ├── src/
    │   ├── public/
    │   └── package.json
    └── server/         # 后端 Next.js 项目
        ├── app/api/
        ├── lib/
        ├── config/
        └── .env.local.example
```

### 文档
- [x] PRD.md
- [x] UX-Design.md
- [x] 技术方案.md
- [x] 开发计划.md
- [x] 部署文档.md ✅
- [x] 用户手册.md ✅

---

## 7. 下一步行动

1. **立即执行**:
   - 初始化 Next.js 项目
   - 下载 ZEGO Express SDK (AI Agent 版本)
   - 申请 LLM 和 TTS API Key

2. **本周目标**:
   - 完成阶段一和阶段二
   - 注册 Agent 成功

3. **本月目标**:
   - 完成核心通话功能
   - 完成 UI/UX 优化
   - 完成基础测试

---

## 附录：快速命令参考

### 前端开发服务器
```bash
cd Source/web
npm run dev  # http://localhost:5173
```

### 后端开发
```bash
cd Source/server
npm run dev  # http://localhost:3000
```

### 测试 Agent 注册
```bash
curl -X POST http://localhost:3000/api/agent/register \
  -H "Content-Type: application/json"
```

### 监控日志
```bash
# ZEGO 控制台
https://console.zego.im/
```
