# 部署文档

## 1. 环境要求

| 组件 | 版本要求 |
|------|----------|
| Node.js | 18.0+ |
| npm | 9.0+ |
| 操作系统 | Linux/macOS/Windows |

---

## 2. 项目结构

```
IdealAICompanion/
├── Source/
│   ├── web/      # 前端 (Vite + React 19)
│   └── server/   # 后端 (Next.js 16)
└── Doc/          # 项目文档
```

---

## 3. 后端部署

### 3.1 配置文件

修改 `Source/server/config/env.ts`：

```typescript
export const CONFIG = {
    appId: <你的 ZEGO AppID>,
    appSign: '<你的 ZEGO ServerSecret>',
    agentApiUrl: 'https://aigc-aiagent-api.zegotech.cn'
};
```

修改 `Source/server/config/agents/*.json` 中的 API Key：
- `LLM.ApiKey`: 阿里百炼 API Key
- `TTS.Params.app.api_key`: MiniMax API Key

### 3.2 本地运行

```bash
cd Source/server
npm install
npm run dev
# 访问 http://localhost:3000
```

### 3.3 生产构建

```bash
npm run build
npm run start
```

### 3.4 Vercel 部署

1. 将 `Source/server` 目录推送到 Git 仓库
2. 在 Vercel 导入项目
3. 设置 Root Directory: `Source/server`
4. 部署完成后配置自定义域名

### 3.5 阿里云部署 (可选)

```bash
# 使用 PM2 管理进程
npm install -g pm2
npm run build
pm2 start npm --name "ai-companion-server" -- start
pm2 save
```

---

## 4. 前端部署

### 4.1 配置 API 地址

修改 `Source/web/vite.config.ts`，配置代理或生产 API 地址：

```typescript
export default defineConfig({
  server: {
    proxy: {
      '/api': 'https://your-backend-domain.com'
    }
  }
})
```

### 4.2 本地运行

```bash
cd Source/web
npm install
npm run dev
# 访问 http://localhost:5173
```

### 4.3 生产构建

```bash
npm run build
# 产物在 dist/ 目录
```

### 4.4 Vercel 部署

1. 将 `Source/web` 目录推送到 Git 仓库
2. 在 Vercel 导入项目
3. 设置 Root Directory: `Source/web`
4. 配置 API Rewrites:
   ```json
   {
     "rewrites": [
       { "source": "/api/:path*", "destination": "https://your-backend.vercel.app/api/:path*" }
     ]
   }
   ```

### 4.5 Nginx 部署 (可选)

```nginx
server {
    listen 80;
    server_name your-domain.com;
    root /var/www/ai-companion/dist;

    location / {
        try_files $uri $uri/ /index.html;
    }

    location /api/ {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
    }
}
```

---

## 5. HTTPS 配置

**必须使用 HTTPS**，因为：
- WebRTC 要求安全上下文
- 麦克风权限需要 HTTPS

推荐使用 Let's Encrypt 免费证书：
```bash
sudo certbot --nginx -d your-domain.com
```

---

## 6. 常见问题

### Q: 麦克风无法使用？
A: 确保使用 HTTPS 协议访问。

### Q: ZEGO API 调用失败？
A: 检查 `config/env.ts` 中的 AppID 和 ServerSecret 是否正确。

### Q: 前端无法连接后端？
A: 检查 Vite 代理配置或 Vercel Rewrites 配置。

---

## 7. 监控与日志

### 后端日志
```bash
# Vercel
vercel logs your-project-name

# PM2
pm2 logs ai-companion-server
```

### ZEGO 控制台
访问 [ZEGO 控制台](https://console.zego.im/) 查看实时通话数据。
