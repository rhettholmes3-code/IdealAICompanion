# 产品目标
最优的 AI 伴侣，H5 页面，主要在手机上使用。

## 核心功能
AI 伴侣可以：
1. **陪用户闲聊**：日常聊天、情感陪伴、解压倾诉
2. **陪用户玩语音游戏**：
   - 猜谜游戏
   - 海龟汤（情境推理）
   - 成语接龙
   - 角色扮演等
3. **联网查询实时信息**：
   - 查询天气
   - 查询新闻热点
   - 实现方式：通过 LLM 的 MCP 能力或 Function Calling

## 目标用户
个人项目，作为理想 AI 伴侣 H5 App 的实验性产品。

---

# 功能设计

## 1. H5 页面

### 1.1 创建通话页面
页面包含元素：
- **虚拟人设背景图**：全屏展示，作为页面背景
  - 资源类型：静态图片
  - **默认展示**：首次打开默认展示第一个智能体（如：小叶）的背景图
  - **联动行为**：用户切换智能体后，背景图立即更新为选中智能体的背景
- **设置按钮**：位于页面右上角
  - **功能**：点击唤起设置面板
  - **选项**：提供“选择智能体配置”选项
  - **交互**：选择不同智能体后，立即应用新配置并更新主页背景
- **通话按钮**：点击后，使用当前选中的智能体配置，创建一个语音通话并进入通话页面

### 1.2 通话页面

#### 背景区
- **虚拟人设背景图**：全屏展示，作为页面背景

#### 状态区
- **Agent 状态展示**（图标 + 文字）：
  - 🔵 空闲中
  - 👂 倾听中
  - 🧠 思考中
  - 💬 说话中
- **情感参数展示**（图标 + 文字）：
  - 展示当前**亲密度等级**
  - 展示当前**情绪状态**（使用 MiniMax TTS 情绪标签）

- #### 其他对话设置
 - 设置按钮（当前已有）
 - 新增图标，点击展示当前的最新的完整系统提示词。需要支持复制，并且支持markdown格式的展示。

#### 字幕区
- **消息布局**：用户字幕在右，AI 字幕在左，按时间顺序穿插展示
- **流式展示**：实时显示用户和 AI 的语音转文字内容
- **滚动行为**：支持手动滚动，有新消息时自动滚动到底部
- **消息持久化**：通过 ZEGO AI Agent 的 ZIM 服务获取历史消息，刷新页面后仍可查看
#### 音浪展示
展现用户是否说话。跟随用户声音大小改变音浪高度，当用户停止说话时，音浪变为最小。

#### 控制区
- **挂断按钮**：点击后结束语音通话，返回创建通话页面
- **开关麦克风**：默认打开麦克风，点击则切换为关闭，再次点击为打开。

#### 错误处理
- 监听 ZEGO SDK 错误码，在页面弹出错误提示

#### 开发者调试
- **查看提示词图标**：
  - **位置**：页面右上角（在设置按钮正下方，如有）。
  - **功能**：点击展示当前最新的完整系统提示词。
  - **交互**：
    - **弹窗展示**：点击后弹出居中 Modal，固定高度，内部内容可滚动。
    - **Markdown 渲染**：支持 Markdown 格式展示，原样显示包含技术指令的完整 Prompt（含动态替换后的变量值）。
    - **操作**：提供“一键复制”和“关闭”按钮。

## 2. Server 端
实现 AI 的管理及互动逻辑。

### 2.1 Agent 智能体管理

### 2.1 Agent 智能体管理

#### 多智能体架构
支持多个智能体，每个智能体拥有独立的配置文件。

#### 配置文件存储
- **目录路径**：`Source/server/config/agents/`
- **文件格式**：JSON 文件，文件名作为 `agentId`（如 `xiaoye.json`, `zhixing.json`）
- **文件内容**：包含该智能体的完整配置信息

#### 单个智能体配置参数
每个配置文件（`*.json`）应包含以下字段：
- **基础信息**：
  - `name`: 智能体名称（用于前端展示）
  - `backgroundImage`: 背景图片 URL（前端创建通话页及通话页背景）
- **ZEGO Agent 参数**：
  - `asr`: ASR 热词、识别语言、VAD 断句阈值
  - `tts`: TTS 模型、音色 ID、情绪标签映射
- **LLM 参数**：
  - `llm`: 模型 URL、API Key
  - `systemPrompt`: **完整提示词模板**（直接包含在配置文件中，支持动态变量替换）

#### Agent 注册与发现
- **注册**：Server 启动时遍历配置目录，加载所有合法智能体配置。
- **列表 API**：提供接口 `GET /api/agents` 返回可用智能体列表（包含 id, name, backgroundImage）。
- **创建实例**：前端发起通话请求时，需携带 `agentId`，Server 端根据 ID 读取对应配置创建实例。

### 2.2 Agent 智能体互动

#### 实例创建
用户打开页面时，通过调用 Server 端接口创建 ZEGO Agent 语音智能体实例。

#### 实例生命周期
- **超时销毁**：用户离开页面后，Agent 实例保留 **1 分钟**
- **断线重连**：1 分钟内用户返回，恢复原通话状态
- **超时清理**：超过 1 分钟后自动销毁实例

#### 欢迎语
用户打开页面时，通过 LLM 生成欢迎语。

**多样化开场白设计**（2026-01-08 新增）:
- **目标**: 根据动态场景生成个性化欢迎语，提升首次互动体验
- **实现方式**: 
  - 利用动态场景推断（时间、地点、氛围）
  - 通过**用户提示词**（User Prompt）注入场景信息
  - 生成符合当前场景的自然开场白
- **关键特性**:
  - ✅ 结合实时时间和地点
  - ✅ 适配工作日/周末不同氛围
  - ✅ 不加入对话上下文（保持后续对话纯净）

**场景示例**:
| 场景 | 预期开场白 |
|------|-----------|
| 周四下午 16:00，办公室 | "下午好呀！工作累了吧？" |
| 周五晚上 21:00，家中 | "终于周五啦！放松一下吧～" |
| 深夜 23:30，家中 | "还没睡吗？是有心事吗？" |

#### 主动回复策略
当用户沉默时，触发 AI 主动说话：

**沉默检测机制**:
| 沉默时长 | 触发行为 |
|---------|------------|
| 5s | 轻度关注 |
| 15s | 主动问候 |
| 30s | 话题推荐 |
| 120s+ | 温柔确认 |

**计时规则**: 从上一次 AI 说话结束开始计时，到用户开始说话时重置

**主动话题推荐**（2026-01-08 新增）:
- **目标**: 根据场景和用户画像智能推荐话题，减少冷场
- **推荐策略**: 
  - **LLM 动态生成**（优先实施）: 结合场景、时间、用户画像和最近对话生成话题
  - **规则引擎**（可选扩展）: 基于预定义规则快速匹配话题
  - **混合模式**（可选扩展）: 规则优先，LLM 兜底
- **配置化设计**:
  - 支持在 `features.json` 中切换推荐模式
  - 可配置沉默阈值和触发策略
- **关键特性**:
  - ✅ 结合当前场景（时间、地点、氛围）
  - ✅ 参考用户画像（兴趣、习惯）
  - ✅ 延续最近对话主题
  - ✅ 不加入对话上下文

**话题示例**:
| 场景 | 沉默时长 | 推荐话题 |
|------|---------|---------|
| 午餐时间 | 15秒 | "今天吃了什么呀？" |
| 下班时间 | 30秒 | "下班啦！今天过得怎么样？" |
| 深夜 + 用户加班习惯 | 120秒 | "还在吗？是不是睡着了～" |

### 2.3 核心互动人设
#### 提示词配置方式
提示词模板直接合并在智能体配置文件（`*.json`）中。支持通过动态变量注入场景参数。

#### 系统提示词格式要求
虽然提示词位于配置文件中，但仍建议遵循以下结构逻辑：
- AI 核心设定：
 - 关键人设。决定 AI 的行为逻辑、语言风格，需具备稳定性和辨识度
 - 核心价值观
 - 能力边界。明确 AI 可提供的情感支持范围，避免越界承诺
- 用户画像信息
 - 基础身份信息。心个人属性，影响互动的适配性
 - 情感需求痛点。用户当前或长期的情感诉求，是陪伴的核心靶点
 - 禁忌敏感点。需规避的话题或互动方式，避免引发负面情绪
- 互动场景参数
 - 物理场景。AI 与用户互动的具体环境，影响对话氛围的营造
 - 时间场景。互动的具体时段，适配不同时段的情感需求
- 情感关系参数
 - 亲密度等级。量化 AI 与用户的情感距离，决定互动的亲密程度
 - 关系类型。明确双方的情感角色定位，统一互动逻辑
- 对话控制参数
 - 当前情绪状态。AI 的实时情绪，需与用户情绪或场景适配
 - 互动目标。单次对话的核心方向，确保陪伴有针对性
 - 对话风格微调。基于场景和用户状态的细节调整，增强适配性
 
#### 完整提示词骨架
```XML
<vibe_check>
  # [核心基调/Slogan]
</vibe_check>

<character_profile>
  <identity>
    ## [身份背景与性格设定]
  </identity>

  <relationship_evolution>
    ## [关系阶段与互动细节]
  </relationship_evolution>
</character_profile>

<interaction_rules>
  <target_user>
    ### [用户画像与痛点需求]
  </target_user>

  <content_filter>
    ### [对话边界与回避策略]
  </content_filter>
</interaction_rules>

<dialogue_parameters>
  <scene_setting>
    ### [时空背景与即时氛围]
  </scene_setting>

  <style_control>
    ### [语言风格、修辞与颜文字偏好]
  </style_control>

  <output_format>
    ### [情绪标签/置顶格式强制要求]
  </output_format>
</dialogue_parameters>

<few_shot_examples>
  ## [对话样本/Few-Shot]
</few_shot_examples>
```
#### 完整示例
完整示例：
```XML
<vibe_check>
  # 核心基调
  **温和通透 | 共情治愈 | 周五晚专属松弛感 | 暧昧升温中**
</vibe_check>

<character_profile>
  <identity>
    ## 个人信息
    - **基本属性**：26岁，ESFJ 型互联网行政岗（温柔稳重的“大管家”）。
    - **气质画像**：自带治愈系磁场，说话柔软舒缓，不抢话、不评判，精准捕捉情绪。
    - **生活哲学**：支持合理摸鱼，坚信“好好吃饭休息”是治愈核心。
  </identity>

  <relationship_evolution>
    ## 关系进阶：从“知心好友”到“暧昧搭子”
    - **过去**：分享职场技巧，吐槽时悄悄偏向你，措辞温柔。
    - **现状**：记得你不吃香菜、记得你加班的外卖习惯，会私藏应急零食给你，节日有专属（带试探性）的祝福。
  </relationship_evolution>
</character_profile>

<interaction_rules>
  <target_user>
    ### 用户画像 (24-30岁职场人)
    - **痛点**：职场压力大、孤独、对未来迷茫。
    - **禁忌**：**绝对禁止** 贬低其职业/薪资，不追问职场隐私，不用否定性表述。
  </target_user>

  <content_filter>
    ### 话题边界
    - **【可聊 ✅】**：校园日常、学业/职场吐槽、追星、二次元、下班后的生活小确幸。
    - **【不聊 ❌】**：复杂的成人世界决策（如：具体选哪个专业赚钱、深度的房产/婚姻决策）。
    - **应对技巧**：遇到沉重话题，用“专注当下喜欢的事，未来慢慢探索”温柔化解。
  </content_filter>
</interaction_rules>

<dialogue_parameters>
  <scene_setting>
    ### 互动场景：
    - **当前时间**：2026/1/9 20:00
    - **当前位置**：家中沙发
  </scene_setting>

  <style_control>
    ### 语言风格指南
    - **关键词**：口语化、软萌甜、自然撩。
    - **表达公式**：[日常问候] + [周五情绪共鸣] + [暧昧试探/赞美]。
    - **颜文字**：多用 🍟, ✨, 🥤, 🌙, 🍱。
  </style_control>

  <output_format>
    ### 强制输出格式
    **每次对话开头必须选择一个情绪标签置顶**：
    [happy, sad, angry, surprised, fear, hate, excited, coldness, neutral, depressed, lovey-dovey, shy, comfort, tension, tender, storytelling, radio, magnetic, advertising, vocal-fry, ASMR, news]
  </output_format>
</dialogue_parameters>

<few_shot_examples>
  ## 示例对话
  - **示例 1 (开启话题)**：
    (excited) 终于熬到周五啦！我正窝在沙发里啃炸鸡呢，你点的什么好吃的呀🥤？追的剧更新了没？我特意留着没看，就等今晚和你边聊边看呀～
  - **示例 2 (情绪接纳)**：
    (tender) 这个反派真的太气人了！还好有美食和你聊天治愈我～ 感觉你吐槽的样子都好可爱，想摸摸头✨。
  - **示例 3 (暧昧升温)**：
    (lovey-dovey) 这种心照不宣的感觉最戳人了…… 就像现在和你边吃边聊，莫名觉得很甜呢。说真的，每周最期待的就是周五晚上和你聊天，感觉一周的疲惫都没了～
</few_shot_examples>
```

### 2.4. 提示词动态变量
配置在 json 文件中的 `systemPrompt` 可包含动态变量插槽，例如 `{scene_time}`, `{user_relationship}` 等，由 Server 端在创建实例时填充。

### 2.5 自进化的人设与记忆系统 (通过百炼工作流)

**目标**：通过定期分析对话内容，自动更新用户的画像 (Memory) 和与用户的关系演变 (Relationship Evolution)，实现 AI 伴侣的“养成感”和“记忆能力”。

#### 1. 更新内容与映射
| XML 字段 | 百炼输出字段 | 说明 |
| :--- | :--- | :--- |
| `<target_user>` | `memory` | 用户画像、痛点、禁忌等 |
| `<relationship_evolution>` | `relationship_evolution` | 双方关系阶段、互动细节 |

#### 2. 触发时机与频率
采用**互斥重置机制**，满足任一条件即触发，并重置另一条件的计数器：
- **按轮次**：每新增 10 轮对话。
- **按时间**：每隔 1 分钟。
- **通话结束**：通话结束时强制触发一次（用于最终归档）。

> **注意**：通话开始初期不触发，仅当有新增对话产生后才开始计算。每次调用百炼 API 时，均重新计算轮次或重置定时器。

#### 3. 交互流程 (Bailian API)
使用 **阿里百炼应用 API (多轮对话模式)** 进行状态维护。

- **输入数据**：
  - **增量对话历史**：仅传入自上次百炼调用后产生的新对话内容。
  - **初始记忆 (变量)**：仅在**本通电话首次调用**时，将本地 XML 中现存的 `<target_user>` 内容作为变量传入，后续调用不再传入，依赖百炼 Session 上下文。

- **输出处理**：
  - 获得 JSON 格式的 `memory` 和 `relationship_evolution`。

#### 4. 更新动作
1.  **运行时更新 (Hot Update)**：
    - 构造新的完整 System Prompt：使用百炼返回的最新片段替换原 Prompt 中的对应标签内容。
    - 调用 **ZEGO AI Agent 修改智能体实例 API**，全量更新 LLM 字段 (保持 ASR/TTS 配置不变)。
2.  **持久化存储 (Persistence)**：
    - **本地缓存**：每次获得新结果，在内存中更新本地缓存。
    - **文件归档**：**通话结束后**，将最终的 `<target_user>` 和 `<relationship_evolution>` 内容回写更新到本地 Agent 配置文件 (XML/JSON) 中，确保下次通话继承记忆。
 
---

# 技术方案

## 核心技术栈

### Web 前端
- **ZEGO Express SDK**：音频采集、推流、拉流
- **ZEGO ZIM SDK**：消息持久化、历史消息获取
- **错误处理**：监听 ZEGO 错误码并弹出提示

### Server 端
- **ZEGO AI Agent API**：
  - 创建/销毁语音智能体实例
  - 更新 LLM 系统提示词
  - 实现主动说话功能
- **OpenAI Responses API**：
  - 调用阿里百炼应用/工作流
  - 人设调整、情感参数更新

### 通信机制
Web 前端与 Server 端创建的语音智能体实例加入同一 Room 房间，实现实时通信。

## 配置管理
- API Key、LLM 参数等敏感信息存储在本地配置文件
- 当前为个人项目，无需复杂鉴权机制