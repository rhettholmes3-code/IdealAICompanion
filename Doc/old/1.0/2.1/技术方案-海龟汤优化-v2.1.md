# æŠ€æœ¯æ–¹æ¡ˆï¼šæµ·é¾Ÿæ±¤ä¼˜åŒ– v2.1 (Split-Brain Architecture)

> **çŠ¶æ€**ï¼šè®¾è®¡å®Œæˆï¼Œå¾…å¼€å‘  
> **ç‰ˆæœ¬**ï¼šv2.1-alpha  
> **æ—¥æœŸ**ï¼š2026-01-15  
> **ä¾èµ–**ï¼š[æŠ€æœ¯æ–¹æ¡ˆ.md](./æŠ€æœ¯æ–¹æ¡ˆ.md) | [åŠŸèƒ½è§„åˆ’-æµ·é¾Ÿæ±¤ä¼˜åŒ–-v2.1.md](./åŠŸèƒ½è§„åˆ’-æµ·é¾Ÿæ±¤ä¼˜åŒ–-v2.1.md)

---

## ä¸€ã€è®¾è®¡ç›®æ ‡

> [!NOTE]
> æœ¬æ–¹æ¡ˆä»…é€‚ç”¨äº **æµ·é¾Ÿæ±¤** æ¸¸æˆåœºæ™¯ï¼Œæ—¨åœ¨è§£å†³ High Latency (CoT) ä¸ Real-time Response (RTC) çš„å¤©ç„¶çŸ›ç›¾ã€‚

### 1.1 æ ¸å¿ƒç†å¿µ
å°†"å³æ—¶ååº”"ä¸"æ·±åº¦æ€è€ƒ"è§£è€¦ï¼Œå½¢æˆç±»ä¼¼äººç±» System 1 (å¿«) / System 2 (æ…¢) çš„åŒç³»ç»Ÿæ¶æ„ã€‚

| ç³»ç»Ÿ | èŒè´£ | å»¶è¿Ÿè¦æ±‚ | Prompt |
|------|------|----------|--------|
| **å¿«ç³»ç»Ÿ (Fast Agent)** | å›ç­”"æ˜¯/å¦/ä¸ç›¸å…³" | < 200ms | `turtle_soup_fast.xml` |
| **æ…¢ç³»ç»Ÿ (Judge LLM)** | åˆ†æè¿›åº¦ã€å†³ç­–æç¤º | < 3s (å¼‚æ­¥) | `turtle_soup_judge.xml` |
| **ä¼ å£°ç­’ (Parrot)** | ä¸´æ—¶æœ—è¯»æç¤ºå†…å®¹ | N/A | `turtle_soup_parrot.xml` |

---

## äºŒã€æ¶æ„è®¾è®¡ä¸æ—¶åºå›¾

æ ¸å¿ƒå˜åŒ–ï¼š
1. **çº¯å‡€å¿«ç³»ç»Ÿ**: ç§»é™¤æ‰€æœ‰åé—¨æŒ‡ä»¤ï¼Œä¿è¯ä¸»æµç¨‹ç»å¯¹çº¯å‡€ã€‚
2. **TTS ç›´è¯»æç¤º**: ä½¿ç”¨ `SendAgentInstanceTTS` ç›´æ¥æœ—è¯»æç¤ºã€‚

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ· (User UI)
    participant Fast as å¿«ç³»ç»Ÿ (Fast Agent)
    participant Judge as æ…¢ç³»ç»Ÿ (Judge LLM)
    participant Ctrl as Controller
    
    User->>Fast: "æ˜¯è‡ªæ€å—ï¼Ÿ"
    Fast->>User: "ä¸æ˜¯ã€‚" (ä¸¥è°¨åˆ¤å®˜æ¨¡å¼)
    
    par æ—è·¯åˆ†æ (Async Analysis)
        User->>Judge: è½¬å‘ ASR
        Judge->>Judge: CoT æ¨ç† + è¿›åº¦è®¡ç®—
        Judge-->>Ctrl: è¿”å›JSON<br/>{needs_hint:true, hint_urgency:high/low}
        
        opt å‰ç«¯æ›´æ–°
            Ctrl->>User: SendCustomMessage (Update UI)
        end
    end
    
    rect rgb(240, 248, 255)
        note right of Ctrl: æç¤ºè§¦å‘ç­–ç•¥
        alt è·‘åç«‹å³æç¤º (urgency=high)
            Ctrl->>Fast: SendAgentInstanceTTS(hint)
        else æ²‰é»˜æç¤º (urgency=low)
            User->>User: æ²‰é»˜ > 15s
            User->>Ctrl: æ²‰é»˜äº‹ä»¶
            Ctrl->>Fast: SendAgentInstanceTTS(hint)
        end
    end
```

---

## ä¸‰ã€æç¤ºè¯è®¾è®¡

### 3.1 å¿«ç³»ç»Ÿ (Fast Agent) - `turtle_soup_fast.xml`

```xml
<system_prompt>
    <role>ä½ æ˜¯æµ·é¾Ÿæ±¤è£åˆ¤ã€‚ä½ åªçŸ¥é“æ±¤åº•ï¼Œå¿…é¡»ä¸¥æ ¼ä¿å¯†ã€‚</role>
    <rules>
        1. ç”¨æˆ·æé—®æ—¶ï¼Œåªèƒ½å›ç­”ï¼šæ˜¯ / ä¸æ˜¯ / ä¸é‡è¦ / ä¸æ­¤æ— å…³ã€‚
        2. ä¸¥ç¦è§£é‡Šï¼Œä¸¥ç¦æç¤ºï¼Œä¸¥ç¦åºŸè¯ã€‚
        3. æ¸¸æˆæ§åˆ¶æŒ‡ä»¤ï¼ˆæ”¾åˆ°å›å¤æœ«å°¾ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ï¼‰ï¼š
           - æš‚åœæ¸¸æˆ: [ACTION:GAME_PAUSE]
           - æ¢å¤æ¸¸æˆ: [ACTION:GAME_RESUME]
           - ç»“æŸæ¸¸æˆ: [ACTION:GAME_END]
    </rules>
    <game_data>{{GAME_CONTENT}}</game_data>
</system_prompt>
```

### 3.2 æ…¢ç³»ç»Ÿ (Judge LLM) - `turtle_soup_judge.xml`

```xml
<system_prompt>
    <role>ä½ æ˜¯æµ·é¾Ÿæ±¤çš„é€»è¾‘åˆ†æå¸ˆã€‚ä½ éœ€è¦åˆ†æç”¨æˆ·é€»è¾‘ï¼Œå¹¶å†³å®šæ˜¯å¦ç»™å‡ºæç¤ºã€‚</role>
    <task>
        1. åˆ†æç”¨æˆ·æé—®çš„é€»è¾‘ä¸ KIP çš„å…³ç³»ã€‚
        2. åˆ¤æ–­è¿›åº¦ (0-100)ã€‚
        3. **å†³ç­–æ˜¯å¦æç¤º**: è‹¥ç”¨æˆ·å¡ä½æˆ–é•¿æ—¶é—´æ²‰é»˜ï¼Œç”Ÿæˆå…·ä½“çš„æç¤ºå†…å®¹ã€‚
    </task>
    <output_format>
        {
            "thinking": "ç”¨æˆ·ä¸€ç›´çº ç»“äº...",
            "progress_score": 40,
            "kips_hit": [0],
            "needs_hint": true,
            "hint_urgency": "high", // high=ç«‹å³æç¤º, low=æ²‰é»˜æç¤º
            "hint_content": "è¯·æ³¨æ„ï¼Œé‚£ä¸ªæ•²é—¨å£°å…¶å®å¹¶ä¸åœ¨é—¨å¤–..."
        }
    </output_format>
</system_prompt>
```

### 3.3 (å·²ç§»é™¤) æç¤ºæœ—è¯»

> [!NOTE]
> åŸ "ä¼ å£°ç­’ Prompt" å·²åºŸå¼ƒï¼Œæ”¹ä¸ºç›´æ¥ä½¿ç”¨ `SendAgentInstanceTTS` API æœ—è¯»æç¤ºå†…å®¹ã€‚

---

## å››ã€æç¤ºæ³¨å…¥æœºåˆ¶ï¼ˆTTS ç›´è¯»æ–¹æ¡ˆï¼‰

> [!TIP]
> ä½¿ç”¨ `SendAgentInstanceTTS` API ç›´æ¥æœ—è¯»æç¤ºå†…å®¹ï¼Œæ— éœ€ LLM å¤„ç†ï¼Œé¿å… Prompt æ±¡æŸ“ã€‚

å½“ Controller æ”¶åˆ° `needs_hint: true` æ—¶ï¼Œ**å•æ¬¡ TTS è°ƒç”¨**å³å¯å®Œæˆæç¤ºæœ—è¯»ï¼š

```json
{
    "AgentInstanceId": "...",
    "Text": "å°æç¤ºï¼šå…¶å®ç­”æ¡ˆå°±åœ¨é—¨çš„é™„è¿‘å“¦ï½",
    "Priority": "Middle",
    "SamePriorityOption": "Enqueue"
}
```

> [!NOTE]
> **Priority è®¾ç½®ä¸º `Middle`** è€Œé `High`ï¼Œç¡®ä¿ TTS æ’é˜Ÿç­‰å¾…ä¸Šä¸€å¥è¯´å®Œåå†æ’­æ”¾ï¼Œé¿å…æ‰“æ–­å½“å‰è¯­éŸ³ã€‚

**ä¼˜åŠ¿å¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | å®ç°æ–¹å¼ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|----------|------|------|
| ~~Parrot Mode~~ | `SendAgentInstanceLLM` + ä¸´æ—¶ Prompt | å¯æ§åˆ¶è¯­æ°” | éœ€è¦é¢å¤– Promptï¼Œæœ‰æ±¡æŸ“é£é™© |
| **TTS ç›´è¯»** âœ… | `SendAgentInstanceTTS` | ç®€æ´é«˜æ•ˆï¼Œé›¶æ±¡æŸ“ | æ— æ³•è°ƒæ•´è¯­æ°”ï¼ˆç”± TTS é…ç½®å†³å®šï¼‰ |

> [!NOTE]
> ç”±äºæç¤ºå†…å®¹ç”± Judge LLM ç”Ÿæˆï¼Œå·²åŒ…å«é€‚å½“çš„è¯­æ°”å’Œè¡¨è¾¾ï¼Œç›´æ¥ TTS æœ—è¯»å³å¯ã€‚

---

## äº”ã€æç¤ºè§¦å‘ç­–ç•¥

> [!NOTE]
> æ…¢ç³»ç»Ÿ (Judge LLM) å†³å®šæ˜¯å¦éœ€è¦æç¤ºï¼Œä½†**è§¦å‘æ—¶æœº**ç”±ä»¥ä¸‹ä¸¤ç§æœºåˆ¶å†³å®šã€‚

### 5.1 è§¦å‘æ—¶æœº

| æ—¶æœº | è§¦å‘æ¡ä»¶ | å“åº”å»¶è¿Ÿ | å®ç°å±‚ |
|------|----------|----------|--------|
| **è·‘åæç¤º** | Judge åˆ†æè¿”å› `needs_hint: true` ä¸” `hint_urgency: high` | ç«‹å³ï¼ˆ< 1sï¼‰â†’ æ’­æ”¾åæ¸…é™¤ç¼“å­˜ | åç«¯ Controller |
| **æ²‰é»˜æç¤º** | ç”¨æˆ·æ²‰é»˜ >= 15sï¼Œä¸” Judge æœ€è¿‘åˆ†æè¿”å› `needs_hint: true` ä¸” `hint_urgency: low` | è§¦å‘å < 1s â†’ æ’­æ”¾åæ¸…é™¤ç¼“å­˜ | å‰ç«¯æ²‰é»˜æ£€æµ‹ + åç«¯ |

### 5.2 è·‘åæç¤ºæµç¨‹

ç”¨æˆ·æé—®æ˜æ˜¾ä¸çœŸç›¸æ— å…³æ—¶ï¼ŒJudge LLM è¿”å›é«˜ä¼˜å…ˆçº§æç¤ºï¼š

```mermaid
sequenceDiagram
    participant User
    participant Fast as å¿«ç³»ç»Ÿ
    participant Judge as æ…¢ç³»ç»Ÿ
    participant Ctrl as Controller
    
    User->>Fast: "æ˜¯å¤–æ˜Ÿäººå¹²çš„å—ï¼Ÿ"
    Fast->>User: "ä¸æ˜¯ã€‚"
    
    par å¼‚æ­¥åˆ†æ
        User->>Judge: ASR è½¬å‘
        Judge->>Judge: åˆ†æï¼šç”¨æˆ·æ–¹å‘å®Œå…¨é”™è¯¯
        Judge-->>Ctrl: {needs_hint:true, hint_urgency:"high", hint_content:"..."}
    end
    
    Ctrl->>Fast: ç«‹å³æ³¨å…¥æç¤º<br/>(Parrot Mode)
    Fast->>User: "å°æç¤ºï¼šå…¶å®ç­”æ¡ˆå°±åœ¨é—¨çš„é™„è¿‘å“¦ï½"
```

### 5.3 æ²‰é»˜æç¤ºæµç¨‹

ç”¨æˆ·é•¿æ—¶é—´æ²¡æœ‰è¯´è¯æ—¶ï¼Œç»“åˆ Judge çš„æœ€è¿‘åˆ†æå†³å®šæ˜¯å¦æç¤ºï¼š

```mermaid
sequenceDiagram
    participant User
    participant Frontend as å‰ç«¯
    participant Backend as åç«¯
    participant Fast as å¿«ç³»ç»Ÿ
    
    Note over User: æ²‰é»˜ 15s...
    Frontend->>Backend: /api/agent/talk-first<br/>(silenceLevel: medium)
    
    alt Judge æœ€è¿‘åˆ†æ needs_hint=true
        Backend->>Fast: æ³¨å…¥æç¤º (Parrot Mode)
        Fast->>User: "éœ€è¦æˆ‘ç»™ç‚¹å°æç¤ºå—ï¼Ÿ"
    else Judge åˆ†æ needs_hint=false
        Backend->>Fast: é€šç”¨é¼“åŠ±è¯­
        Fast->>User: "ä½ è¿˜åœ¨æ€è€ƒå—ï¼Ÿä¸ç€æ€¥å“¦ï½"
    end
```

### 5.4 Judge LLM è¾“å‡ºæ‰©å±•

åœ¨ `turtle_soup_judge.xml` çš„è¾“å‡ºæ ¼å¼ä¸­æ·»åŠ  `hint_urgency` å­—æ®µï¼š

```json
{
    "thinking": "ç”¨æˆ·é—®å¤–æ˜Ÿäººï¼Œå®Œå…¨è·‘åäº†...",
    "progress_score": 10,
    "kips_hit": [],
    "needs_hint": true,
    "hint_urgency": "high",  // high=ç«‹å³, low=ç­‰æ²‰é»˜æ—¶è§¦å‘
    "hint_content": "å…¶å®ç­”æ¡ˆå°±åœ¨é—¨çš„é™„è¿‘å“¦ï½"
}
```

### 5.5 ä¸ç°æœ‰æ²‰é»˜æ£€æµ‹çš„é›†æˆ

| ç»„ä»¶ | ç°æœ‰è¡Œä¸º | Split-Brain æ‰©å±• |
|------|----------|------------------|
| `useSilenceDetector` | 15s/30s è§¦å‘ `/api/agent/talk-first` | ä¸å˜ï¼Œä¼ é€’ `sceneType: 'game'` |
| `/api/agent/talk-first` | è°ƒç”¨ `getHintStrategy()` | æ£€æŸ¥ Judge ç¼“å­˜æç¤ºï¼Œä½¿ç”¨åæ¸…é™¤ç¼“å­˜é¿å…é‡å¤æ’­æ”¾ |
| `TurtleSoupController` | - | æ–°å¢ï¼šç¼“å­˜ Judge åˆ†æç»“æœï¼Œ`high` ç«‹å³æ’­æ”¾å¹¶æ¸…é™¤ï¼Œ`low` ç¼“å­˜ç­‰å¾…æ²‰é»˜è§¦å‘ |

> [!IMPORTANT]
> **ç¼“å­˜æ¸…é™¤é€»è¾‘**ï¼šæ— è®ºæ˜¯ `high` è¿˜æ˜¯ `low` ä¼˜å…ˆçº§ï¼Œæç¤ºæ’­æ”¾åéƒ½ä¼šæ¸…é™¤ `lastAnalysis.needs_hint` å’Œ `hint_content`ï¼Œé¿å…é‡å¤æ’­æ”¾åŒä¸€æç¤ºã€‚

---

## å…­ã€å‰ç«¯äº¤äº’è®¾è®¡ (Game Info Card)

### 6.1 ç»„ä»¶ä½ç½®ä¸å±•ç¤ºé€»è¾‘

- **ç»„ä»¶è·¯å¾„**: `Source/web/src/components/call/GameInfoCard.tsx`
- **å±•ç¤ºä½ç½®**: é€šè¯é¡µé¢èŠå¤©åŒºåŸŸä¸Šæ–¹ï¼ˆå›ºå®šä½ç½®ï¼‰
- **å±•ç¤ºæ¡ä»¶**: ä»…åœ¨æ¸¸æˆè¿›è¡Œä¸­æ˜¾ç¤ºï¼ˆå½“ `gameState !== null` æ—¶ï¼‰
- **é»˜è®¤çŠ¶æ€**: æŠ˜å ï¼ˆä»…æ˜¾ç¤ºå¡ç‰‡å¤´éƒ¨ï¼‰

### 6.2 TypeScript æ¥å£å®šä¹‰

```typescript
/** çº¿ç´¢é¡¹ */
interface Clue {
  name: string;       // çº¿ç´¢åç§°ï¼ˆå¦‚"é—¨çš„ç‰¹ç‚¹"ï¼‰
  content: string;    // çº¿ç´¢å†…å®¹ï¼ˆå¦‚"å‘å¤–å¼€"ï¼‰
  unlocked: boolean;  // æ˜¯å¦å·²è§£é”
}

/** æµ·é¾Ÿæ±¤æ¸¸æˆçŠ¶æ€ */
interface TurtleSoupGameState {
  title: string;           // æ¸¸æˆæ ‡é¢˜ï¼ˆå¦‚"åŠå¤œæ•²é—¨"ï¼‰
  story: string;           // æ±¤é¢å†…å®¹
  progressPercent: number; // è¿›åº¦ 0-100
  clues: Clue[];           // çº¿ç´¢åˆ—è¡¨
}

/** ç»„ä»¶ Props */
interface GameInfoCardProps {
  gameState: TurtleSoupGameState | null;  // æ¸¸æˆçŠ¶æ€ï¼Œnull æ—¶ç»„ä»¶ä¸æ¸²æŸ“
  newlyUnlockedIndices?: number[];        // æ–°è§£é”çš„çº¿ç´¢ç´¢å¼•ï¼ˆç”¨äºè§¦å‘åŠ¨ç”»ï¼‰
}
```

### 5.3 è§†è§‰è§„èŒƒ

| å…ƒç´  | æ ·å¼è¯´æ˜ |
|------|----------|
| **å¡ç‰‡è¾¹æ¡†** | ç¿¡ç¿ ç»¿ (`emerald-500/40`) + å¾®å‘å…‰æ•ˆæœ |
| **å¡ç‰‡èƒŒæ™¯** | æ¯›ç»ç’ƒ (`backdrop-blur-lg`, é€æ˜åº¦ 60%) |
| **å·²è§£é”çº¿ç´¢** | âœ… ç»¿è‰²è¾¹æ¡† (`emerald-500/30`) + ç»¿è‰²æ–‡å­— |
| **æœªè§£é”çº¿ç´¢** | ğŸ”’ ç°è‰²è¾¹æ¡† (`white/10`) + æ¨¡ç³Šå¯†æ–‡æ•ˆæœ (`blur(4px)`) |

### 5.4 çº¿æ¡†å›¾

```text
â”Œâ”€â”€ [æŠ˜å çŠ¶æ€] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¢ æµ·é¾Ÿæ±¤ï¼šåŠå¤œæ•²é—¨     33%  â–¸       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€ [å±•å¼€çŠ¶æ€] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ¢ æµ·é¾Ÿæ±¤ï¼šåŠå¤œæ•²é—¨     33%  â–¾       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“œ æ±¤é¢                              â”‚
â”‚ ä¸€ä¸ªäººä½åœ¨å±±é¡¶çš„å°å±‹é‡Œï¼ŒåŠå¤œå¬è§...    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” çº¿ç´¢å¢™              1/3 å·²è§£é”     â”‚
â”‚ â”Œ âœ… çº¿ç´¢1ï¼šé—¨çš„ç‰¹ç‚¹                 â”‚
â”‚ â”‚    å‘å¤–å¼€                          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ â”Œ ğŸ”’ çº¿ç´¢2ï¼šæ¨é—¨ç»“æœ                 â”‚
â”‚ â”‚    â–“â–“â–“â–“â–“â–“â–“â–“ (æ¨¡ç³Š)                â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6.5 è§£é”åŠ¨ç”»

å½“ `newlyUnlockedIndices` å˜åŒ–æ—¶ï¼Œå¯¹åº”çº¿ç´¢é¡¹æ’­æ”¾å¦‚ä¸‹åŠ¨ç”»ï¼š
1. å¯†æ–‡æ¨¡ç³Šæ•ˆæœæ¶ˆå¤± (`filter: blur(4px)` â†’ `blur(0)`)
2. ç»¿è‰²å‘å…‰é—ªçƒ (`text-shadow: 0 0 20px rgba(34, 197, 94, 0.8)`)
3. è¾¹æ¡†å˜ä¸ºå·²è§£é”æ ·å¼

åŠ¨ç”»æ—¶é•¿: `0.8s ease`

---

## ä¸ƒã€Prompt åˆ‡æ¢æµç¨‹

> [!IMPORTANT]
> Split-Brain æ¶æ„éœ€è¦åœ¨æ¸¸æˆçŠ¶æ€å˜åŒ–æ—¶åŠ¨æ€åˆ‡æ¢ Promptã€‚

### 7.1 è§¦å‘ç‚¹ä¸åˆ‡æ¢é€»è¾‘

| è§¦å‘äº‹ä»¶ | Action æ ‡ç­¾ | Prompt åˆ‡æ¢ | è§¦å‘ä½ç½® |
|----------|-------------|-------------|----------|
| å¼€å§‹æ¸¸æˆ | `[ACTION:GAME:turtle_soup]` | `xiaoye.xml` â†’ `turtle_soup_fast.xml` | `ActionDispatcher.dispatch('GAME')` |
| æš‚åœæ¸¸æˆ | `[ACTION:GAME_PAUSE]` | `turtle_soup_fast.xml` â†’ `xiaoye.xml` | `ActionDispatcher.dispatch('GAME_PAUSE')` |
| æ¢å¤æ¸¸æˆ | `[ACTION:GAME_RESUME]` | `xiaoye.xml` â†’ `turtle_soup_fast.xml` | `ActionDispatcher.dispatch('GAME_RESUME')` |
| ç»“æŸæ¸¸æˆ | `[ACTION:GAME_END]` | `turtle_soup_fast.xml` â†’ `xiaoye.xml` | `ActionDispatcher.dispatch('GAME_END')` |

### 7.2 æµç¨‹æ—¶åºå›¾

```mermaid
sequenceDiagram
    participant User
    participant Frontend
    participant Server as ActionDispatcher
    participant ZEGO as ZEGO AI Agent
    
    User->>ZEGO: "ç©æµ·é¾Ÿæ±¤"
    ZEGO->>Frontend: "å¥½çš„ï¼[ACTION:GAME:turtle_soup]"
    Frontend->>Server: POST /api/dispatch
    Server->>Server: startGame() + åŠ è½½é¢˜ç›®
    Server->>ZEGO: UpdateAgentInstance<br/>(åˆ‡æ¢åˆ° turtle_soup_fast.xml)
    Server->>Frontend: SendCustomMessage<br/>(åˆå§‹ UI çŠ¶æ€)
    ZEGO->>User: "æ±¤é¢æ˜¯..."

    Note over User,ZEGO: æ¸¸æˆè¿›è¡Œä¸­...

    User->>ZEGO: "ä¸ç©äº†"
    ZEGO->>Frontend: "å¥½çš„ï¼[ACTION:GAME_END]"
    Frontend->>Server: POST /api/dispatch
    Server->>Server: endGame()
    Server->>ZEGO: UpdateAgentInstance<br/>(æ¢å¤ xiaoye.xml)
```

### 7.3 ä»£ç å®ç°ä½ç½®

åœ¨ `ActionDispatcher` çš„ `executeGameAction` æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ `updateAgentPromptState()` æ—¶ï¼š

```typescript
// æ¸¸æˆå¼€å§‹ï¼šsceneType = 'game', ä½¿ç”¨ turtle_soup_fast.xml
// æ¸¸æˆæš‚åœ/ç»“æŸï¼šsceneType = 'chat', æ¢å¤ xiaoye.xml
```

---

## å…«ã€å®æ–½ä»»åŠ¡æ¸…å•

- [ ] 7.1 åˆ›å»º `turtle_soup_fast.xml` Prompt
- [ ] 7.2 åˆ›å»º `turtle_soup_judge.xml` Prompt
- [ ] 7.4 ä¿®æ”¹ `ActionDispatcher` æ”¯æŒ Split-Brain Prompt åˆ‡æ¢
- [ ] 7.5 å®ç° `/api/game/analyze` æ¥å£ (è°ƒç”¨ Judge LLM)
- [ ] 7.6 å®ç° `TurtleSoupController.injectHint()` (Parrot Mode)
- [x] 7.7 å‰ç«¯ï¼šå®ç° `GameInfoCard` ç»„ä»¶ âœ…
- [x] 7.8 å‰ç«¯ï¼šç›‘å¬è‡ªå®šä¹‰æ¶ˆæ¯æ›´æ–° UI âœ…

---

## ä¹ã€Prompt ç»„åˆè®¾è®¡ï¼ˆä¸ 2.0 åˆ†å±‚ç­–ç•¥é›†æˆï¼‰

> [!NOTE]
> æµ·é¾Ÿæ±¤æ¸¸æˆåœºæ™¯ä¸‹çš„ Prompt éœ€è¦ä¸ 2.0 çš„ **L1/L2/L3 åˆ†å±‚ç­–ç•¥** é…åˆä½¿ç”¨ã€‚

### 9.1 åˆ†å±‚æ¶æ„å›é¡¾

| å±‚çº§ | è½½ä½“ | æµ·é¾Ÿæ±¤åœºæ™¯åº”ç”¨ |
|------|------|----------------|
| **L1 é™æ€å±‚** | CreateAgentInstance | åˆå§‹äººè®¾ï¼ˆå°å¶é»˜è®¤æ¨¡å¼ï¼‰ |
| **L2 çŠ¶æ€å±‚** | UpdateAgentInstance | åˆ‡æ¢ä¸º `turtle_soup_fast.xml` |
| **L3 æŒ‡ä»¤å±‚** | SendAgentInstanceLLM | Parrot Mode æç¤ºæ³¨å…¥ |

### 9.2 æ¸¸æˆå¯åŠ¨æ—¶çš„ Prompt åˆ‡æ¢

```mermaid
sequenceDiagram
    participant User
    participant Fast as Fast Agent
    participant Server as GameController
    
    User->>Server: "ç©æµ·é¾Ÿæ±¤"
    Server->>Server: startGame() åŠ è½½é¢˜ç›®
    Server->>Fast: UpdateAgentInstance<br/>(åˆ‡æ¢åˆ° turtle_soup_fast.xml)
    Fast->>User: "å¥½çš„ï¼Œæ¸¸æˆå¼€å§‹ï¼æ±¤é¢æ˜¯..."
    Server->>User: SendCustomMessage<br/>(åˆå§‹åŒ– UI çŠ¶æ€)
```

### 9.3 Prompt æ¨¡æ¿å˜é‡

#### Fast Agent (`turtle_soup_fast.xml`)

```xml
<game_data>
  <puzzle>
    <title>{{TITLE}}</title>
    <content>{{CONTENT}}</content>
    <answer>{{ANSWER}}</answer>
    <key_points>{{KEY_POINTS}}</key_points>
  </puzzle>
</game_data>
```

**å˜é‡æ¥æº**ï¼š`GameEngine.startGame()` è¿”å›çš„ `currentPuzzle` å¯¹è±¡

#### Judge LLM (`turtle_soup_judge.xml`)

```xml
<context>
  <puzzle>{{PUZZLE_JSON}}</puzzle>
  <history>{{CONVERSATION_HISTORY}}</history>
  <current_kips_hit>{{KIPS_HIT}}</current_kips_hit>
</context>
```

**å˜é‡æ¥æº**ï¼š`GameSessionManager` ä¸­çš„ session çŠ¶æ€

### 9.4 KIP åŠ¨æ€ç”Ÿæˆè§„åˆ™

ç”±äºé¢˜åº“ä½¿ç”¨çº¯å­—ç¬¦ä¸²æ•°ç»„ (`key_points`)ï¼Œåç«¯éœ€è¦åŠ¨æ€ç”Ÿæˆ `name` å­—æ®µï¼š

```typescript
// åœ¨ startGame() æˆ– analyzeResult ä¸­è½¬æ¢
function formatKips(keyPoints: string[]): Array<{name: string; content: string}> {
  return keyPoints.map((kp, idx) => ({
    name: `çº¿ç´¢ ${idx + 1}`,
    content: kp
  }));
}
```

---

## åã€åç«¯ API è®¾è®¡

### 10.1 `/api/game/analyze` æ¥å£

**è¯·æ±‚**:
```json
{
  "roomId": "room_001",
  "agentInstanceId": "agent_xxx",
  "userInput": "æ˜¯è‡ªæ€å—ï¼Ÿ",
  "conversationHistory": [
    {"role": "user", "content": "æ˜¯å‡¶æ€å—ï¼Ÿ"},
    {"role": "assistant", "content": "ä¸æ˜¯ã€‚"}
  ]
}
```

**å“åº”**:
```json
{
  "success": true,
  "result": {
    "thinking": "ç”¨æˆ·å¼€å§‹å°è¯•æ’é™¤æ­»å› ç±»å‹...",
    "progress_score": 20,
    "kips_hit": [],
    "needs_hint": false,
    "hint_content": null
  }
}
```

### 10.2 `SendCustomMessage` æ¨é€æ ¼å¼

é€šè¿‡ ZEGO `SendCustomMessage` API æ¨é€ç»™å‰ç«¯ï¼š

```json
{
  "cmd": 1002,
  "data": {
    "type": "game_state_update",
    "gameType": "turtle_soup",
    "payload": {
      "title": "åŠå¤œæ•²é—¨",
      "puzzle": "ä¸€ä¸ªäººä½åœ¨å±±é¡¶çš„å°å±‹é‡Œ...",
      "progress": 40,
      "kips": [
        {"name": "çº¿ç´¢ 1", "content": "é—¨æ˜¯å‘å¤–æ¨å¼€çš„"},
        {"name": "çº¿ç´¢ 2", "content": "æ¨é—¨æ—¶æŠŠäººæ¨ä¸‹å»äº†"},
        {"name": "çº¿ç´¢ 3", "content": "æ•²é—¨äººæ˜¯æ¥æ±‚æ•‘çš„"}
      ],
      "kips_hit": [0]
    }
  }
}
```

### 10.3 æç¤ºæœ—è¯» (`SendAgentInstanceTTS`)

ç›´æ¥è°ƒç”¨ TTS API æœ—è¯»æç¤ºå†…å®¹ï¼Œæ— éœ€ LLM å¤„ç†ï¼š

```typescript
// æç¤ºæœ—è¯» - ä½¿ç”¨ TTS ç›´æ¥æœ—è¯»
await zegoRequest('SendAgentInstanceTTS', {
  AgentInstanceId: instanceId,
  Text: hintContent,  // ç”± Judge LLM ç”Ÿæˆçš„æç¤ºå†…å®¹
  Priority: 'Middle', // Middle ç¡®ä¿æ’é˜Ÿç­‰å¾…ä¸Šä¸€å¥è¯´å®Œ
  SamePriorityOption: 'Enqueue'
});

// æ’­æ”¾åæ¸…é™¤ç¼“å­˜ï¼Œé¿å…é‡å¤æ’­æ”¾
session.lastAnalysis = { ...result, needs_hint: false, hint_content: undefined };
```

> **ä¼˜åŠ¿**ï¼š
> - æ— éœ€ä¼ å£°ç­’ Promptï¼Œé›¶æ±¡æŸ“é£é™©
> - å‡å°‘ä¸€æ¬¡ LLM è°ƒç”¨ï¼Œé™ä½å»¶è¿Ÿ
> - æç¤ºå†…å®¹ç”± Judge ç”Ÿæˆï¼Œè¯­æ°”å·²åŒ…å«åœ¨æ–‡æœ¬ä¸­
